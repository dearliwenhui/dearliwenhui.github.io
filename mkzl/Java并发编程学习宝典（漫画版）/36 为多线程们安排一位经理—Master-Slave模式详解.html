<html><head><meta charset="utf-8"><title>36 为多线程们安排一位经理—Master/Slave模式详解-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        36 为多线程们安排一位经理—Master/Slave模式详解
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-12-24 14:13:05
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img3.mukewang.com/5de861df0001139406400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">没有引发任何行动的思想都不是思想，而是梦想。 <p class="author">—— 马丁</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">前文我们讲过 ForkJoinPool 是分而治之的思想。今天我们将要学习的 Master/Slave 也是同样的思想。其中 Master 负责承接一个大的任务，然后它会根据一定策略把大任务拆散为若干个小任务，然后随机分发给一组 Slave。每个 Slave 完成任务后上报自己的任务完成情况。当所有 Slave 都完成了自己的任务时，Master 也就完成了自己的任务。Master 就像是 Slave 的经理，把自己的任务分发下去，而 Slave 则在完成工作后向它汇报。</p>
</div><div class="cl-preview-section"><h2 id="、masterslave-模式设计" style="font-size: 30px;">1、Master/Slave 模式设计</h2>
</div><div class="cl-preview-section"><h3 id="master-设计">1.1 Master 设计</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 Master/Slave 模式中，一个 Master 持有一组 Slave 的引用。Master 对外暴露一个承接任务的方法 startTask。这是 Master 的主要方法，在内部做了如下事情：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">创建 slave</p>
<p style="font-size: 20px; line-height: 38px;">由于创建 Slave 线程并启动的操作比较重，所以放到提交任务的时候才真正去做；</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">分发任务</p>
<p style="font-size: 20px; line-height: 38px;">把 Task 进行拆分，然后分发给每个 Slave；</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">等待处理结果</p>
<p style="font-size: 20px; line-height: 38px;">轮循检查任务是否全部完成，全部完成结束轮循；</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">返回处理结果</p>
<p style="font-size: 20px; line-height: 38px;">返回任务执行结果。</p>
</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到这四个方法逻辑十分的清晰。</p>
</div><div class="cl-preview-section"><h3 id="slave-设计">1.2 Slave 设计</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面我们再看看 Slave 的设计：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Slave 继承自 Thread。内部通过阻塞队列 BlockingQueue 保存 Task。这样在取任务时候如果已经没有，则会阻塞等待。它有一个 submitTask 用来提交子任务，这个方法在 Master 分发任务时会被调用。此外还有 run 方法从 BlockingQueue 中取得任务执行。执行结束后通知 Master。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">以上的设计并不是固定的模式。但 Master 接收任务，分割任务，派发任务这些功能是要有的，此外 Master 要有能力知道所有子任务都被执行完毕。而 Slave 则需要不断承接子任务，并且执行。执行完毕能够把执行结果回写给 Master。设计如下图：<br>
<img class="" src="https://img.mukewang.com/5e01ac580001105815280932.jpg" data-original="//img.mukewang.com/5e01ac580001105815280932.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其实说这么多，不如直接看代码。下面我们就通过一个小例子，来感受一下 Master/Slave 模式。</p>
</div><div class="cl-preview-section"><h2 id="、masterslave-代码示例" style="font-size: 30px;">2、Master/Slave 代码示例</h2>
</div><div class="cl-preview-section"><h3 id="client-代码">2.1 Client 代码</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">不知道你是否还记得本专栏开始几节反复用来举例的单词抄写的需求。本节是正文最后一篇，正好我们回到最初的例子，用 Master/Slave 方式来实现它。我们这次先看 Client 的代码：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token string">"internationalization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Master master <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Master</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        master<span class="token punctuation">.</span><span class="token function">startTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        master<span class="token punctuation">.</span><span class="token function">printResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">特别的简单，创建一个单词抄写的 Task，然后通过 Master 来执行，最后打印执行结果。</p>
</div><div class="cl-preview-section"><h3 id="task代码">2.2 Task 代码</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Task 代码如下，省略了 get 方法 ：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
  <span class="token comment">//要抄写的次数</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> copyCount<span class="token punctuation">;</span>
  <span class="token comment">//抄写的序号开始</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> from<span class="token punctuation">;</span>
  <span class="token comment">//抄写的序号结束</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> to<span class="token punctuation">;</span>
  <span class="token comment">//要抄写的单词</span>
    <span class="token keyword">private</span> String word<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Task</span><span class="token punctuation">(</span><span class="token keyword">int</span> copyCount<span class="token punctuation">,</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">int</span> to<span class="token punctuation">,</span> String word<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>copyCount <span class="token operator">=</span> copyCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> word<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>from <span class="token operator">=</span> from<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>to <span class="token operator">=</span> to<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Task</span><span class="token punctuation">(</span><span class="token keyword">int</span> copyCount<span class="token punctuation">,</span> String word<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>copyCount <span class="token operator">=</span> copyCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> word<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>from <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>to <span class="token operator">=</span> copyCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来我们看看 Master 代码。</p>
</div><div class="cl-preview-section"><h3 id="master-代码">2.3 Master 代码</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们先来看看 Master 有哪些属性：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token comment">//保存干活的Slave线程</span>
<span class="token keyword">private</span> List<span class="token operator">&lt;</span>Slave<span class="token operator">&gt;</span> slaves<span class="token punctuation">;</span>
<span class="token comment">//slave的数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SLAVES_COUNT <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token comment">//子任务拆分的力度</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SUB_TASK_SIZE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token comment">//完成的任务数量。各个Slave线程都会更新此数量，所以使用Atomic变量</span>
<span class="token keyword">private</span> AtomicInteger finishedTaskCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//执行结果，key为线程名字，value为此线程完成的数量</span>
<span class="token keyword">private</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">&gt;</span> results<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到 Master 持有一组 slave 线程，用来为它干活。我们的任务是单词抄写，每个子任务由 SUB_TASK_SIZE 来控制单个小任务的抄写次数。子线程抄写完成后会更新 finishedTaskCount 和 results 做任务完成记录。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Master 对外提供了如下方法：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token comment">//主方法，用于执行任务</span>
<span class="token keyword">public</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">&gt;</span> <span class="token function">startTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span>
<span class="token comment">//子方法完成后向Master提交完成记录</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subTaskFinished</span><span class="token punctuation">(</span>String slaveName<span class="token punctuation">,</span><span class="token keyword">int</span> finishedSubTaskCount<span class="token punctuation">)</span>
<span class="token comment">//打印执行结果</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这三个方法里最重要的就是 startTask，Master 主要的执行逻辑都在里面，代码如下：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">&gt;</span> <span class="token function">startTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>

    <span class="token comment">// 1 创建slave</span>
    <span class="token function">createSlaves</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2 分发任务</span>
    <span class="token function">splitAndAssignTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3 等待结果处理</span>
    <span class="token function">checkTaskFinished</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4 返回处理结果</span>
    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">startTask 内部主要调用三个方法，最后返回执行结果。由于创建线程成本高，所以在构造 Master 时并没有创建 Slave，而是延迟到 startTask 的时候来创建。splitAndAssignTask 做的事情就是把大的 task 按照拆分逻辑拆开，分发给 slave 去执行。checkTaskFinished 会轮循检查 task 的执行情况，当全部完成时，执行下面的 return 语句。这几个方法都很重要，接下来我们一个个看。</p>
</div><div class="cl-preview-section"><h4 id="createslaves-方法" style="font-size: 26px;">2.3.1 createSlaves 方法</h4>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSlaves</span><span class="token punctuation">(</span>Master master<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>slaves<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>SLAVES_COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>count <span class="token operator">-</span><span class="token operator">&gt;</span>
                slaves<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Slave</span><span class="token punctuation">(</span><span class="token string">"slave "</span> <span class="token operator">+</span> count<span class="token punctuation">,</span> master<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        slaves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>slave <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            slave<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个方法比较简单，就是创建 SLAVES_COUNT 个 slave，然后启动起来。</p>
</div><div class="cl-preview-section"><h4 id="splitandassigntask-方法" style="font-size: 26px;">2.3.2 splitAndAssignTask 方法</h4>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">splitAndAssignTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> subTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拆分task</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> SUB_TASK_SIZE <span class="token operator">&lt;=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            end <span class="token operator">=</span> start <span class="token operator">+</span> SUB_TASK_SIZE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        subTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        start <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//分发subTask</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subTasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> slaveIndex <span class="token operator">=</span> i <span class="token operator">%</span> SLAVES_COUNT<span class="token punctuation">;</span>
        slaves<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>slaveIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submitTask</span><span class="token punctuation">(</span>subTasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个方法做了两件事情，一是把 task 拆分为多个 subTask。二是把 subTask 分发给 slave 去执行。subTask 中保存了要 copy 的数量，以及 copy 的 from 序号和 to 序号。当然还有要抄写的单词。</p>
</div><div class="cl-preview-section"><h4 id="checktaskfinished" style="font-size: 26px;">2.3.3 checkTaskFinished</h4>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个方法用来检查 task 是否全部执行完成。</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkTaskFinished</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> finishedTaskCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
     	  TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">方法中使用的轮循的方式来检查 task 的 copy 总数和已完成数量 finishedTaskCount 是否一致，如果一致则说明 task 已经全部完成，那么调用 finished 方法工作做收尾，跳出循环。</p>
</div><div class="cl-preview-section"><h4 id="subtaskfinished" style="font-size: 26px;">2.3.4 subTaskFinished</h4>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Master 除了这几个方法还有一个方法用于子线程提交执行结果。代码如下：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subTaskFinished</span><span class="token punctuation">(</span>String slaveName<span class="token punctuation">,</span><span class="token keyword">int</span> finishedSubTaskCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Integer count <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>slaveName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        results<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>slaveName<span class="token punctuation">,</span>finishedSubTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        results<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>slaveName<span class="token punctuation">,</span>count<span class="token operator">+</span>finishedSubTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    finishedTaskCount<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span>finishedSubTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先把执行结果放入 results，如果已经存在，则进行累计。此外更新 finishedTaskCount。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Master 的主要方法都已经介绍完毕。下面我们来看看 Slave。</p>
</div><div class="cl-preview-section"><h3 id="slave代码">2.4 Slave 代码</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Slave 是一个工作的线程，它继承自 Thread 类，</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Slave</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> 
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们先看看 Slave 的属性：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token comment">//slave的线程名字</span>
<span class="token keyword">private</span> String name<span class="token punctuation">;</span>
<span class="token comment">//持有master引用，因为需要向master提交执行结果</span>
<span class="token keyword">private</span> Master master<span class="token punctuation">;</span>
<span class="token comment">//阻塞队列来保存task</span>
<span class="token keyword">private</span> BlockingQueue<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> tasks<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">slave 中提供两个方法，一个是提交 task 的方法 submitTask，代码如下：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
    tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">代码很简单，只是向阻塞队列中放入 task。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Slave 执行 task 的逻辑在 run 方法中，Slave 继承自 Thread，当他启动后，run 方法就会被调用。代码如下：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Task task <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
                    count <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程%s第%d抄写单词%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> count<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            master<span class="token punctuation">.</span><span class="token function">subTaskFinished</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程%s被打断"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这段代码不断的从阻塞队列中 take 出 task。如果没有 task，就会阻塞在此。然后根据 task 内容进行输出。执行完成后调用 master 的 subTaskFinished 方法把自己的执行结果提交给 master。如果阻塞的时候被打断，则打印出日志。</p>
</div><div class="cl-preview-section"><h2 id="、执行结果分析" style="font-size: 30px;">3、执行结果分析</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 Client 的 main 方法中我们声明了一个 task = new Task (123,“internationalization”)，抄写 internationalization 单词 123 次。运行后输出如下：</p>
</div><div class="cl-preview-section"><pre><code>线程slave 1第5抄写单词internationalization
线程slave 5第21抄写单词internationalization
线程slave 4第17抄写单词internationalization
线程slave 2第9抄写单词internationalization
线程slave 5第22抄写单词internationalization
线程slave 3第13抄写单词internationalization
线程slave 0第1抄写单词internationalization

…………………

线程slave 2第107抄写单词internationalization
线程slave 0第100抄写单词internationalization
线程slave 2第108抄写单词internationalization
任务全部完成！
线程slave 4被打断
线程slave 0被打断
线程slave 6被打断
线程slave 1被打断
线程slave 7被打断
线程slave 3被打断
线程slave 5被打断
线程slave 2被打断
线程slave 0,完成了16次抄写
线程slave 7,完成了12次抄写
线程slave 5,完成了16次抄写
线程slave 6,完成了15次抄写
线程slave 3,完成了16次抄写
线程slave 4,完成了16次抄写
线程slave 1,完成了16次抄写
线程slave 2,完成了16次抄写
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">中间省略了一些输出。可以看到所有任务完成后 slave 线程都被打断。最后结果输出了每个线程抄写的次数，相加总和为 123。我把上面的 slave 打印日志做了统计，也是打印了 123 条。完全符合我们的预期。</p>
</div><div class="cl-preview-section"><h2 id="、总结" style="font-size: 30px;">4、总结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Master/Slave 模式是常用的多线程设计模式。一般用于大任务的拆分和分发。Master 作为门面对外暴露任务执行的接口，内部则是分发给多个 Slave 线程完成。这一切对于调用者来说是透明的。Master/Slave 模式关键点在于任务的分发和结果的汇总。它的实现方式很灵活，本文只是一种方式，也可以通过线程池来实现。子任务的计算结果也可以使用 Future。此外，分布式系统也有 Master/slave 的设计模式，可以借助 ZooKeeper 来实现。在 Akka 中使用 Actor 也能实现 Master/Slave 模式。实际使用中可以根据业务需求来自己实现。我们只需要掌握模式的核心思想，而不用拘泥于某一种具体的实现方式。</p>
</div><div class="cl-preview-section"><h3 id="附完成代码">附完成代码</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Master 代码：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Master</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Slave<span class="token operator">&gt;</span> slaves<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SLAVES_COUNT <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SUB_TASK_SIZE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> AtomicInteger finishedTaskCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">&gt;</span> results<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Master</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        slaves <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">&gt;</span> <span class="token function">startTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>

        <span class="token comment">// 1 创建slave</span>
        <span class="token function">createSlaves</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 分发任务</span>
        <span class="token function">splitAndAssignTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3 等待结果处理</span>
        <span class="token function">checkTaskFinished</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4 返回处理结果</span>
        <span class="token keyword">return</span> results<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createSlaves</span><span class="token punctuation">(</span>Master master<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>SLAVES_COUNT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>count <span class="token operator">-</span><span class="token operator">&gt;</span>
                    slaves<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Slave</span><span class="token punctuation">(</span><span class="token string">"slave "</span> <span class="token operator">+</span> count<span class="token punctuation">,</span> master<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            slaves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>slave <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
                slave<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">splitAndAssignTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> subTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> end <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> SUB_TASK_SIZE <span class="token operator">&lt;=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                end <span class="token operator">=</span> start <span class="token operator">+</span> SUB_TASK_SIZE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            subTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            start <span class="token operator">=</span> end<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subTasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> slaveIndex <span class="token operator">=</span> i <span class="token operator">%</span> SLAVES_COUNT<span class="token punctuation">;</span>
            slaves<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>slaveIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submitTask</span><span class="token punctuation">(</span>subTasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subTaskFinished</span><span class="token punctuation">(</span>String slaveName<span class="token punctuation">,</span> <span class="token keyword">int</span> finishedSubTaskCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Integer count <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>slaveName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            results<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>slaveName<span class="token punctuation">,</span> finishedSubTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            results<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>slaveName<span class="token punctuation">,</span> count <span class="token operator">+</span> finishedSubTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        finishedTaskCount<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span>finishedSubTaskCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkTaskFinished</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> finishedTaskCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          
          TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"任务全部完成！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        slaves<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>slave <span class="token operator">-</span><span class="token operator">&gt;</span> slave<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        slaves<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程%s,完成了%d次抄写"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Slave 代码：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Slave</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>

    <span class="token keyword">private</span> Master master<span class="token punctuation">;</span>

    <span class="token keyword">private</span> BlockingQueue<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> tasks<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Slave</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Master master<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>master <span class="token operator">=</span> master<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitTask</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Task task <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
                        count <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程%s第%d抄写单词%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> count<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>

                master<span class="token punctuation">.</span><span class="token function">subTaskFinished</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"线程%s被打断"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Task 代码：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> copyCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> from<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> to<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String word<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Task</span><span class="token punctuation">(</span><span class="token keyword">int</span> copyCount<span class="token punctuation">,</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">int</span> to<span class="token punctuation">,</span> String word<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>copyCount <span class="token operator">=</span> copyCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> word<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>from <span class="token operator">=</span> from<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>to <span class="token operator">=</span> to<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Task</span><span class="token punctuation">(</span><span class="token keyword">int</span> copyCount<span class="token punctuation">,</span> String word<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>copyCount <span class="token operator">=</span> copyCount<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> word<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>from <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>to <span class="token operator">=</span> copyCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCopyCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> copyCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getWord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> word<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> from<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> to<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Client 代码：</p>
</div><div class="cl-preview-section"><pre class=" language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token string">"internationalization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Master master <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Master</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        master<span class="token punctuation">.</span><span class="token function">startTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        master<span class="token punctuation">.</span><span class="token function">printResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/49/article/968">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            35拆分你的任务—学习使用Fork/Join框架
                                        </p>
                                    </div>
                                </a>
                                                                                                                        <!-- 未买不可试读或者未开放 -->
                                    <a href="javascript:;" class="js-cantIn" data-ifopen="1" data-cantaste="1">
                                                                    <div class="next r clearfix">
                                        <p>
                                            37 结束语
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img4.mukewang.com/5d762b3c000119e505400602.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课Java核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">1910221525494047</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：906691736</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=55RtSbJ" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>