<html><head><meta charset="utf-8"><title>17 Resilience4j 在微服务中的应用-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">

<div class="container clearfix" id="top" style="display: block; width: 1134px;">
    
    <div class="center_con js-center_con l" style="width: 1134px;">
        <div class="article-con">
                            <!-- 买过的阅读 -->
                <div class="map">
                    <a href="/read" target="_blank"><i class="imv2-feather-o"></i></a>
                    <a href="/read/37" target="_blank">Spring Cloud微服务开发实践</a>
                    <a href="" target="_blank">
                        <span>
                            / 6-2 17 Resilience4j 在微服务中的应用
                        </span>
                    </a>
                </div>

            


            <div class="art-title" style="margin-top: 0px;">
                17 Resilience4j 在微服务中的应用
            </div>
            <div class="art-info">
                
                <span>
                    更新时间：2019-06-26 10:11:00
                </span>
            </div>
            <div class="art-top">
                                <img src="https://img.mukewang.com/5d03603f0001893a06400359.jpg" alt="">
                                                <div class="famous-word-box">
                    <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                    <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                    <div class="famous-word">机会不会上门来找人，只有人去找机会。<p class="author">——狄更斯</p></div>
                </div>
                            </div>
            <div class="art-content js-lookimg">
                <div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上篇文章首先和大家大致说了下断路器 Hystrix ，然后详细说了下 Resilience4j 的用法，但是都是 JavaSE 环境下的用法，并没有涉及到在微服务中的使用。Resilience4j 最终我们还是要在微服务中体现它的价值，我们学习它使用它是为了解决微服务中的一些痛点，因此，本文我就来和大家分享下 Resilience4j 在微服务中的具体用法。</p>
</div><div class="cl-preview-section"><h2 id="准备工作" style="font-size: 30px;">准备工作</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先我们需要先搭建一个测试环境，我这里创建一个名为 <code>Resilience4j-SpringBoot</code> 的父工程，然后在父工程中创建一个名为 eureka 的子项目来搭建服务注册中心，然后再创建一个名为 provider 的服务提供者，将服务提供者注册到 eureka 上，然后再在 provider 中提供一个 <code>/hello</code> 接口，内容如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String s <span class="token operator">=</span> <span class="token string">"hello "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" !"</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token operator">+</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;"</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里接口中，我特意设置了一个异常， consumer 在调用这个接口的时候会调用失败，方便我们去测试请求重试等功能。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来再来创建一个 consumer。consumer 在创建的过程中只需要加入两个基本的依赖即可，即 <code>spring-boot-starter-web</code> 和 <code>spring-cloud-starter-netflix-eureka-client</code> ，其它的依赖我们在下面具体的使用过程中来说，创建完成后，也将 consumer 注册到服务注册中心上。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这就是我们的准备工作，由于准备工作比较简单，大家不清楚的可以参考<a href="">服务注册与消费</a>一文，我这里就不再详细介绍。</p>
</div><div class="cl-preview-section"><h2 id="retry" style="font-size: 30px;">Retry</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先要和大家介绍的功能就是重试功能，开发环境一般比较稳定。微服务之间的调用，除非是逻辑错误导致调用失败，一般来说可能很少会遇到网络原因导致的调用失败，但是在生产环境中，网络原因导致的调用失败却是一个不能够忽略的问题，由于网络抖动造成的调用失败，我们一定要进行请求重试。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上文介绍的 Resilience4j 中的功能，在微服务中的使用都有两种不同的用法，一种就是借助 Spring AOP ，直接通过一个注解来实现相关的功能；还有一种就是和上文一样，通过编程的方式来实现，这里分别来和大家介绍。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">不过无论哪一种，我们都是需要首先添加依赖，不同于上篇文章我们根据 Resilience4j 提供的功能挨个加依赖，在微服务中，我们可以直接引用 <code>resilience4j-spring-boot2</code> 依赖，这个依赖中包含了 Resilience4j 中提供的所有功能，也包含了所需要的 Spring AOP 的依赖，如下图：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d00de54000178af05170254.png" alt="图片描述" data-original="http://img.mukewang.com/5d00de54000178af05170254.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">依赖代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-xml"><code class="prism  language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.resilience4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>resilience4j-spring-boot2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.14.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="aop-式">AOP 式</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">依赖添加成功后，接下来在 application.yml 文件中配置 Retry 参数，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-yaml"><code class="prism  language-yaml"><span class="token key atrule">resilience4j.retry</span><span class="token punctuation">:</span>
  <span class="token key atrule">retryAspectOrder</span><span class="token punctuation">:</span> <span class="token number">399</span>
  <span class="token key atrule">backends</span><span class="token punctuation">:</span>
    <span class="token key atrule">retryBackendA</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxRetryAttempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> <span class="token number">600</span>
      <span class="token key atrule">eventConsumerBufferSize</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">enableExponentialBackoff</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">exponentialBackoffMultiplier</span><span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token key atrule">enableRandomizedWait</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">randomizedWaitFactor</span><span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token key atrule">retryExceptionPredicate</span><span class="token punctuation">:</span> com.justdojava.consumer.RecordFailurePredicate
      <span class="token key atrule">retryExceptions</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> java.io.IOException
      <span class="token key atrule">ignoreExceptions</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> com.justdojava.consumer.IgnoredException
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">关于这一段的配置，解释如下：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">retryAspectOrder 表示 Retry 的一个优先级。默认情况下， Retry 的优先级高于 bulkhead 、 Circuit breaker 以及 rateLimiter ，即 Retry 会先于另外三个执行。 Retry、 bulkhead 、 Circuit breaker 以及 rateLimiter 的优先级数值默认分别是 Integer.MAX_VALUE-3、Integer.MAX_VALUE-2、Integer.MAX_VALUE-1 以及 Integer.MAX_VALUE ，即数值越小，优先级越高；</li>
<li style="font-size: 20px; line-height: 38px;">backends 属性中我们可以配置不同的 Retry 策略，给不同的策略分别取一个名字， retryBackendA 就是一个 Retry 策略的名字。在 Java 代码中，我们将直接通过指定 Retry 策略的名字来使用某一种 Retry 方案；</li>
<li style="font-size: 20px; line-height: 38px;">maxRetryAttempts 表示最大重试次数；</li>
<li style="font-size: 20px; line-height: 38px;">waitDuration 表示下一次重试等待时间，最小为100 ms ；</li>
<li style="font-size: 20px; line-height: 38px;">eventConsumerBufferSize 表示重试事件缓冲区大小；</li>
<li style="font-size: 20px; line-height: 38px;">enableExponentialBackoff 表示是否开启指数退避抖动算法，当一次调用失败后，如果在相同的时间间隔内发起重试，有可能发生连续的调用失败，因此可以开启指数退避抖动算法；</li>
<li style="font-size: 20px; line-height: 38px;">exponentialBackoffMultiplier 表示时间间隔乘数；</li>
<li style="font-size: 20px; line-height: 38px;">enableRandomizedWait 表示下次重试的时间间隔是否随机， enableRandomizedWait 和 enableExponentialBackoff 默认为 false ，并且这两个不可以同时开启；</li>
<li style="font-size: 20px; line-height: 38px;">retryExceptionPredicate 类似于我们上文所说的什么样的异常会被认定为请求失败，这里的RecordFailurePredicate是一个自定义的类；</li>
<li style="font-size: 20px; line-height: 38px;">retryExceptions 表示需要重试的异常；</li>
<li style="font-size: 20px; line-height: 38px;">ignoreExceptions 表示忽略的异常。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">RecordFailurePredicate 类的定义如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecordFailurePredicate</span> <span class="token keyword">implements</span> <span class="token class-name">Predicate</span><span class="token operator">&lt;</span>Throwable<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">方便起见，我这里未做判断，直接返回 true 。<br>
还有一个自定义的异常 IgnoredException ，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IgnoredException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">配置完成后，接下来再在项目启动类中配置一个 RestTemplate ，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>ConsumerApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    RestTemplate <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">然后创建一个 HelloService 来进行远程调用，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Retry</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"retryBackendA"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    RestTemplate restTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://provider/hello?name={1}"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">HelloService 本身是一个非常常规的类，RestTemplate 相信大家也是再熟悉不过了，唯一和我们前面学过的不同的地方是这里类上多了一个 @Retry(name = “retryBackendA”) 注解，这个注解表示在当前所有类中开启请求失败重试功能，请求失败重试策略就是 retryBackendA ，当然这个注解也可以加在某一个具体的方法上，表示只有该方法开启请求失败重试功能。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">做完这些之后，我们就可以分别启动 eureka、provider 以及 consumer 了，然后在浏览器中访问 consumer 接口，观察 provider 的日志输出，就可以看到日志一共打印了三次，这里发生了请求失败重试。</p>
</div><div class="cl-preview-section"><h3 id="编程式">编程式</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在框架中，通过这种面向切面编程的方式来引用 Resilience4j 中的 Retry 功能固然很方便。不过， Resilience4j 也支持编程式引用，编程式引用的方式就和我们上篇文章介绍的用法差不多了，举例如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UseHelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    HelloService helloService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/hello2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">hello2</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RetryConfig config <span class="token operator">=</span> RetryConfig<span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maxAttempts</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">waitDuration</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Retry retry <span class="token operator">=</span> Retry<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Try<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> result <span class="token operator">=</span> Try<span class="token punctuation">.</span><span class="token function">ofSupplier</span><span class="token punctuation">(</span>Retry<span class="token punctuation">.</span><span class="token function">decorateSupplier</span><span class="token punctuation">(</span>retry<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> helloService<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过编程式来引用 Resilience4j 中的 Retry 功能，则不再需要 application.properties 中的 Retry 相关配置，也不需要在 HelloService 类上添加 @Retry 注解，所有关于重试的配置都是通过 Java 代码来实现，至于 Java 代码配置中的含义，则和上文介绍的一致，这里不再赘述。</p>
</div><div class="cl-preview-section"><h2 id="circuitbreaker" style="font-size: 30px;">CircuitBreaker</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Resilience4j 中断路器的用法和上文也是基本一致，分为两种，可以通过 AOP 的方式使用，也可以通过编程式使用，我们分别来看。</p>
</div><div class="cl-preview-section"><h3 id="aop-式-1">AOP 式</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">由于在 Retry 中已经添加了 <code>resilience4j-spring-boot2</code> 依赖，这里我就不再重复说添加依赖的事了。在上个案例的基础上，我们继续在 application.yml 文件中添加如下配置：</p>
</div><div class="cl-preview-section"><pre class="  language-yml"><code class="prism  language-yml"><span class="token key atrule">resilience4j.circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">backends</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">ringBufferSizeInClosedState</span><span class="token punctuation">:</span> <span class="token number">5</span>
            <span class="token key atrule">ringBufferSizeInHalfOpenState</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">waitInterval</span><span class="token punctuation">:</span> <span class="token number">5000</span>
            <span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">50</span>
            <span class="token key atrule">eventConsumerBufferSize</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">recordFailurePredicate</span><span class="token punctuation">:</span> com.justdojava.consumer.RecordFailurePredicate
            <span class="token key atrule">recordExceptions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> org.springframework.web.client.HttpServerErrorException
            <span class="token key atrule">ignoreExceptions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> org.springframework.web.client.HttpClientErrorException
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里配置也很好理解，大部分参数和我们上篇文章介绍的一致：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">backendA 是断路器策略的命名，和 Retry 类似，一会也是通过注解来引用这个策略；</li>
<li style="font-size: 20px; line-height: 38px;">ringBufferSizeInClosedState 表示断路器关闭状态下，环形缓冲区的大小；</li>
<li style="font-size: 20px; line-height: 38px;">ringBufferSizeInHalfOpenState 表示断路器处于 HalfOpen 状态下，环形缓冲区的大小；</li>
<li style="font-size: 20px; line-height: 38px;">waitInterval 表示断路器从 open 切换到 half closed 状态时，需要保持的时间；</li>
<li style="font-size: 20px; line-height: 38px;">failureRateThreshold 表示故障率阈值百分比，超过这个阈值，断路器就会打开；</li>
<li style="font-size: 20px; line-height: 38px;">eventConsumerBufferSize 表示事件缓冲区大小；</li>
<li style="font-size: 20px; line-height: 38px;">registerHealthIndicator 表示开启健康检测。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">和 Retry 类似，在 Circuit Breaker 中，我们也可以通过 circuitBreakerAspectOrder 属性来修改 Circuit Breaker 的执行优先级。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">配置完成后，接下来我们来定义一个名为 HelloServiceCircuitBreaker 的类，在这个类中，来定义服务请求方法：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@CircuitBreaker</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"backendA"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServiceCircuitBreaker</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    RestTemplate restTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://provider/hello?name={1}"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里通过 @CircuitBreaker 注解来启用断路器。最后，我们在 UseHelloController 中调用这个方法即可。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但是这种写法有一个问题，就是没法进行服务容错降级，如果希望进行服务容错降级，那么还是需要我们上篇文章提到的通过编程实现断路器功能。</p>
</div><div class="cl-preview-section"><h3 id="编程式-1">编程式</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过编程实现断路器功能，就不再需要 application.yml 中的配置了，也不需要在类上添加 @CircuitBreaker(name = “backendA”) 注解，所有的相关配置都是在 Java 代码中完成，和上篇文章基本一样，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> String <span class="token function">hello2</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CircuitBreakerConfig circuitBreakerConfig <span class="token operator">=</span> CircuitBreakerConfig<span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">failureRateThreshold</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">waitDurationInOpenState</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ringBufferSizeInHalfOpenState</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ringBufferSizeInClosedState</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>resilience4j<span class="token punctuation">.</span>circuitbreaker<span class="token punctuation">.</span>CircuitBreaker circuitBreaker <span class="token operator">=</span> circuitBreakerRegistry<span class="token punctuation">.</span><span class="token function">circuitBreaker</span><span class="token punctuation">(</span><span class="token string">"backendA"</span><span class="token punctuation">,</span> circuitBreakerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Try<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> supplier <span class="token operator">=</span> Try<span class="token punctuation">.</span><span class="token function">ofSupplier</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>resilience4j<span class="token punctuation">.</span>circuitbreaker<span class="token punctuation">.</span>CircuitBreaker
            <span class="token punctuation">.</span><span class="token function">decorateSupplier</span><span class="token punctuation">(</span>circuitBreaker<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://provider/hello?name={1}"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"有异常，访问失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我来和大家捋一捋上面这段代码的思路：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">首先利用 Java 代码创建一个 CircuitBreakerConfig 出来，然后配置一下故障率阈值，等待时间以及环形缓冲区大小等；</li>
<li style="font-size: 20px; line-height: 38px;">根据第一步创建出来的 CircuitBreakerConfig ，再去创建一个 CircuitBreaker 对象；</li>
<li style="font-size: 20px; line-height: 38px;">通过 Try.ofSupplier 方法去发送一个请求，如果请求抛出异常，则在 recover 方法中进行服务降级处理，recover 可以写多个。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">最后，在 UseHelloController 中调用这里的 hello2 方法去访问 provider 中的接口。接口调用失败后， consumer 中自动进行服务降级，最终返回字符串为 <code>有异常，访问失败!</code> 。</p>
</div><div class="cl-preview-section"><h2 id="ratelimiter" style="font-size: 30px;">RateLimiter</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来我们再来说一说限流工具 RateLimiter ，限流工具的用法基本上和前两个差不多，可以通过 AOP 的方式使用，也可以通过编程式来使用，下面分别来介绍。</p>
</div><div class="cl-preview-section"><h3 id="aop-式-2">AOP 式</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过 AOP 的方式来使用限流工具，首先在 application.yml 配置文件中添加 RateLimiter 相关配置，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-yml"><code class="prism  language-yml"><span class="token key atrule">resilience4j.ratelimiter</span><span class="token punctuation">:</span>
    <span class="token key atrule">limiters</span><span class="token punctuation">:</span>
        <span class="token key atrule">backendA</span><span class="token punctuation">:</span>
            <span class="token key atrule">limitForPeriod</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">limitRefreshPeriodInMillis</span><span class="token punctuation">:</span> <span class="token number">5000</span>
            <span class="token key atrule">timeoutInMillis</span><span class="token punctuation">:</span> <span class="token number">5000</span>
            <span class="token key atrule">subscribeForEvents</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">registerHealthIndicator</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">eventConsumerBufferSize</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">关于这段配置，我说如下几点：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">backendA 在这里依然表示配置的名称，在 Java 代码中，我们将通过指定限流工具的名称来使用某一种限流策略；</li>
<li style="font-size: 20px; line-height: 38px;">limitForPeriod 表示请求频次的阈值；</li>
<li style="font-size: 20px; line-height: 38px;">limitRefreshPeriodInMillis 表示频次刷新的周期；</li>
<li style="font-size: 20px; line-height: 38px;">timeoutInMillis 许可期限的等待时间，默认为5秒；</li>
<li style="font-size: 20px; line-height: 38px;">subscribeForEvents 表示开启事件订阅；</li>
<li style="font-size: 20px; line-height: 38px;">registerHealthIndicator 表示开启健康监控；</li>
<li style="font-size: 20px; line-height: 38px;">eventConsumerBufferSize 表示事件缓冲区大小。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">配置完成后，创建一个 HelloServiceRateLimiter 类，内容如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@RateLimiter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"backendA"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServiceRateLimiter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    RestTemplate restTemplate<span class="token punctuation">;</span>
    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://provider/hello?name={1}"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里就是一个很常规的服务调用，然后在 UseHelloController 中调用该方法：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/rl"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rateLimiter</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String hello <span class="token operator">=</span> helloServiceRateLimiter<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了测试出效果，这里使用了一个 for 循环，循环中连续发送五次请求，我们发现服务端打印日志如下：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d00de6c0001add203780109.png" alt="图片描述" data-original="http://img.mukewang.com/5d00de6c0001add203780109.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，限流已经生效。</p>
</div><div class="cl-preview-section"><h3 id="编程式-2">编程式</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当然，这里的效果也可以通过编程来实现。通过编程实现代码和上篇文章介绍的基本一致，同时，这里也不再需要在 application.yml 中添加配置，所有的条件通过 Java 代码来配置即可，如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello2</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RateLimiterConfig config <span class="token operator">=</span> RateLimiterConfig<span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limitRefreshPeriod</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">limitForPeriod</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">timeoutDuration</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RateLimiterRegistry rateLimiterRegistry <span class="token operator">=</span> RateLimiterRegistry<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RateLimiter rateLimiter <span class="token operator">=</span> RateLimiter<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"backendB"</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Supplier<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> supplier <span class="token operator">=</span> RateLimiter<span class="token punctuation">.</span><span class="token function">decorateSupplier</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span>
            restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://provider/hello?name={1}"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Try<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> aTry <span class="token operator">=</span> Try<span class="token punctuation">.</span><span class="token function">ofSupplier</span><span class="token punctuation">(</span>supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aTry<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里的代码和我们前文所讲的基本一致，创建一个 Supplier 对象，然后使用 Try.of 方法执行调用，且调用多次。然后在 UseHelloController 中调用这个方法：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/r2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rateLimiter2</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    helloServiceRateLimiter<span class="token punctuation">.</span><span class="token function">hello2</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">观察 provider 中的日志输出，我们可以看到，限流已经生效了。</p>
</div><div class="cl-preview-section"><div class="summary"><h5 class="centertitle" style="font-size: 20px; line-height: 38px;">小结 </h5></div><!--title:&#23567;&#32467; -->  
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本文主要向大家介绍了 Resilience4j 在微服务中的应用。相对于 Hystrix ，Resilience4j 更加轻便简洁，而且到处充满了 JDK8 的元素，确实非常好用，也是未来处理微服务系统稳定性的一个方向。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本文作者：纯洁的微笑、江南一点雨</p>
</div></div>
            </div>
                            <!-- 买过的阅读 -->
                <div class="art-next-prev clearfix">
                                                                        <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/37/article/446">
                                                    <div class="prev l clearfix">
                                <div class="icon l">
                                    <i class="imv2-arrow3_l"></i>
                                </div>
                                <p>
                                    16 Resilience4j 基本用法详解
                                </p>
                            </div>
                        </a>
                                                                                            <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/37/article/448">
                                                    <div class="next r clearfix">
                                <p>
                                    18 Micrometer 实现微服务监控
                                </p>
                                <div class="icon r">
                                    <i class="imv2-arrow3_r"></i>
                                </div>

                            </div>
                        </a>
                                    </div>
                    </div>
        <div class="comments-con js-comments-con" id="coments_con">
        </div>



    </div>
    
    
    

</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>