<html><head><meta charset="utf-8"><title>36 如何增加安全性-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        36 如何增加安全性
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2020-08-27 10:04:18
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img1.sycdn.imooc.com/5f05971e0001d17b06400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">人的差异在于业余时间。——爱因斯坦<p></p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><h1 id="前言">前言</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">你好，我是彤哥。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上一节，我们一起从扩展性的角度将实战项目的通信协议修改为了 WebSocket，有了 WebSocket，服务端可能很轻松地适配各端各语言，但是，如果我们的应用是暴露在外网的，还缺乏安全性。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，本节，我将从安全性的角度来给实战项目添加上安全的外衣，增加连接和数据的安全性。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好了，让我们开始今天的学习吧。</p>
</div><div class="cl-preview-section"><h1 id="何为安全性？">何为安全性？</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">安全，是一个非常广泛地词，从广义上来讲，对于我们的应用，分为内部安全和外部安全。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">内部安全，即系统本身是不是安全，有没有 OOM 的风险，数据是否加密存储，等等。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">外部安全，即外部系统访问该系统是不是安全，连接是否可靠，是否是非法连接，传输数据是否安全，等等。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节，我们讨论的主题主要是外部安全，对于外部安全，我把它分成三个部分：连接可靠性、连接合法性、数据安全性，我们一起来学习 Netty 是怎么解决这些问题的。</p>
</div><div class="cl-preview-section"><h1 id="连接可靠性">连接可靠性</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">身为互联网人，你肯定听过一个词 ——keepalive，在不同的场合，它可能还会被称为心跳监测、空闲检测等，它的主要目的是为了告诉服务端，我还活着，不要关闭我的连接。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">常用的处理方法是客户端定时的给服务端发送一个心跳包，服务端隔一定时间没收到这个客户端的心跳包，则认为它死了，可以把它关闭了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但是，这样有个缺陷，如果客户端本身一直在和服务端交互，这种定时发送的方式就有点浪费带宽和流量，所以，比较好的方法是，客户端检测一定时间没跟服务端交互了才发送一个心跳包，服务端隔一定时间没收到客户端的请求了才认为它可以关闭了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，在 Netty 中，我们该如何实现呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其实，Netty 天然就支持空闲检测，不过还缺少心跳的部分，正好上一节介绍的 WebSocket 是支持心跳协议的，两者结合起来就达到了 “空闲检测 + 心跳” 的目的。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">在 WebSocket 中，是通过 Ping/Pong 这一对消息来表示心跳的，它们分别是 PingWebSocketFrame 和 PongWebSocketFrame。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好了，让我们先看服务端的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerIdleCheckHandler</span> <span class="token keyword">extends</span> <span class="token class-name">IdleStateHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重写构造方法</span>
    <span class="token keyword">public</span> <span class="token function">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 10秒钟没收到读事件就认为是空闲了</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelIdle</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> IdleStateEvent evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt <span class="token operator">==</span> IdleStateEvent<span class="token punctuation">.</span>FIRST_READER_IDLE_STATE_EVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"idle check close the client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 检测到读空闲则关闭连接</span>
            ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">channelIdle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">是不是非常简单？！只需要继承 IdleStateHandler 即可，重写构造方法指定空闲时间，并在 channelIdle () 方法中处理空闲事件。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">然后，别忘了将其添加到 Pipeline 中，可以把它放在前面：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印日志</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 空闲检测 ********</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加Http协议编解码器、处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 添加WebSocket处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerCompressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerProtocolHandler</span><span class="token punctuation">(</span>WEBSOCKET_PATH<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// websocket编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 二次编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好了，再来客户端的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientIdleCheckHandler</span> <span class="token keyword">extends</span> <span class="token class-name">IdleStateHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">ClientIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">客户端除了要实现空闲检测外，还需要发送 Ping 请求，而 Ping 请求是 WebSocket 的东西，它需要经过 WebSocket 的进一步编解码，所以还需要写一个处理空闲的 Handler，要放在 WebSocket 处理器的后面：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PingPongHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token operator">&lt;</span>PongWebSocketFrame<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> PongWebSocketFrame msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 返回pong响应</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"client received pong response"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> Object evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 检测到是写空闲事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt <span class="token operator">==</span> IdleStateEvent<span class="token punctuation">.</span>FIRST_WRITER_IDLE_STATE_EVENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"idle check, send ping request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 发送ping请求</span>
            ByteBuf buffer <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            PingWebSocketFrame frame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PingWebSocketFrame</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在这个处理器中，检测到空闲了就发一个 Ping 请求给服务端，并处理 Pong 响应。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">然后，把这两个 Handler 分别添加到 Pipeline 中：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 打印日志</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 空闲检测 ********</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpClientCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>WebSocketClientCompressionHandler<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 心跳 ********</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PingPongHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// websocket编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BinaryWebSocketFrameEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 二次编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">细心的同学可能会发现，怎么没看到服务端处理 Ping 请求呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其实，Ping 请求的处理是在 WebSocketServerProtocolHandler 中，它接收到是 Ping 请求，直接返回了一个 Pong 响应：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> WebSocketFrame frame<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token keyword">instanceof</span> <span class="token class-name">PingWebSocketFrame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frame<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PongWebSocketFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">readIfNeeded</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token keyword">instanceof</span> <span class="token class-name">PongWebSocketFrame</span> <span class="token operator">&amp;&amp;</span> dropPongFrames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">readIfNeeded</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">细心的同学会看到，它这里也使用了 retain () 方法，跟我们上一节用的 <code>ReferenceCountUtil.retain(msg);</code> 是一样的。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">到这里，空闲检测 + 心跳 就完成了，分别启动服务端和客户端，查看日志：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token number">19</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">09</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> PingPongHandler<span class="token operator">:</span> idle check<span class="token punctuation">,</span> send ping request
<span class="token number">19</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">09</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> PingPongHandler<span class="token operator">:</span> client received pong response
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">一切正常，不过，试着在牌局中停顿一会，会发现，连接被无情地断开了，这是因为客户端有一个等待用户输入的操作，这个操作是阻塞的，导致客户端的心跳没有发送出去，要解决这个问题其实也很简单，在客户端添加一个业务线程池，专门处理业务逻辑：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 添加业务线程池</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MahjongClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">再次运行程序，一切都正常了，我就不演示了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好了，到这里，空闲检测 + 心跳就介绍完毕了，你 Get 到了吗？</p>
</div><div class="cl-preview-section"><h1 id="连接合法性">连接合法性</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其实，上面介绍的空闲检测 + 心跳的方式，在一定程度上，也包含了连接合法性的要求，你可能已经发现了，PingWebSocketFrame 是可以设置一个参数的，这个参数相当于是密钥，我们可以利用这个参数提高一定的安全性，如果是非法的客户端，它可能都不一定知道要心跳，即使知道要心跳，也不一定知道密钥是多少。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，我们这里说的连接合法性是什么呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">一般是指黑白名单。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">所谓黑名单，是被服务端禁止访问的用户，反之，白名单表示只有在白名单中的用户才可以访问服务端。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">最简单的黑白名单实现方式，就是通过 IP 地址进行判断。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Netty 支持黑白名单吗？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">天然支持。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 Netty 中，定义了两种 IP 策略，一种是 UniqueIpFilter，一种是 RuleBasedIpFilter，前者表示一个 IP 地址只能建立一条连接，后者表示基于 IP 的过滤器，你可以设置一些规则，常用的规则是根据子网判断。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我以 RuleBasedIpFilter 为例添加一个黑名单过滤器：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印日志</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 黑名单过滤器 ******</span>
IpFilterRule ipFilterRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IpSubnetFilterRule</span><span class="token punctuation">(</span><span class="token string">"192.168.175.1"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> IpFilterRuleType<span class="token punctuation">.</span>REJECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RuleBasedIpFilter</span><span class="token punctuation">(</span>ipFilterRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 空闲检测</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...省略其他</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里的 IpSubnetFilterRule 使用的是 CIDR 表示法，即经常看到的 <code>130.39.37.100/24</code> 表示法，有兴趣的同学可以去了解下，当然，你也可以实现 IpFilterRule 接口定义自己的规则。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">此时，重启服务端，启动客户端会被无情的断开连接：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">-</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> CLOSE
<span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">!</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> USER_EVENT<span class="token operator">:</span> io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>ChannelInputShutdownReadComplete<span class="token annotation punctuation">@41034074</span>
<span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">!</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> INACTIVE
<span class="token number">21</span><span class="token operator">:</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">45</span> <span class="token punctuation">[</span>nioEventLoopGroup<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> AbstractInternalLogger<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token operator">:</span> <span class="token number">0x11a6fb5a</span><span class="token punctuation">,</span> L<span class="token operator">:</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">175.1</span><span class="token operator">:</span><span class="token number">54759</span> <span class="token operator">!</span> R<span class="token operator">:</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">/</span><span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span><span class="token operator">:</span><span class="token number">8080</span><span class="token punctuation">]</span> UNREGISTERED
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好了，黑白名单我们就介绍到这里，是不是超级简单，想不想了解源码怎么实现的？自己看去～～</p>
</div><div class="cl-preview-section"><h1 id="数据安全性">数据安全性</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">到目前为止，前后端传输的数据还是明文的，怎么做到加密传输呢？</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">虽然已经使用 Protobuf 序列化成字节数组了，但是仍然视为明文，别人只要拿到这个数据和结构体很容易就分析出来的。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这就不得不提鼎鼎大名的 SSL/TLS 了，有兴趣的同学可以去了解下它加密传输的过程，非常有意思。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，Netty 支持 SSL 吗？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">天然支持，一个 Handler 的事，没有什么是 Handler 不能解决的问题。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好，我们来看 Netty 如何支持 SSL，先看服务端：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MahjongServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String WEBSOCKET_PATH <span class="token operator">=</span> <span class="token string">"/websocket"</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PORT <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"8443"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// ssl，使用自己生成的证书</span>
        SelfSignedCertificate ssc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelfSignedCertificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SslContext sslCtx <span class="token operator">=</span> SslContextBuilder<span class="token punctuation">.</span><span class="token function">forServer</span><span class="token punctuation">(</span>ssc<span class="token punctuation">.</span><span class="token function">certificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssc<span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查看证书生成的位置</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ssc<span class="token punctuation">.</span><span class="token function">certificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...省略其他代码</span>
        
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                <span class="token comment">// ...省略其他代码</span>

                <span class="token comment">// 空闲检测</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ssl，创建一个handler</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用自己生成的证书，并通过 SslContext 生成一个 Handler 添加到 Pipeline 中即可，就是这么简单。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们再来看看客户端的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MahjongClient</span> <span class="token punctuation">{</span>

    <span class="token comment">// 记得修改协议为wss</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> String URL <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"wss://127.0.0.1:8443/websocket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 创建sslContext</span>
        SslContext sslCtx <span class="token operator">=</span> SslContextBuilder<span class="token punctuation">.</span><span class="token function">forClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 工作线程池</span>
        NioEventLoopGroup workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Bootstrap bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>workerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span>NioSocketChannel<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                    <span class="token comment">// ...省略其他代码</span>
                    
                    <span class="token comment">// 空闲检测</span>
                    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientIdleCheckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// ssl，创建handler</span>
                    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">客户端的实现基本上类似，是不是很简单？让我们运行起来看看，报错了，提示找不到证书，这是怎么回事呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那是因为我们的证书是自己生成的，不是从权威机构花钱买的，所以，不受信任，此时，需要把导入证书，客户端才能正常访问服务器，导入命令如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 导入证书</span>
keytool<span class="token punctuation">.</span>exe <span class="token operator">-</span><span class="token keyword">import</span> <span class="token operator">-</span>alias netty<span class="token operator">-</span>core <span class="token operator">-</span>keystore <span class="token string">"D:\Program Files\Java\jdk1.8.0_202\jre\lib\security\cacerts"</span> <span class="token operator">-</span>file <span class="token string">"C:\Users\alan\AppData\Local\Temp\keyutil_example.com_8575751454001666416.crt"</span> <span class="token operator">-</span>storepass changeit

<span class="token comment">// 移除证书</span>
keytool<span class="token punctuation">.</span>exe <span class="token operator">-</span>delete <span class="token operator">-</span>alias netty<span class="token operator">-</span>core <span class="token operator">-</span>keystore <span class="token string">"D:\Program Files\Java\jdk1.8.0_202\jre\lib\security\cacerts"</span> <span class="token operator">-</span>storepass changeit
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">注意，保存的位置是你的 IDEA 使用的 JRE 的位置下面的 <code>lib\security\cacerts</code>，我的 IDEA 一般配置的是 JDK 的目录，那就用 JDK 目录下面的 JRE 下面对应的路径，别弄错了。证书的位置在服务端启动的时候会打印出来路径。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，再次重启客户端，一切正常了，我就不演示了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">到此，我们也通过 SSL 的方式实现了数据安全了。</p>
</div><div class="cl-preview-section"><h1 id="后记">后记</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节，我们从空闲检测（心跳）、黑白名单、SSL 三个方面分别对我们的实战项目做了安全增强，在 Netty 中，使用这些技术都变得非常简单，没有什么是一个 Handler 不能搞定的事，如果真的有，那就用两个，可见，Netty 的扩展性真的是无话可说。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">到这里，Netty 还可以再调优吗？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一节，我们将从参数的角度来对实战项目进行调优，敬请期待。</p>
</div><div class="cl-preview-section"><h1 id="思维导图">思维导图</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img1.sycdn.imooc.com/5f3f31cd0001419614410953.png" data-original="//img1.sycdn.imooc.com/5f3f31cd0001419614410953.png" alt="图片描述"></p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/82/article/2194">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            35 如何支持WebSocket
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/82/article/2196">
                                                                    <div class="next r clearfix">
                                        <p>
                                            37 如何调优参数
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img2.sycdn.imooc.com/5f1a7f610001c9a105340522.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课Java核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">2009241134354460</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：314316732</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=OouwHZGZ" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>