<html><head><meta charset="utf-8"><title>23 Netty的FastThreadLocal到底快在哪里-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        23 Netty的FastThreadLocal到底快在哪里
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2020-08-11 09:46:09
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img3.sycdn.imooc.com/5f0596480001e04206400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">天才就是这样，终身努力，便成天才。——门捷列夫<p></p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><h1 id="前言">前言</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">你好，我是彤哥。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">前面几节，我们一起学习了 Netty 中的内存池和对象池相关的知识，不管是内存池还是对象池，它们底层都有使用一种叫作线程本地缓存的东西，我们知道，在 Java 中有 ThreadLocal 可以存储线程本地变量，但是，在 Netty 中，并没有使用 Java 原生的 ThreadLocal，而是创建了一个新的类 ——FastThreadLocal，从名字上就可以看出，它很快，那么，它究竟是不是真的正如其名，很 Fast 呢？它相比于 Java 原生的 ThreadLocal，除了快还有哪些特性呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">今天，就让我们一起来学习 Netty 中鼎鼎大名的快男 ——FastThreadLocal。</p>
</div><div class="cl-preview-section"><h1 id="问题">问题</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">关于 FastThreadLocal 的学习，我想问你这么几个问题：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">Java 原生的 ThreadLocal 是如何实现的？有什么缺点？</li>
<li style="font-size: 20px; line-height: 38px;">FastThreadLocal 是如何实现的？有什么优点和缺点？</li>
<li style="font-size: 20px; line-height: 38px;">FastThreadLocal 有哪些使用的姿势？</li>
<li style="font-size: 20px; line-height: 38px;">FastThreadLocal 一定比 ThreadLocal 快吗？</li>
<li style="font-size: 20px; line-height: 38px;">FastThreadLocal 除了快还有什么优势？</li>
</ol>
</div><div class="cl-preview-section"><h1 id="threadlocal简介">ThreadLocal 简介</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在正式介绍 FastThreadLocal 之前，让我们先从 Java 原生的 ThreadLocal 开始说起。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 ThreadLocal 体系中，有三个特别重要的类：Thread、ThreadLocal、ThreadLocalMap，其中 ThreadLocalMap 是 ThreadLocal 的内部类。<br>
<img class="" src="https://img1.sycdn.imooc.com/5f31f7db0001d56b10320210.png" data-original="//img1.sycdn.imooc.com/5f31f7db0001d56b10320210.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Thread，线程类，就是我们创建线程的那个类，这里面有一个字段叫作 <code>threadLocals</code>，它的类型是 ThreadLocalMap。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">ThreadLocal，线程本地类，用于存放线程本地变量，每一个 ThreadLocal 中存储的值在每一个线程中都有一个副本，这个副本是保存在 Thread 的 <code>threadLocals</code> 中的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">ThreadLocalMap，它是一种使用线性探测法实现的哈希表，可以理解成就是一个 HashMap，不过这个哈希表的 key 是 ThreadLocal，value 是 ThreadLocal 存储的值，这么来说可能比较难理解，我用个伪代码来表示一下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">ThreadLocalMap<span class="token operator">&lt;</span>ThreadLocal<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ThreadLocal threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>threadLocal<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当然，实际使用肯定是不能这样用的，这里仅用于描述 ThreadLocalMap 的组成结构。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">什么是线性探测法呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用线性探测法的哈希表使用数组存储元素，每次添加元素的时候，如果 hash 到的位置已经有元素了，则向后移动一位检测是否有元素，如果还有元素，继续往后移直到一个没有元素的位置把当前要添加的元素放在那个位置。比如，对于一个容量为 8 的哈希表，我们依次放入 2、10、3、4、11 这么几个元素：<br>
<img class="" src="https://img1.sycdn.imooc.com/5f31f7ea00017ac910300215.png" data-original="//img1.sycdn.imooc.com/5f31f7ea00017ac910300215.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">整个过程是这样的：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">2%8=2，所以放在下标为 2 的位置；</li>
<li style="font-size: 20px; line-height: 38px;">10%8=2，所以放在下标为 2 的位置，但是下标 2 的位置有元素了，往后移一位，到下标为 3 的位置，没有元素，所以 10 放在了下标为 3 的位置；</li>
<li style="font-size: 20px; line-height: 38px;">3%8=3，所以放在下标为 3 的位置，但是下标 3 的位置有元素了，往后移一位，到下标为 4 的位置，没有元素，所以 3 放在了下标为 4 的位置；</li>
<li style="font-size: 20px; line-height: 38px;">4%8=4，所以放在下标为 4 的位置，但是下标 4 的位置有元素了，往后移一位，到下标为 5 的位置，没有元素，所以 4 放在了下标为 5 的位置；</li>
<li style="font-size: 20px; line-height: 38px;">11%8=3，所以放在下标为 3 的位置，但是下标 3 的位置有元素了，往后移一位，到下标为 4 的位置，也有元素了，继续后移，到下标为 5 的位置，依然有元素，继续后移，到下标为 6 的位置，没有元素，所以 11 放在了下标为 6 的位置；</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，使用线性探测法实现的哈希表非常容易出现哈希冲突，且解决冲突的过程时间复杂度非常高，最高可以达到 O (n) 的时间复杂度。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">既然线性探测法性能这么差，为什么 ThreadLocal 还要使用线性探测法呢？我认为原因有两点：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">ThreadLocal 是 JDK1.2 就加入的类，比较早，那时候性能还不是主要的关注点；</li>
<li style="font-size: 20px; line-height: 38px;">线程本地变量并不会存在很多，比如，使用 Spring 的情况下，一个线程也就差不多 30 多个 ThreadLocal 变量，所以，对性能影响并不是特别明显；</li>
</ol>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">关于哈希表的更多内容，可以参考这篇文章<a href="https://mp.weixin.qq.com/s/lS2w-RhK7FEgqG6xfc_L0w">《哈希表》</a>。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外，ThreadLocalMap 中的 Entry 是一个弱引用，它引用的对象就是它的 key 值，即 ThreadLocal 变量，所以，当这个 key 不具有强引用时，下一次垃圾回收时，这个弱引用本身会进入到引用队列中，等待被回收，关于弱引用的相关知识，可以参考《再谈 ByteBuffer》那一章的讲解。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，我们该如何使用 ThreadLocal 呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">让我们来看看 ThreadLocal 的作者怎么说：</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">ThreadLocal instances are typically <em>private static</em> fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID).</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">作者告诉我们，我们应该把 ThreadLocal 作为类的静态私有变量来使用，让我们看一个例子：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalTest</span> <span class="token punctuation">{</span>
    <span class="token comment">// threadLocal1</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ThreadLocal<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> STRING_THREAD_LOCAL <span class="token operator">=</span> ThreadLocal<span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// threadLocal2</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ThreadLocal<span class="token operator">&lt;</span>Long<span class="token operator">&gt;</span> LONG_THREAD_LOCAL <span class="token operator">=</span> ThreadLocal<span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// threadLocal3</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ThreadLocal<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> USER_THREAD_LOCAL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// thread1</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"test001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"001：threadName: "</span> <span class="token operator">+</span> STRING_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"001：threadId: "</span> <span class="token operator">+</span> LONG_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"001："</span> <span class="token operator">+</span> USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"thread-001"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// thread2</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>2L<span class="token punctuation">,</span> <span class="token string">"test002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"002：threadName: "</span> <span class="token operator">+</span> STRING_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"002：threadId: "</span> <span class="token operator">+</span> LONG_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"002："</span> <span class="token operator">+</span> USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"thread-002"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
        Long id<span class="token punctuation">;</span>
        String name<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>Long id<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">"id="</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">", name="</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在这个示例中，我们创建了三个 ThreadLocal，他们的值分别为 String、Long、User，然后在 main () 方法中分别创建了两个 Thread，那么，在这两个 Thread 生命周期结束之前，这三个 ThreadLocal 分别是怎么存储的呢？<br>
<img class="" src="https://img1.sycdn.imooc.com/5f31f7ff00011c4110330529.png" data-original="//img1.sycdn.imooc.com/5f31f7ff00011c4110330529.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在调用 ThreadLocal 的 set ()/setInitialValue () 等方法时，会获取到 Thread 中的 <code>threadLocals</code> 这个 Map，然后调用它的 set () 方法（类似于 HashMap 的 put () 方法）把当前 ThreadLocal 本身作为 key，添加到这个 Map 中，最终的存储结构如上图所示。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，每一个 ThreadLocal 在每一个线程中都保存了一份，而且它们对应的 value 不同。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，在生产中，是否可以使用到 ThreadLocal 呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">答案是当然的，比如一些具有状态的大对象的创建，我们完全可以使用 ThreadLocal 来保存，使得每一个线程都有一个不同的副本，各副本之间的状态不会产生影响，比如经典的就是 SimpleDateFormat、Random 等对象的使用。另外，在诸如 Spring 等 Web 应用场景中，我们也可以使用 ThreadLocal 来保存用户信息，比如，前置拦截器中获取一次用户信息把它保存在 ThreadLocal 中，这样在后面的调用过程中都可以直接拿来使用（无异步调用），在后置拦截器中再把这个用户信息清除即可。此外，还有分布式 ID 的追踪等场景。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">既然，ThreadLocal 这么好用，那么，Netty 为什么还要自己造一个 FastThreadLocal 呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这就要归结于 ThreadLocal 本身的一些缺陷了，它有哪些缺陷呢？我归纳了一下，主要是以下两点：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">存储数据的 ThreadLocalMap 使用的是线性探测法，效率低下；</li>
<li style="font-size: 20px; line-height: 38px;">使用结束未及时 remove () 掉 ThreadLocal 中的值，容易造成内存泄漏，这种情况只能依靠下一次调用 ThreadLocal 的时候来清除无用的数据，可以参考 ThreadLocal 的 set ()/get ()/remove () 中的相关代码；</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，Netty 是如何改造 ThreadLocal 的呢？下面我们就来一起学习 FastThreadLocal 这个非常 Fast 的 ThreadLocal。</p>
</div><div class="cl-preview-section"><h1 id="fastthreadlocal简介">FastThreadLocal 简介</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 Netty 中，为了配合 FastThreadLocal 的使用，还定义了另外两个非常重要的类 ——InternalThreadLocalMap 和 FastThreadLocalThread。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们先来看看 InternalThreadLocalMap 类。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>InternalThreadLocalMap</strong>，它是对原生 ThreadLocalMap 的优化，它不再使用线性探测法实现，而是显式地给每个 ThreadLocal 分配一个 index，使用这个 index 定位 ThreadLocal 在数组中的精确位置，可以让时间复杂度降低到 O (1)，这个性能提升是很明显的，比如，我们同样放入 2、10、3、4、11 这么几个元素：<br>
<img class="" src="https://img1.sycdn.imooc.com/5f31f81a00019f8a10270241.png" data-original="//img1.sycdn.imooc.com/5f31f81a00019f8a10270241.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">整个过程非常简单，每个元素创建的时候都给它分配一个 index，对于 2、10、3、4、11，它们的索引分别是 1、2、3、4、5，这样，它们在放入数组的时候直接按这个 index 作为下标去数组对应的位置即可，也不会出现 hash 冲突，当索引大小达到了数组长度扩容就好了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">不过，这样使用也有个问题，就是当一个元素回收的时候，它的 index 并不会回收，也就是数组对应的位置不能重复利用，但是，这又不是一个问题，因为上面也说过了，ThreadLocal 一般作为类的静态属性来使用，正常情况下，是永远不会被回收的，所以，在 ThreadLocal 的使用场景下，这样的 Map 完全没有问题。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们再来看看 FastThreadLocalThread 类。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>FastThreadLocalThread</strong>，它是对 Thread 的包装，目的是为了配合 FastThreadLocal 的使用。它里面封装了一个 InternalThreadLocalMap 字段，这样的话，以前使用 Thread 的 <code>threadLocals</code> 存储元素就变成了使用这个 InternalThreadLocalMap 来存储元素，以达到上面说的利用 InternalThreadLocalMap 高性能。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外，FastThreadLocalThread 中的构造方法还对任务进行了包装，使得线程任务运行结束的时候可以自动清理掉本线程相关的本地变量。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，讲了这么多，怎么能没有源码呢？</p>
</div><div class="cl-preview-section"><h1 id="fastthreadlocal源码剖析">FastThreadLocal 源码剖析</h1>
</div><div class="cl-preview-section"><h2 id="调试用例" style="font-size: 30px;">调试用例</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">调试用例非常简单，FastThreadLocal 的使用基本上与 ThreadLocal 完全一致，所以，我们只需要拿上面 ThreadLocal 的使用简单修改即可，这也是 Netty 比较厉害的地方：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastThreadLocalTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> FastThreadLocal<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> USER_THREAD_LOCAL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// thread1</span>
        <span class="token keyword">new</span> <span class="token class-name">FastThreadLocalThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"test001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"001："</span> <span class="token operator">+</span> USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"thread-001"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// thread2</span>
        <span class="token keyword">new</span> <span class="token class-name">FastThreadLocalThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>2L<span class="token punctuation">,</span> <span class="token string">"test002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"002："</span> <span class="token operator">+</span> USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"thread-002"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了简单一点，我们这个用例中只保留一个线程本地变量。然后，进入调试模式，在 USER_THREAD_LOCAL 声明的地方打个断点，并跟踪进去：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 创建一个FastThreadLocal</span>
<span class="token keyword">public</span> <span class="token function">FastThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给它一个index</span>
    index <span class="token operator">=</span> InternalThreadLocalMap<span class="token punctuation">.</span><span class="token function">nextVariableIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// InternalThreadLocalMap#nextVariableIndex</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextVariableIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// static final AtomicInteger nextIndex = new AtomicInteger();</span>
    <span class="token comment">// 这个index是从一个AtomicInteger中获取的</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> nextIndex<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextIndex<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"too many thread-local indexed variables"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，在 FastThreadLocal 创建的时候给它分配了一个 index，这个 index 是从一个 AtomicInteger 中获取的，理论上来说，index 的值应该从 0 开始，但是 FastThreadLocal 中有一个常量字段 <code>variablesToRemoveIndex</code>，它会在 FastThreadLocal 加载的时候就从 AtomicInteger 中拿走了第一个值 0，所以，实际上，FastThreadLocal 中的 index 是从 1 开始的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">此时，我们就创建好了一个 FastThreadLocal，让我们再把断点打在创建第一个 FastThreadLocalThread 的地方，并跟踪进去：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token function">FastThreadLocalThread</span><span class="token punctuation">(</span>Runnable target<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 包装任务</span>
    <span class="token comment">// 2. 调用父类Thread的构造方法</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>FastThreadLocalRunnable<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cleanupFastThreadLocals <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，在创建 FastThreadLocalThread 的时候对其任务进行了再包装，那么，这个包装后的任务长啥样呢？让我们看看 FastThreadLocalRunnable 这个类：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FastThreadLocalRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 原始任务</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Runnable runnable<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token function">FastThreadLocalRunnable</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>runnable <span class="token operator">=</span> ObjectUtil<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span> <span class="token string">"runnable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对原始任务的run()方法进行了包装</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// run()结束后清理掉FastThreadLocal</span>
            FastThreadLocal<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 包装方法</span>
    <span class="token keyword">static</span> Runnable <span class="token function">wrap</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> runnable <span class="token keyword">instanceof</span> <span class="token class-name">FastThreadLocalRunnable</span> <span class="token operator">?</span> runnable <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FastThreadLocalRunnable</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里的包装也非常简单，只是对原始任务的 run () 方法进行包装，使其运行完毕后，清理掉 FastThreadLocal，那么，这个清理到底清理了什么呢？我们后面再看。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，包装任务并调用父类 Thread 的构造方法之后，我们的 FastThreadLocalThread 就创建完毕了，此时，执行它的 start () 方法，将进入到线程的 run () 方法中，所以，我们现在在 Thread 的 run () 方法中打一个断点：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// Thread#run</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不为空，是上面传进来的包装后的任务</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// FastThreadLocalRunnable#run</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 运行原始任务</span>
        runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. 清理工作</span>
        FastThreadLocal<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里运行到了 FastThreadLocalRunnable 这个类里面，这里主要干两件事，一是运行原始任务，即我们传进去的 Runnable，二是清理工作。此时，继续跟踪将进入 main () 方法中我们传入的 Runnable 中，即下面这块代码：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">new</span> <span class="token class-name">FastThreadLocalThread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> <span class="token string">"test001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"001："</span> <span class="token operator">+</span> USER_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"thread-001"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在我们的 Runnable 中主要对 USER_THREAD_LOCAL 进行了 set () 和 /get () 方法的调用，我们先跟踪到 set () 方法中：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// FastThreadLocal#set(V)</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>V value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果value不等于UNSET，就把它set进去</span>
    <span class="token comment">// 初始化时InternalThreadLocalMap中的数组的每个元素都会被初始化为UNSET</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> InternalThreadLocalMap<span class="token punctuation">.</span>UNSET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取存储元素的InternalThreadLocalMap</span>
        InternalThreadLocalMap threadLocalMap <span class="token operator">=</span> InternalThreadLocalMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 设置值</span>
        <span class="token function">setKnownNotUnset</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 set () 方法里面，首先，获取到当前线程存储本地变量的 Map，然后，往这个 Map 中设置值。我们先来看看是如何获取到当前线程对应的 Map 的：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> InternalThreadLocalMap <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Thread thread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断当前线程是不是FastThreadLocalThread</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token keyword">instanceof</span> <span class="token class-name">FastThreadLocalThread</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是，使用fastGet</span>
        <span class="token keyword">return</span> <span class="token function">fastGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FastThreadLocalThread<span class="token punctuation">)</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果否，使用slowGet</span>
        <span class="token keyword">return</span> <span class="token function">slowGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// fast</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> InternalThreadLocalMap <span class="token function">fastGet</span><span class="token punctuation">(</span>FastThreadLocalThread thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个Map是存储在FastThreadLocalThread中的，变量名为threadLocalMap</span>
    InternalThreadLocalMap threadLocalMap <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">threadLocalMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadLocalMap <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化Map</span>
        thread<span class="token punctuation">.</span><span class="token function">setThreadLocalMap</span><span class="token punctuation">(</span>threadLocalMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalThreadLocalMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> threadLocalMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// slow</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> InternalThreadLocalMap <span class="token function">slowGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// UnpaddedInternalThreadLocalMap是InternalThreadLocalMap的父类</span>
    <span class="token comment">// 里面存储了一个Java原生的ThreadLocal，它的值是InternalThreadLocalMap</span>
    <span class="token comment">// 这里是把这个Map取出来</span>
    <span class="token comment">// 也就是说，如果当前线程对象不是FastThreadLocalThread</span>
    <span class="token comment">// 就使用Java原生的ThreadLocal来存储一个InternalThreadLocalMap</span>
    <span class="token comment">// 跟Netty相关的本地变量还是存储在InternalThreadLocalMap中</span>
    ThreadLocal<span class="token operator">&lt;</span>InternalThreadLocalMap<span class="token operator">&gt;</span> slowThreadLocalMap <span class="token operator">=</span> UnpaddedInternalThreadLocalMap<span class="token punctuation">.</span>slowThreadLocalMap<span class="token punctuation">;</span>
    InternalThreadLocalMap ret <span class="token operator">=</span> slowThreadLocalMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化Map</span>
        ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalThreadLocalMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        slowThreadLocalMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">获取存储本地线程变量的 Map 分为两种情况：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">如果当前线程是 FastThreadLocalThread，则直接取 FastThreadLocalThread 的 threadLocalMap 属性即可；</li>
<li style="font-size: 20px; line-height: 38px;">如果当前线程不是 FastThreadLocalThread，则在 UnpaddedInternalThreadLocalMap 中保存一个 ThreadLocal，在这个 ThreadLocal 里面保存了一个线程本地变量 InternalThreadLocalMap，再把 Netty 相关的线程本地变量放到这个 Map 中，这里的逻辑有点绕，请仔细体会。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，此时，我们拿到了这个 Map，再看看是怎么把值设置进去的呢？</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// FastThreadLocal#setKnownNotUnset</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setKnownNotUnset</span><span class="token punctuation">(</span>InternalThreadLocalMap threadLocalMap<span class="token punctuation">,</span> V value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取当前FastThreadLocal的索引index</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">.</span><span class="token function">setIndexedVariable</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// key，将当前FastThreadLocal添加到待清理的Set中</span>
        <span class="token function">addToVariablesToRemove</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// InternalThreadLocalMap#setIndexedVariable</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setIndexedVariable</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储元素的数组</span>
    Object<span class="token punctuation">[</span><span class="token punctuation">]</span> lookup <span class="token operator">=</span> indexedVariables<span class="token punctuation">;</span>
    <span class="token comment">// 容量还够</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> lookup<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接找到数组的位置把值设置进去，时间复杂度为O(1)</span>
        Object oldValue <span class="token operator">=</span> lookup<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        lookup<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">return</span> oldValue <span class="token operator">==</span> UNSET<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 容量不够，先扩容再设置值</span>
        <span class="token function">expandIndexedVariableTableAndSet</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">expandIndexedVariableTableAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 旧数组</span>
    Object<span class="token punctuation">[</span><span class="token punctuation">]</span> oldArray <span class="token operator">=</span> indexedVariables<span class="token punctuation">;</span>
    <span class="token comment">// 旧容量</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> oldArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    
    <span class="token comment">// 找到大于index的最小的2次方</span>
    <span class="token comment">// 比如，index=3，则为4</span>
    <span class="token comment">// index=16，则为32</span>
    <span class="token comment">// 因为数组下标是从0开始的，16个元素的数组最大的下标为15，所以16需要32个元素的数组</span>
    <span class="token comment">// 如何实现取大于等于自己的最小2次方呢？只需要把这里改成 index-1 即可</span>
    <span class="token comment">// 有兴趣的同学可以看看HashMap的tableSizeFor()方法</span>
    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> index<span class="token punctuation">;</span>
    newCapacity <span class="token operator">|=</span> newCapacity <span class="token operator">&gt;&gt;&gt;</span>  <span class="token number">1</span><span class="token punctuation">;</span>
    newCapacity <span class="token operator">|=</span> newCapacity <span class="token operator">&gt;&gt;&gt;</span>  <span class="token number">2</span><span class="token punctuation">;</span>
    newCapacity <span class="token operator">|=</span> newCapacity <span class="token operator">&gt;&gt;&gt;</span>  <span class="token number">4</span><span class="token punctuation">;</span>
    newCapacity <span class="token operator">|=</span> newCapacity <span class="token operator">&gt;&gt;&gt;</span>  <span class="token number">8</span><span class="token punctuation">;</span>
    newCapacity <span class="token operator">|=</span> newCapacity <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
    newCapacity <span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建新数组，并把旧数组的元素全部拷贝过来</span>
    Object<span class="token punctuation">[</span><span class="token punctuation">]</span> newArray <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>oldArray<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 把新数组不包含旧数组的后面部分都初始化为UNSET</span>
    Arrays<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>newArray<span class="token punctuation">,</span> oldCapacity<span class="token punctuation">,</span> newArray<span class="token punctuation">.</span>length<span class="token punctuation">,</span> UNSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置当前的值</span>
    newArray<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// 把新数组赋值给InternalThreadLocalMap存储元素的数组</span>
    indexedVariables <span class="token operator">=</span> newArray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">设置值这里也分成两种情况：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">容量足够，直接把数组对应下标位置的值设置成新值即可，时间复杂度为 O (1)；</li>
<li style="font-size: 20px; line-height: 38px;">容量不够，先扩容，再设置新值；</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">扩容这里有个疑问：为什么使用 index 作为基准来扩容，而不是直接扩容为旧数组容量的 2 倍呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我举个例子你就明白了，在 Netty 中，默认这个数组的容量是 32，假设我们有 100 个 FastThreadLocal 变量，且它们都没有 set () 过任何值，此时，这个数组大小依然是 32，现在如果要设置第 100 个 FastThreadLocal 的值呢？根据前面的逻辑，我们知道，它的 index 为 100，那么，此时，如果按旧数组的容量扩容为 2 倍，依然无法承载 index 为 100 的这个元素，所以，需要按 index 作为基准来进行扩容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">到这里，元素就已经添加到 Map 中了。在上面，我们看到在添加成功之后，还有一步操作是把当前 ThreadLocal 添加到待清理的 Set 中，这里是怎么实现的呢？让我们跟踪进去看看：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addToVariablesToRemove</span><span class="token punctuation">(</span>InternalThreadLocalMap threadLocalMap<span class="token punctuation">,</span> FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> variable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// variablesToRemoveIndex是FastThreadLocal中的常量，它的值为0</span>
    <span class="token comment">// 它对应的值同样存储在InternalThreadLocalMap中，是下标为0的元素</span>
    <span class="token comment">// 这里也就解释了为什么FastThreadLocal的index是从0开始的了，因为被variablesToRemoveIndex占用了</span>
    Object v <span class="token operator">=</span> threadLocalMap<span class="token punctuation">.</span><span class="token function">indexedVariable</span><span class="token punctuation">(</span>variablesToRemoveIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 0号元素是一个Set</span>
    Set<span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> variablesToRemove<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> InternalThreadLocalMap<span class="token punctuation">.</span>UNSET <span class="token operator">||</span> v <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化这个Set</span>
        variablesToRemove <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdentityHashMap</span><span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> Boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置到0号元素中</span>
        threadLocalMap<span class="token punctuation">.</span><span class="token function">setIndexedVariable</span><span class="token punctuation">(</span>variablesToRemoveIndex<span class="token punctuation">,</span> variablesToRemove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        variablesToRemove <span class="token operator">=</span> <span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 把当前FastThreadLocal添加到这个Set中</span>
    variablesToRemove<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里把当前 FastThreadLocal 添加到了 InternalThreadLocalMap 中数组的 0 号元素对应的 Set 中了，添加到这里干什么呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">让我们的代码继续前进，这里 set 完元素之后，在我们的 Runnable 中，下一步就是 get () 方法的调用了，里面的代码比较简单，就交给你自己了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 get () 方法获取到值且打印完成之后，我们的 Runnable 任务就完成了，此时，会再次回到 FastThreadLocalRunnable 的 run () 方法中，也就是下面这个方法：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 运行原始任务</span>
        runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. 清理工作</span>
        FastThreadLocal<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在我们的 Runnable 任务运行完毕后，相当于当前线程的生命周期已经趋近于结束，所以，这里有个 finally，里面会执行清理工作，那么，都清理了什么东西呢？跟踪进去：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取Map，getIfSet()方法跟上面的get()方法类似，只是内部不会再做初始化的操作</span>
    InternalThreadLocalMap threadLocalMap <span class="token operator">=</span> InternalThreadLocalMap<span class="token punctuation">.</span><span class="token function">getIfSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadLocalMap <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果为空，说明还未初始化，线程任务没有操作本地变量，直接返回就好了</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从0呈元素取出待清理的FastThreadLocal</span>
        Object v <span class="token operator">=</span> threadLocalMap<span class="token punctuation">.</span><span class="token function">indexedVariable</span><span class="token punctuation">(</span>variablesToRemoveIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 已初始化过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> v <span class="token operator">!=</span> InternalThreadLocalMap<span class="token punctuation">.</span>UNSET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 转换为Set</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            Set<span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span> variablesToRemove <span class="token operator">=</span> <span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
            <span class="token comment">// 转换为数组</span>
            FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> variablesToRemoveArray <span class="token operator">=</span>
                variablesToRemove<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 遍历数组</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>FastThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> tlv<span class="token operator">:</span> variablesToRemoveArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1. 调用FastThreadLocal的remove()方法</span>
                tlv<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2. 调用InternalThreadLocalMap的remove()方法</span>
        InternalThreadLocalMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里的逻辑比较简单，会把所有存储在待清理 Set 中的所有 FastThreadLocal 全部清除，即调用它们的 remove () 方法，同时，在最后会统一调用 InternalThreadLocalMap 的 remove () 方法，这两个 remove () 方法有什么区别呢？</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 1. FastThreadLocal#remove</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>InternalThreadLocalMap threadLocalMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadLocalMap <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从Map中移除，这里是重置为UNSET元素</span>
    Object v <span class="token operator">=</span> threadLocalMap<span class="token punctuation">.</span><span class="token function">removeIndexedVariable</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从待清理的Set中移除</span>
    <span class="token function">removeFromVariablesToRemove</span><span class="token punctuation">(</span>threadLocalMap<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> InternalThreadLocalMap<span class="token punctuation">.</span>UNSET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 执行钩子方法</span>
            <span class="token function">onRemoval</span><span class="token punctuation">(</span><span class="token punctuation">(</span>V<span class="token punctuation">)</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PlatformDependent<span class="token punctuation">.</span><span class="token function">throwException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2. InternalThreadLocalMap#remove</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Thread thread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token keyword">instanceof</span> <span class="token class-name">FastThreadLocalThread</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 移除Map本身</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>FastThreadLocalThread<span class="token punctuation">)</span> thread<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setThreadLocalMap</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从ThreadLocal中移除Map本身</span>
        slowThreadLocalMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，第一个 remove () 方法是把当前 FastThreadLocal 从 threadLocalMap 和待清理 Set 中移除，并执行钩子方法 onRemoval ()；第二个 remove () 方法是把 threadLocalMap 本身移除，当然，这里根据 Thread 的类型判断是从 FastThreadLocalThread 中移除还是从 ThreadLocal 中移除。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在上面，我们提到了一个钩子方法 onRemoval ()，它是干什么的呢？它实际上是一个空方法，这是 Netty 为我们预留的一个方法，我们可以继承自 FastThreadLocal 并实现 onRemoval () 方法，在移除 FastThreadLocal 的时候做一些我们自己的逻辑，比如清理我们自定义的资源等。其实，在 JDK 中，也有很多这种钩子方法，比如线程池 ThreadPoolExecutor.runWorker () 方法的逻辑，HashMap.putVal () 方法的逻辑（LinkedHashMap 就是使用这些钩子方法实现的），等等。</p>
</div><div class="cl-preview-section"><h2 id="其它" style="font-size: 30px;">其它</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其实，到这里，FastThreadLocal 的源码剖析过程基本结束了，但是，细心的同学可能会发现，InternalThreadLocalMap 还有个父类叫作 UnpaddedInternalThreadLocalMap，从名字可以看出多了一个 Unpadded，这个单词是什么意思呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Unpadded，顾名思义，它是 Padded 的反义词，Padded 表示的是缓存行补齐，用于消除伪共享带来的性能问题，它的补齐是通过声明下面一堆 long 类型变量来实现的。</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InternalThreadLocalMap</span> <span class="token keyword">extends</span> <span class="token class-name">UnpaddedInternalThreadLocalMap</span> <span class="token punctuation">{</span>  
    <span class="token keyword">public</span> <span class="token keyword">long</span> rp1<span class="token punctuation">,</span> rp2<span class="token punctuation">,</span> rp3<span class="token punctuation">,</span> rp4<span class="token punctuation">,</span> rp5<span class="token punctuation">,</span> rp6<span class="token punctuation">,</span> rp7<span class="token punctuation">,</span> rp8<span class="token punctuation">,</span> rp9<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但是，在 InternalThreadLocalMap 中，并没有明确的证据表明这些变量能消除伪共享。经过查询相关的 issue 发现，在早期，添加这些变量确实会补齐缓存行，但是，后面 InternalThreadLocalMap 和 UnpaddedInternalThreadLocalMap 这两个类分别添加了 cleanerFlags 和 arrayList 这两个变量，而这里的 long 类型并没有对应的修改，导致现在是超出缓存行的状态，当然，这不是主要问题，主要问题是，添加这些变量是为了防止哪个变量伪共享的，我们也不得而知。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了更好地验证这些变量是否真的能够消除伪共享，我做了测试，测试结果是在我的机器上添加这些变量并没有明显的性能提升，同学们也可以在自己的机器上测试下，具体的测试方法见文后。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">关于伪共享的问题，我们这里就不展开了，有兴趣的同学可以看看这篇文章《<a href="https://mp.weixin.qq.com/s/rd13SOSxhLA6TT13N9ni8Q">伪共享</a>》。</p>
</blockquote>
</div><div class="cl-preview-section"><h1 id="开篇回顾">开篇回顾</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在开篇，我们提了几个问题，这里根据源码的剖析结果再回顾一下：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">FastThreadLocal 有哪些使用的姿势？</p>
<p style="font-size: 20px; line-height: 38px;">FastThreadLocal 正常来说是跟 FastThreadLocalThread 联合使用的，但是，Netty 为了兼容性，也可以跟普通的 Thread 一起使用，只是会使用一种 slow 的方式来运行，这个 slow () 主要体现在 InternalThreadLocalMap 的存储上，使用 FastThreadLocalThread 时，它是存储在 FastThreadLocalThread 中的，使用普通的 Thread 时，它是存储在 Java 原生的 ThreadLocal 中的。</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">FastThreadLocal 一定比 ThreadLocal 快吗？</p>
<p style="font-size: 20px; line-height: 38px;">不一定，当 FastThreadLocal 与普通 Thread 一起使用的时候，可能会比直接使用 ThreadLocal 还慢，这得根据 ThreadLocal 值的多少和 InternalThreadLocalMap 中值的多少来判断，比如，ThreadLocal 只存储了 InternalThreadLocalMap 一个值而 InternalThreadLocalMap 中存储了 100 个值 和 ThreadLocal 存储了 100 个值而 InternalThreadLocalMap 中只存储了一个值，这两种场景的结果肯定不一样。</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">FastThreadLocal 除了快还有什么优势？</p>
<p style="font-size: 20px; line-height: 38px;">FastThreadLocal 除了快还能帮助我们自动清理相关资源，这是通过包装 Runnable 来实现的。</p>
</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其它问题，诸如 ThreadLocal、FastThreadLocal 的实现以及优缺点等，我们这里就不一一解答了。</p>
</div><div class="cl-preview-section"><h1 id="后记">后记</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节，我们一起学习了 Netty 中的一个快类 ——FastThreadLocal，从使用上来说，它与使用 Java 原生的 ThreadLocal 并无明显区别，从实现上来说，它也完全兼容与普通 Thread 的联合使用。这也正是 Netty 的魅力所在。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外，细心的同学会发现，它的相关代码完全遵循面向对象的思想，领域划分非常明确，比如，上文提到的两个 remove () 方法。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一节，我们将学习内存池中使用到的另一个非常精彩的类 ——MpscArrayQueue—— 多生产者单消费者队列，敬请期待。</p>
</div><div class="cl-preview-section"><h1 id="思维导图">思维导图</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img1.sycdn.imooc.com/5f31f8430001193121601268.png" data-original="//img1.sycdn.imooc.com/5f31f8430001193121601268.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><h1 id="关于internalthreadlocalmap的测试">关于 InternalThreadLocalMap 的测试</h1>
</div><div class="cl-preview-section"><h2 id="测试用例" style="font-size: 30px;">测试用例</h2>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalThreadLocalMapPaddingTest</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 单线程运行20次
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPadding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Boolean value <span class="token operator">=</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> fastThreadLocal <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fastThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token operator">!</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> fastThreadLocal <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fastThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            FastThreadLocal<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> end <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 多线程运行20个线程
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPaddingMultiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;&gt;</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">FastThreadLocalThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Boolean value <span class="token operator">=</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> fastThreadLocal <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fastThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token operator">!</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        FastThreadLocal<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> fastThreadLocal <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fastThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    FastThreadLocal<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> end <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"finished"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><h2 id="测试方法" style="font-size: 30px;">测试方法</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下载 netty 源码，把这个类放到 netty-common 工程的 test 下面，通过修改 InternalThreadLocalMap 源码，即把 <code>public long rp1, rp2, rp3, rp4, rp5, rp6, rp7, rp8, rp9;</code> 注释掉，对比注释前后的运行时间，记住多运行几次观察结果。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外，在 64 位机器上，还有个指针压缩的概念，可以通过参数 <code>-XX:+UseCompressedOops</code> 和 <code>-XX:-UseCompressedOops</code> 来启用和禁用指针压缩，然后再结合上面的注释前后进行对比，观察结果。</p>
</div><div class="cl-preview-section"><h2 id="测试结论" style="font-size: 30px;">测试结论</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在我的机器上，测试发现，注释前后与是否启用指针压缩，都没有带来明显的性能提升，试想，测试用例中使用了 1000000 和 100000 个 FastThreadLocal 都没有明显的提升，那么，实际生产中最多也就几十几百个 FastThreadLocal，更是可以忽略不计了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当然，以上测试结论仅限于我的机器，linux 和其它电脑并没有测试过，所以，这个结论并不严谨，仅作参考。</p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/82/article/2181">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            22 Netty的对象池又是如何实现的
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/82/article/2183">
                                                                    <div class="next r clearfix">
                                        <p>
                                            24 Netty的队列有何不一样
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img3.sycdn.imooc.com/5f1a7f610001c9a105340522.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课Java核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">2009241134354460</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：314316732</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=OouwHZGZ" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>