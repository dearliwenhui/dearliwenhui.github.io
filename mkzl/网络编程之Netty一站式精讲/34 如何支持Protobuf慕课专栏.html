<html><head><meta charset="utf-8"><title> 34 如何支持Protobuf-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                         34 如何支持Protobuf
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2020-08-25 09:38:00
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img1.sycdn.imooc.com/5f0597060001180306400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">人不可有傲气，但不可无傲骨。——徐悲鸿<p></p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><h1 id="前言">前言</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">你好，我是彤哥。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">前面的章节，我们使用 Netty 完整实现了一个麻将游戏的实战项目，不过，它还只能算是一个 Demo 项目，要达到生产级，还需要做一些优化，这些优化包括：性能调优、参数调优、安全性、可扩展性、监控等多个方面。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">前面，我们为了省事，使用的是 JSON 方式来序列化消息，不过，JSON 虽然容易阅读，但是性能方面确实要低不少，它的性能损耗主要体现在序列化之后的报文太大的问题。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，本节，我们将从性能调优的角度出发，学习如何将 JSON 替换成更高效的序列化方式 ——Protobuf。</p>
</div><div class="cl-preview-section"><h1 id="protobuf简介">Protobuf 简介</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Protocol Buffers (简称 Protobuf) ，是 Google 出品的序列化框架，与开发语言无关，和平台无关，具有良好的可扩展性。Protobuf 和所有的序列化框架一样，都可以用于数据存储、通讯协议。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Protobuf 相对于 JSON、XML、Java 序列化等其它序列化方式的优点主要体现在：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">序列化速度更快；</li>
<li style="font-size: 20px; line-height: 38px;">序列化之后的体积更小；</li>
<li style="font-size: 20px; line-height: 38px;">能够自动生成代码；</li>
<li style="font-size: 20px; line-height: 38px;">支持多语言合作开发；</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其中，前面两点是对性能的提升，后面两点，对于开发效率的提升也是显而易见的，通过 Protobuf 的自动生成代码框架，两端定义好协议，可以快速地进行开发，非常方便。比如，前端使用 lua，后端使用 Java，后端定义好协议，丢给前端，前端自己生成适合 lua 的协议代码，即可进入开发，无需等待后端定义接口文档等繁琐的过程。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外，Protobuf 分成两个版本：proto2 和 proto3，如无特殊说明，本节所有内容都是基于 proto3 进行讲解的。</p>
</div><div class="cl-preview-section"><h1 id="protobuf的简单使用">Protobuf 的简单使用</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Netty 天然就是支持 Protobuf 的，它提供了两组编解码方式的支持：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">一次编解码：ProtobufVarint32LengthFieldPrepender/ProtobufVarint32FrameDecoder</li>
<li style="font-size: 20px; line-height: 38px;"> 二次编解码：ProtobufEncoder/ProtobufDecoder</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于一次编解码，它使用的是一种变异的 “长度 + 内容” 法实现的，在经典的 “长度 + 内容” 法中，长度一旦确定是不能修改的，而 Protoubf 的两个一次编解码器，它们的长度是可变的，会根据内容的大小自动适配，具体怎么实现的呢？有兴趣的同学可以去看看源码。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于二次编解码，编码过程比较简单，将 Java 对象转换成字节数组即可，解码过程稍微复杂一点，需要传入要解码的类型，根据这个类型去反序列化，这种实现不太友好。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">好了，我们以打招呼为例来简单看一下怎么使用吧。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">客户端发送 hello 消息，带上当前人的姓名，服务端返回 hello + 姓名，整个过程包含两个协议：HelloRequest 和 HelloResponse。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用 Protobuf，第一步就是定义前后端通信的协议，以<code>.proto</code> 后缀保存：</p>
</div><div class="cl-preview-section"><pre class="  language-protobuf"><code class="prism  language-protobuf"><span class="token comment">// 使用的版本</span>
syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>
<span class="token comment">// 输出到的包名</span>
option java_package <span class="token operator">=</span> <span class="token string">"com.imooc.netty.core.$34.proto"</span><span class="token punctuation">;</span>
<span class="token comment">// 是否拆分成多个文件</span>
option java_multiple_files <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// HelloRequest</span>
<span class="token keyword">message</span> HelloRequest <span class="token punctuation">{</span>
    <span class="token primitive symbol">string</span> name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// HelloResponse </span>
<span class="token keyword">message</span> HelloResponse <span class="token punctuation">{</span>
    <span class="token primitive symbol">bool</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">string</span> <span class="token keyword">message</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">定义完协议，第二步，是根据协议生成代码，此时，需要使用到官方提供的工具，或者在 Maven 中引入相关的插件来生成，我这里使用 Maven 插件的形式生成。当然，为了能够支持 Protobuf 协议还需要引入相关的依赖：</p>
</div><div class="cl-preview-section"><pre class="  language-xml"><code class="prism  language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.protobuf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>protobuf-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.11.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extensions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>extension</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>kr.motd.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>os-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4.1.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extension</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>extensions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.xolstice.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>protobuf-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>protocArtifact</span><span class="token punctuation">&gt;</span></span>
                    com.google.protobuf:protoc:3.1.0:exe:${os.detected.classifier}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>protocArtifact</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用 Maven 插件需要把上述定义的文件放到 <code>src/main/proto</code> 目录下面，在 IDEA 中双击 probobuf compile，即可生成 Java 文件：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img1.sycdn.imooc.com/5f3f2e530001d86705610727.png" data-original="//img1.sycdn.imooc.com/5f3f2e530001d86705610727.png" alt="图片描述"><br>
生成好的文件在 target 目录下面：<br>
<img class="" src="https://img1.sycdn.imooc.com/5f3f2e620001a23505440347.png" data-original="//img1.sycdn.imooc.com/5f3f2e620001a23505440347.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">将这些文件 “移动” 到 <code>src/main/java</code> 下对应的目录就可以使用了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们先来看看如何实现服务端：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProtobufServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// ...省略其他代码</span>
        serverBootstrap<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 一次编解码</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufVarint32FrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufVarint32LengthFieldPrepender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 二次编解码，解码器必须传入具体的类型</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufDecoder</span><span class="token punctuation">(</span>HelloRequest<span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 服务端处理器</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ProtobufServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProtobufServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token operator">&lt;</span>HelloRequest<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> HelloRequest msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// 响应</span>
        HelloResponse helloResponse <span class="token operator">=</span> HelloResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"hello "</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>helloResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">请注意，ProtobufDecoder 需要传入一个 HelloRequest 的实例。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们再来看看如何实现客户端：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProtobufClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment">// ...省略其他代码</span>
        bootstrap<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token operator">&lt;</span>SocketChannel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                ChannelPipeline p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 一次编解码</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufVarint32FrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufVarint32LengthFieldPrepender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 二次编解码，解码器必须传入具体的类型</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufDecoder</span><span class="token punctuation">(</span>HelloResponse<span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 客户端处理器</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProtobufClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token operator">&lt;</span>HelloResponse<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> HelloResponse msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">注意，ProtobufDecoder 需要传入一个 HelloResponse 的实例。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">整个实现过程非常简单，我就不演示结果了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但是，这里有一个坑就是 ProtobufDecoder 解码器，它必须传入一个参数，指定你要解码成哪个类型，这使得服务端和客户端只能对一种消息类型进行编解码，在我们的麻将实战项目中，使用的是 MahjongProtocol，看似满足条件，实则不满足，还记得 MahjongProtocol 的 body 吗？它是 MahjongProtocolBody 接口类型，如果在 ProtobufDecoder 中使用，它将不知道 body 具体解码成哪个类型，所以，ProtobufDecoder 编码器似乎不太适用于我们的场景，针对这种场景，我们应该怎么处理呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我这里提供两种思路：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">编写自己的 ProtobufDecoder，从 header 中取出 cmd，再根据 cmd 取出 body 的类型，再使用 protobuf 解码；</li>
<li style="font-size: 20px; line-height: 38px;">把 MahjongProtocol 定义为大消息，里面包含所有的消息类型，而不是现在的 body 形式，MahjongProcessor 中参数修改为 MahjongProtocol，根据 header 中的 cmd 选择对应的 MahjongProcessor，在具体的 MahjongProcessor 中再调用 getXxx () 方法获取真正的消息内容，比如 LoginRequestProcessor 中调用 getLoginRequest ()；</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其中，第一种方式对现有代码改动量较少且解析方式保持一致，第二种方式对现有代码改动量较大，故此处我们采用第一种方式对项目进行改造，使其支持 Protobuf。</p>
</div><div class="cl-preview-section"><h1 id="项目改造">项目改造</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过上面的简单案例，我们会发现，生成的消息都实现了 MessageLite 接口，而且，我们已经确定了保持现有协议基本不变，即还是分成 header 和 body 两个部分，所以，需要将 body 的类型换成 MessageLite：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MahjongProtocol</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 协议头
     */</span>
    <span class="token keyword">private</span> MahjongProtocolHeader header<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 协议体
     */</span>
    <span class="token keyword">private</span> MessageLite body<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，下面我们将如何进行改造呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我认为通过下面的步骤来改造要轻松一些：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">把 pom.xml 中引用的 JSON 依赖去除，并添加 Protobuf 的依赖和插件；</li>
<li style="font-size: 20px; line-height: 38px;">编写 Protobuf 协议文件，把之前定义的消息全部使用 Protobuf 语法全部写一遍；</li>
<li style="font-size: 20px; line-height: 38px;">删除 MahjongProtocolBody 和 MahjongMessage 这两个接口；</li>
<li style="font-size: 20px; line-height: 38px;">修改所有 MahjongMessage 为 MessageLite；</li>
<li style="font-size: 20px; line-height: 38px;">修改服务启动编解码器；</li>
<li style="font-size: 20px; line-height: 38px;">修改其他报错的地方；</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，让我们按照这个步骤来走一遍。</p>
</div><div class="cl-preview-section"><h3 id="去除json依赖，添加protobuf依赖和插件">去除 JSON 依赖，添加 Protobuf 依赖和插件</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这一步比较简单，相关的依赖和插件在上面案例讲过了，这里就不再赘述了。</p>
</div><div class="cl-preview-section"><h3 id="编写protobuf协议文件">编写 Protobuf 协议文件</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们以下面四条协议为例简单讲一下编写 proto 文件应该注意的点：</p>
</div><div class="cl-preview-section"><pre class="  language-protobuf"><code class="prism  language-protobuf"><span class="token comment">// 使用的版本</span>
syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>
<span class="token comment">// 输出到的包名</span>
option java_package <span class="token operator">=</span> <span class="token string">"com.imooc.netty.mahjong.common.proto"</span><span class="token punctuation">;</span>
<span class="token comment">// 是否拆分成多个文件</span>
option java_multiple_files <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">message</span> LoginRequest <span class="token punctuation">{</span>
    <span class="token primitive symbol">string</span> username <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">string</span> password <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">message</span> LoginResponse <span class="token punctuation">{</span>
    <span class="token primitive symbol">bool</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    PlayerMsg player <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">string</span> <span class="token keyword">message</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">message</span> OperationRequest <span class="token punctuation">{</span>
    <span class="token primitive symbol">int32</span> operation <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">int32</span> pos <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">int32</span> card <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">message</span> PlayerMsg <span class="token punctuation">{</span>
    <span class="token primitive symbol">int64</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">string</span> username <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">string</span> password <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">int32</span> score <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">int32</span> pos <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">bytes</span> cards <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">bytes</span> chuCards <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">bytes</span> pengList <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token primitive symbol">bytes</span> gangList <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">在第一行要定义协议的语法（版本信息），默认为 proto2，使用 proto3 需要显式地指定；</li>
<li style="font-size: 20px; line-height: 38px;">协议文件无法引用外部类，所以需要把房间信息和玩家信息也定义成相应的协议，不过，多个 proto 文件之间是可以相互引用的；</li>
<li style="font-size: 20px; line-height: 38px;">协议文件无法支持 <code>byte</code> 类型，不足 4 个字节的数值类型统一使用 int32，还有 uint32、sint32、fixed32、sfixed32 也可以使用，略微有些差别，虽然不支持字节类型，但是在编码的时候会根据实际占用的字节数进行压缩，所以，不怕；</li>
<li style="font-size: 20px; line-height: 38px;">字节数组可以使用 <code>bytes</code> 类型，对应到 Java 的 <code>ByteString</code> 类，可以支持遍历、按索引取值等操作，不支持修改；</li>
<li style="font-size: 20px; line-height: 38px;">协议文件不支持数组，如果表示多个，可以在前面加上 <code>repeated</code>，生成的类中使用的是 <code>List&lt;T&gt;</code> 表示的；</li>
<li style="font-size: 20px; line-height: 38px;">生成的类不支持修改，一般只作查询使用，如果要修改会很麻烦，需要重新 build，所以，我们依然保留原来的 Room 和 Player 领域对象，只有发送消息的时候才将他们转换成 RoomMsg 和 PlayerMsg。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，编写完协议文件，双击 maven 插件，即可生成相应的类，把这些类移动到 <code>com.imooc.netty.mahjong.common.proto</code> 包下面，注意是移动，不是复制，复制后 target 目录下面还有一份源文件，启动项目的时候会报重复的类错误。</p>
</div><div class="cl-preview-section"><h3 id="删除mahjongprotocolbody和mahjongmessage接口">删除 MahjongProtocolBody 和 MahjongMessage 接口</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">选中这两个接口，按下 Delete 即可，不要犹豫。</p>
</div><div class="cl-preview-section"><h3 id="修改所有mahjongmessage为messagelite">修改所有 MahjongMessage 为 MessageLite</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个主要是在各个接口中：MessageManager、MahjongProcessorManager、MahjongRenderManager 等，还有 MahjongEventExecutorGroup 中，修改起来还算比较容易。</p>
</div><div class="cl-preview-section"><h3 id="修改服务启动编解码器">修改服务启动编解码器</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据前面的描述，对于一次编解码，我们完全可以换成 ProtobufVarint32LengthFieldPrepender 和 ProtobufVarint32FrameDecoder，所以，直接把原来的一次编解码删除。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于二次编解码，总体逻辑跟原来是一致的，其实编解码类本身并不需要修改，主要逻辑都在 MahjongProtocol 类中，可以参考 ProtobufEncoder 和 ProtobufDecoder 的写法，修改为如下：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MahjongProtocol</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 协议头
     */</span>
    <span class="token keyword">private</span> MahjongProtocolHeader header<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 协议体
     */</span>
    <span class="token keyword">private</span> MessageLite body<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span>ByteBuf msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> InvalidProtocolBufferException <span class="token punctuation">{</span>
        MahjongProtocolHeader header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MahjongProtocolHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解码header</span>
        header<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>header <span class="token operator">=</span> header<span class="token punctuation">;</span>

        <span class="token comment">// 命令字</span>
        <span class="token keyword">int</span> cmd <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据命令字获取body的真实类型</span>
        MessageLite msgType <span class="token operator">=</span> <span class="token function">getBodyTypeByCmd</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 解码body</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> length <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">hasArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            array <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            array <span class="token operator">=</span> ByteBufUtil<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> msgType<span class="token punctuation">.</span><span class="token function">getParserForType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> MessageLite <span class="token function">getBodyTypeByCmd</span><span class="token punctuation">(</span><span class="token keyword">int</span> cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> MessageManager<span class="token punctuation">.</span><span class="token function">getMsgTypeByCmd</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span>ByteBuf buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        header<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可以看到，编码非常简单，解码的过程相对复杂一些，我们根据 cmd 从 MessageManager 中拿到实际的消息类型，再通过一系列操作解析出 body。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当然，不要忘记修改 MahjongClient 和 MahjongServer 中的 Pipeline：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java"><span class="token comment">// 一次编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufVarint32FrameDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtobufVarint32LengthFieldPrepender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 二次编解码器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 处理器</span>
p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MahjongServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="修改其他报错的地方">修改其他报错的地方</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个步骤特别繁琐，主要都是消息构造方式的改变带来的锅，以前构造消息是这样的：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">LoginResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"username error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
MessageUtils<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">现在构造消息变成了这样：</p>
</div><div class="cl-preview-section"><pre class="  language-java"><code class="prism  language-java">LoginResponse response <span class="token operator">=</span> LoginResponse
        <span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">"username error"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
MessageUtils<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">要把所有发送消息的地方都修改一遍，是个体力活。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个步骤修改完成后，基本上就差不多了，还有一些报错的地方再针对性的修改即可。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，当我们全部修改完成后，启动四个客户端来打一局试试：<br>
<img class="" src="https://img1.sycdn.imooc.com/5f3f2e7d000183ae19050804.png" data-original="//img1.sycdn.imooc.com/5f3f2e7d000183ae19050804.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">注意观察出牌结果、格式化、牌局刷新等情况是否都跟之前保持一致，可以发现，除了直接打印的消息换行有点奇怪，其他的都是没问题的。关于直接打印消息的换行问题，在 Protobuf 中是使用 <code>\n</code> 表示换行，在 XSHELL 中使用 <code>\r\n</code> 表示换行，所以，这个问题可以忽略。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">OK，到此，Protobuf 改造完毕。</p>
</div><div class="cl-preview-section"><h1 id="后记">后记</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节，我们一起将 JSON 序列化更改为了 Protobuf 的形式，可以看到，如果前期没有规划好，到后期再去动架构层面的东西是非常痛苦的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果老板说，我们现在要做微信小游戏了，此时应该怎么办？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一节，我们将从可扩展性的角度来分析，如何让服务端支持 WebSocket 协议，敬请期待。</p>
</div><div class="cl-preview-section"><h1 id="思维导图">思维导图</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img1.sycdn.imooc.com/5f3f2e88000161e115911241.png" data-original="//img1.sycdn.imooc.com/5f3f2e88000161e115911241.png" alt="图片描述"></p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/82/article/2192">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            33 Mock客户端实现，四个人来一局
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/82/article/2194">
                                                                    <div class="next r clearfix">
                                        <p>
                                            35 如何支持WebSocket
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img1.sycdn.imooc.com/5f1a7f610001c9a105340522.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课Java核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">2009241134354460</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：314316732</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=OouwHZGZ" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>