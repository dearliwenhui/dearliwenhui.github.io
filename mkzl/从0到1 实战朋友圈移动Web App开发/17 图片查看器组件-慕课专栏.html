<html><head><meta charset="utf-8"><title>17 图片查看器组件-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        17 图片查看器组件
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-08-28 15:36:15
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img3.mukewang.com/5d62a1a80001008306400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">完成工作的方法，是爱惜每一分钟。<p class="author">——达尔文</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><h1 id="朋友圈首页ui-图片查看器组件">朋友圈首页 UI - 图片查看器组件</h1>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">图片查看器是一个移动 web 应用最常见的组件之一，当然有很多开源的组件可以供我们直接使用，但是对于我们这次项目来说，我将会带领大家重新开发一个功能完整的图片查看器组件，便于大家理解移动 web 端的一些基本事件和动画原理，并采用原始的 JavaScript 来实现（这样我们这个组件就不限于在 vue 里使用，在 react.js 或者是 zepto.js 项目中也可以使用），在学习本章内容之前，建议大家先预习一下移动 web 中 touch 基本事件的知识，可以参考这个<a href="https://juejin.im/post/5a996388f265da23884c8113">教程</a>，下面就进入开发吧。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本章节完整源代码地址，大家可以事先浏览一下：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><a href="https://github.com/lvming6816077/wecircleCode/blob/master/app/public/lib/slider/slider.js">Github</a></p>
</div><div class="cl-preview-section"><h3 id="图片查看器slider.js">图片查看器 slider.js:</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先我们需要明确一下在移动端，一个图片查看器的基本功能有：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">点击查看大图。</li>
<li style="font-size: 20px; line-height: 38px;">前后拖动查看上一张和下一张。</li>
<li style="font-size: 20px; line-height: 38px;">双击或双指放大查看。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">基于上述功能，我们开发一个可以跨框架的，利用原生 javascript 实现的图片查看器组件 slider.js，使用效果如下图：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5cf39fa300017ca400220007.gif" data-original="//img.mukewang.com/5cf39fa300017ca400220007.gif" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在前端项目中的的 public 文件夹下，在 lib 目录下，新建一个 slider 文件夹，同时新建 slider.js，图片查看器的代码，都写在这里。</p>
</div><div class="cl-preview-section"><h3 id="初始化：">初始化：</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们采取面相对象的方式来封装 Slider 对象，这里设置了一些初始值，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">  <span class="token comment">// 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Slider</span> <span class="token punctuation">(</span>opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造函数需要的参数</span>
    <span class="token keyword">var</span> imgWrap <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'DIV'</span><span class="token punctuation">)</span>
    imgWrap<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'-webkit-transform:translate3d(0,0,3px);-webkit-transition:opacity 200ms;opacity:0;position:fixed;top:0;left:0;right:0;bottom:0;background-color: #000;z-index:999;'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wrap <span class="token operator">=</span> imgWrap
    <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> opts<span class="token punctuation">.</span>list
    <span class="token comment">// 初始在哪一页</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>idx <span class="token operator">=</span> opts<span class="token punctuation">.</span>page <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token comment">// 初始化方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 渲染dom</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 绑定事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bindDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">  <span class="token comment">// 第一步 -- 初始化</span>
  Slider<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设定窗口比率</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>radio <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> window<span class="token punctuation">.</span>innerWidth
    <span class="token comment">// 设定一页的宽度 +10 代表每张图片流一定的间距</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scaleW <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">+</span> <span class="token number">10</span>
    <span class="token comment">// 放大时的最大倍数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scaleMax <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">查看器一般是全屏的，我们利用 <code>window.innerWidth</code> 来获取屏幕宽度 <code>window.innerHeight</code> 获取屏幕高度。<br>
<code>window.innerHeight / window.innerWidth</code> 表示窗口比率，在后面渲染图片时会用到。</p>
</div><div class="cl-preview-section"><h3 id="渲染dom">渲染 dom:</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在进行一些初始化操作后，我们需要将 dom 元素渲染出来，根据外部传来的图片数据，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">  Slider<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">renderDOM</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> wrap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrap
    <span class="token comment">//图片的数据</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>list
    <span class="token keyword">var</span> len <span class="token operator">=</span> data<span class="token punctuation">.</span>length

    <span class="token keyword">this</span><span class="token punctuation">.</span>outer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'height:100%;overflow:hidden;'</span>
    <span class="token comment">// 根据元素的</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
      li<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'position:absolute;display:flex;align-items:center;overflow:hidden;height:100%;'</span>
      <span class="token keyword">var</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      li<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">+</span> <span class="token string">'px'</span>
      li<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'translate3d('</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scaleW <span class="token operator">+</span> <span class="token string">'px, 0, 0)'</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据窗口的比例与图片的比例来确定</span>
        <span class="token comment">// 图片是根据宽度来等比缩放还是根据高度来等比缩放</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'height'</span><span class="token punctuation">]</span> <span class="token operator">/</span> item<span class="token punctuation">[</span><span class="token string">'width'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>radio<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          li<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;img style="max-width:100%;max-height:100%;height:'</span><span class="token operator">+</span>window<span class="token punctuation">.</span>innerHeight<span class="token operator">+</span><span class="token string">'px;margin: 0 auto;"  class="lazyload" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="'</span> <span class="token operator">+</span> item<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'"&gt;'</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          li<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;img style="max-width:100%;max-height:100%;width:'</span><span class="token operator">+</span>window<span class="token punctuation">.</span>innerWidth<span class="token operator">+</span><span class="token string">'px;margin: 0 auto;"  class="lazyload" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="'</span> <span class="token operator">+</span> item<span class="token punctuation">[</span><span class="token string">'img'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'"&gt;'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>outer<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// UL的宽度和画布宽度一致</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>outer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'width:'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scaleW <span class="token operator">+</span> <span class="token string">'px;height:100%;overflow:hidden;'</span>

    wrap<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">+</span> <span class="token string">'px'</span>
    wrap<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>outer<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>divider <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>divider<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'position: absolute;bottom: 24px;left: 50%;font-size:19px;-webkit-transform: translateX(-50%);color: rgb(109, 109, 109);'</span>

    <span class="token comment">//渲染分页的UI和样式</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> dividerItem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
      dividerItem<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">'•'</span>
      dividerItem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">'float:left;margin-right:5px;'</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dividerItem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'#fff'</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>divider<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dividerItem<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//当传入的图片列表大于等于2，才显示分页组件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wrap<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>divider<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上面的 dom 渲染，主要完成了下面的逻辑：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">创建一个 <code>ul</code> 元素，其中内部的 <code>li</code> 用来承载每个图片。</li>
<li style="font-size: 20px; line-height: 38px;">通过外部传来的数据，将 url 赋值给 <code>img</code> 元素的 <code>src</code>，并根据之前的窗口比例来设置图片的宽高。</li>
<li style="font-size: 20px; line-height: 38px;">将图片利用 CSS3 的 <code>transform:translate3d</code> 定位当前显示的图片。</li>
<li style="font-size: 20px; line-height: 38px;">最后渲染分页器的 UI 样式。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">具体代码的含义，在注释中可以查看，最终完成的 UI 逻辑如下图：<br>
<img class="" src="https://img.mukewang.com/5d12d7800001cf6c06630545.png" data-original="//img.mukewang.com/5d12d7800001cf6c06630545.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><h3 id="绑定dom事件">绑定 dom 事件:</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 dom 完成渲染之后，下面就需要绑定一些事件了，事件是图片查看器组件交互的基础，代码逻辑首先给大家总结一下，如下：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">通过监听 <code>touchstart</code> 事件，我们记录一些初始值，用来后续判断是否进入下一页，移动的基准值等等。</li>
<li style="font-size: 20px; line-height: 38px;">通过监听 <code>touchmove</code> 事件，我们在手指移动时，动态的修改 img (li 元素) 的 <code>transform</code> 的 <code>translate3d</code> 的 x 值，来达到左右移动。</li>
<li style="font-size: 20px; line-height: 38px;">当手指离开时，触发 <code>touchend</code> 事件，我们判断移动的距离来识别是进入下一张还是返回当前这张还是上一张。</li>
<li style="font-size: 20px; line-height: 38px;">当手指离开时，触发 <code>touchend</code> 事件，我们给 img (li 元素) 添加一个 <code>transition</code> 过渡动画，让 img (li 元素) 缓慢的移动到指定位置。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">然后我们在每个事件来细分讲解一下：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先需要绑定 <code>touchstart</code> 事件，在手指刚接触到屏幕时需要记录一些初始值，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">    <span class="token comment">// 第三步 -- 绑定 DOM 事件</span>
  Slider<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bindDOM</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">var</span> scaleW <span class="token operator">=</span> self<span class="token punctuation">.</span>scaleW
    <span class="token keyword">var</span> outer <span class="token operator">=</span> self<span class="token punctuation">.</span>outer


    <span class="token comment">// 手指按下的处理事件</span>
    <span class="token keyword">var</span> <span class="token function-variable function">startHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录刚刚开始按下的时间</span>
      self<span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1</span>

      <span class="token comment">// 记录手指按下的坐标</span>
      self<span class="token punctuation">.</span>startX <span class="token operator">=</span> evt<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX
      self<span class="token punctuation">.</span>startY <span class="token operator">=</span> evt<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY

      <span class="token comment">// 清除偏移量</span>
      self<span class="token punctuation">.</span>offsetX <span class="token operator">=</span> <span class="token number">0</span>

      <span class="token keyword">if</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>touches<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//判断是否有两个点在屏幕上</span>
        self<span class="token punctuation">.</span>joinPinchScale <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//进入双指方法状态</span>
        self<span class="token punctuation">.</span>pinchStart <span class="token operator">=</span> evt<span class="token punctuation">.</span>touches<span class="token punctuation">;</span>  <span class="token comment">//得到第一组两个点</span>
        self<span class="token punctuation">.</span>pinchScaleEnd <span class="token operator">=</span> self<span class="token punctuation">.</span>pinchScale <span class="token operator">||</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>joinDbClickScale <span class="token operator">?</span> self<span class="token punctuation">.</span>scaleMax <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//记录最后一次缩放的值</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>touches<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>oneTouch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>
        
  <span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上面代码中，我们主要做了这几件事：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">记录手指按下时的初始坐标，这个是为了后续位移时，可以根据初始坐标来计算。</li>
<li style="font-size: 20px; line-height: 38px;">判断当前的手指个数，如果是 2 个手指触发的 <code>touchstart</code>，那就证明是在双指方法操作，否则就是翻页操作。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其次需要绑定 <code>touchmove</code> 事件，我们在 <code>touchmove</code> 时 会实现图片的位移，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">    <span class="token comment">// 第三步 -- 绑定 DOM 事件</span>
  Slider<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bindDOM</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token operator">...</span>

    <span class="token comment">// 手指移动的处理事件</span>
    <span class="token keyword">var</span> <span class="token function-variable function">moveHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 兼容chrome android，阻止浏览器默认行为</span>
      evt<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> target <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">;</span>

      
      <span class="token comment">// 处理放大逻辑</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'IMG'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 处理双指放大</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>joinPinchScale <span class="token operator">&amp;&amp;</span> evt<span class="token punctuation">.</span>touches<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> now <span class="token operator">=</span> evt<span class="token punctuation">.</span>touches<span class="token punctuation">;</span>  <span class="token comment">//得到第二组两个点</span>

          <span class="token comment">//得到缩放比例，getDistance是勾股定理的一个方法</span>
          self<span class="token punctuation">.</span>pinchScale <span class="token operator">=</span> self<span class="token punctuation">.</span>pinchScaleEnd<span class="token operator">*</span><span class="token punctuation">(</span><span class="token function">getDistance</span><span class="token punctuation">(</span>now<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>now<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">getDistance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pinchStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>pinchStart<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
          
          <span class="token comment">// 首先将动画暂停</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransition <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>

          <span class="token comment">// 通过scale设置方法系数</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'scale3d('</span><span class="token operator">+</span>self<span class="token punctuation">.</span>pinchScale<span class="token operator">+</span><span class="token string">', '</span><span class="token operator">+</span>self<span class="token punctuation">.</span>pinchScale<span class="token operator">+</span><span class="token string">', 1)'</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span>

        <span class="token punctuation">}</span>


        <span class="token comment">//处理双击,双指放大状态时的拖动行为</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>joinPinchScale <span class="token operator">||</span> self<span class="token punctuation">.</span>joinDbClickScale<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span>oneTouch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 计算手指的偏移量</span>
          self<span class="token punctuation">.</span>_offsetX <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_offsetEndX<span class="token operator">||</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> evt<span class="token punctuation">.</span>targetTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX <span class="token operator">-</span> self<span class="token punctuation">.</span>startX<span class="token punctuation">;</span>
          self<span class="token punctuation">.</span>_offsetY <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_offsetEndY<span class="token operator">||</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> evt<span class="token punctuation">.</span>targetTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY <span class="token operator">-</span> self<span class="token punctuation">.</span>startY<span class="token punctuation">;</span>

          <span class="token comment">// 拖动时，保持图片缩放不变，只位移</span>
          <span class="token keyword">var</span> _scale <span class="token operator">=</span> self<span class="token punctuation">.</span>joinPinchScale <span class="token operator">?</span> self<span class="token punctuation">.</span>pinchScale <span class="token punctuation">:</span> self<span class="token punctuation">.</span>scaleMax<span class="token punctuation">;</span> 
          <span class="token comment">// 首先将动画暂停</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransition <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'scale3d('</span><span class="token operator">+</span>_scale<span class="token operator">+</span><span class="token string">', '</span><span class="token operator">+</span>_scale<span class="token operator">+</span><span class="token string">', 1) translate3d('</span><span class="token operator">+</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_offsetX<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'px, '</span><span class="token operator">+</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_offsetY<span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'px, 0)'</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>


      <span class="token comment">// 处理翻页逻辑</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>oneTouch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token comment">// 计算手指的偏移量</span>
        self<span class="token punctuation">.</span>offsetX <span class="token operator">=</span> evt<span class="token punctuation">.</span>targetTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageX <span class="token operator">-</span> self<span class="token punctuation">.</span>startX

        <span class="token keyword">var</span> lis <span class="token operator">=</span> outer<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>
        <span class="token comment">// 起始索引</span>
        <span class="token keyword">var</span> i <span class="token operator">=</span> self<span class="token punctuation">.</span>idx <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token comment">// 结束索引</span>
        <span class="token keyword">var</span> m <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">3</span>

        <span class="token comment">// 最小化改变DOM属性</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransition <span class="token operator">=</span> <span class="token string">'-webkit-transform 0s ease-out'</span><span class="token punctuation">)</span>
          lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lis<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'translate3d('</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">-</span> self<span class="token punctuation">.</span>idx<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scaleW <span class="token operator">+</span> self<span class="token punctuation">.</span>offsetX<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px, 0, 0)'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token operator">...</span><span class="token punctuation">.</span>
        
  <span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上面代码中，我们主要做了这几件事：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">在 <code>touchmove</code> 事件中，主要做两块逻辑 1）处理手指移动时的放大逻辑。2）处理手指移动时的翻页逻辑。</li>
<li style="font-size: 20px; line-height: 38px;">放大逻辑的条件就是在 <code>touchstart</code> 记录的双指操作的标志位，有这个标志位就证明要进入双指放大逻辑。</li>
<li style="font-size: 20px; line-height: 38px;">翻页逻辑的条件就是在 <code>touchstart</code> 记录的单指操作的标志位，有这个标志位就证明要进入翻页逻辑。</li>
<li style="font-size: 20px; line-height: 38px;">双指放大，我们采用 css3 的 <code>transform:scale3d</code> 属性，这个属性通过 js 的 <code>webkitTransform</code> 来动态设置。</li>
<li style="font-size: 20px; line-height: 38px;">在实现图片位移时，我们每次都要记录上次手指离开之后的位置坐标，然后计算出本次的位移起始量。</li>
<li style="font-size: 20px; line-height: 38px;">双指放大，我们的两个手指的位移的不同方向，采用方向位移插值和勾股定理计算出放大缩小的位移量。原理如下图：<br>
<img class="" src="https://img.mukewang.com/5d53d60f0001a39903440285.png" data-original="//img.mukewang.com/5d53d60f0001a39903440285.png" alt="图片描述"></li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">a 是两个手指开始时的位置，b 是两个手指位移后的位置，<code>distance1</code> 和 <code>distance2</code> 可以看成直角三角形的斜边，通过勾股定理计算出来，最终的缩放量采用 <code>distance1/distance2</code>。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">勾股定理对应的 <code>getDistance</code> 原理和代码如下：<br>
<img class="" src="https://img.mukewang.com/5d53d77300019be802430217.png" data-original="//img.mukewang.com/5d53d77300019be802430217.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">getDistance</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// p1,p2代表两个手指的事件对象</span>
    <span class="token keyword">var</span> x <span class="token operator">=</span> p2<span class="token punctuation">.</span>pageX <span class="token operator">-</span> p1<span class="token punctuation">.</span>pageX<span class="token punctuation">,</span>
        y <span class="token operator">=</span> p2<span class="token punctuation">.</span>pageY <span class="token operator">-</span> p1<span class="token punctuation">.</span>pageY<span class="token punctuation">;</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">*</span> x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y <span class="token operator">*</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">最后需要在 <code>touchend</code> 时处理翻页的动画，标志位的重置等操作，代码如下:</p>
</div><div class="cl-preview-section"><pre class=" language-js"><code class="prism  language-js">  <span class="token operator">...</span>


  <span class="token comment">// 手指抬起的处理事件</span>
  <span class="token keyword">var</span> <span class="token function-variable function">endHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> target <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">;</span>

    <span class="token comment">/****************下面开始处理标志位重置逻辑*************/</span>

    <span class="token comment">//处理放大状态的拖动行为记录最后1次手指离开的坐标</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'IMG'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>joinDbClickScale <span class="token operator">||</span> self<span class="token punctuation">.</span>joinPinchScale<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>_offsetEndX <span class="token operator">=</span> self<span class="token punctuation">.</span>_offsetX<span class="token punctuation">;</span>
      self<span class="token punctuation">.</span>_offsetEndY <span class="token operator">=</span> self<span class="token punctuation">.</span>_offsetY<span class="token punctuation">;</span>

      <span class="token comment">// 在双指缩放时，不允许缩放到原始尺寸小的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>pinchScale <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransition <span class="token operator">=</span> <span class="token string">'-webkit-transform .2s ease-in-out'</span>
        target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'scale3d(1,1,1)'</span>
        self<span class="token punctuation">.</span>pinchScale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重置标志位</span>
    self<span class="token punctuation">.</span>oneTouch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">/****************下面开始处理翻页逻辑和动画*************/</span>
    <span class="token comment">// 边界就翻页值</span>
    <span class="token keyword">var</span> boundary <span class="token operator">=</span> scaleW <span class="token operator">/</span> <span class="token number">6</span>

    <span class="token comment">// 手指抬起的时间值</span>
    <span class="token keyword">var</span> endTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1</span>

    <span class="token comment">// 当手指移动时间超过300ms 的时候，说明是拖动(手指始终没有离开)操作，按设定临界值位移算</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> self<span class="token punctuation">.</span>startTime <span class="token operator">&gt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果超过临界值，就表示需要移动到下一页</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>offsetX <span class="token operator">&gt;=</span> boundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上一页</span>
        self<span class="token punctuation">.</span><span class="token function">goIndex</span><span class="token punctuation">(</span><span class="token string">'-1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>offsetX <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span>offsetX <span class="token operator">&lt;</span> <span class="token operator">-</span>boundary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 下一页</span>
        self<span class="token punctuation">.</span><span class="token function">goIndex</span><span class="token punctuation">(</span><span class="token string">'+1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前页</span>
        self<span class="token punctuation">.</span><span class="token function">goIndex</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当手指移动时间不超过300ms 的时候，说明是swipe(手指很快离开)，按固定临界值算</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>offsetX <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span><span class="token function">goIndex</span><span class="token punctuation">(</span><span class="token string">'-1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>offsetX <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span><span class="token function">goIndex</span><span class="token punctuation">(</span><span class="token string">'+1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span><span class="token function">goIndex</span><span class="token punctuation">(</span><span class="token string">'0'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上面代码中，我们主要做了这几件事：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">在 <code>touchend</code> 事件中，处理一些标志位的重置操作，即恢复到初始值。</li>
<li style="font-size: 20px; line-height: 38px;">记录位移结束时的座标，就是我们上面提到的在实现图片位移时，我们每次都要记录上次手指离开之后的位置坐标，然后计算出在 <code>touchmove</code> 时的位移起始量。</li>
<li style="font-size: 20px; line-height: 38px;">根据位移量来判断是否进入翻页逻辑即上一页，当前页，或者下一页。</li>
</ol>
</div><div class="cl-preview-section"><h3 id="双击放大事件：">双击放大事件：</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在除了 <code>touchstart</code>，<code>touchmove</code>，<code>touchend</code> 这些事件之外另外需要我们完成的交互就是，双击放大效果，首先我们需要能够监听到双击事件，然后对图片进行缩放，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">
   ···

    <span class="token comment">// 双击放大事件</span>
    <span class="token keyword">var</span> <span class="token function-variable function">dbHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">var</span> target <span class="token operator">=</span> evt<span class="token punctuation">.</span>target
      <span class="token keyword">var</span> d <span class="token operator">=</span> evt

      <span class="token comment">// 确保点击的是图片</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'IMG'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 如果在双击方法或者双指放大状态下有双击操作，就让图片恢复原样</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>joinDbClickScale <span class="token operator">||</span> self<span class="token punctuation">.</span>joinPinchScale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransition <span class="token operator">=</span> <span class="token string">'-webkit-transform .2s ease-in-out'</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'scale3d(1,1,1)'</span>

          <span class="token comment">// 然后重置这2个标志位</span>
          self<span class="token punctuation">.</span>joinDbClickScale <span class="token operator">=</span> <span class="token boolean">false</span>
          self<span class="token punctuation">.</span>joinPinchScale <span class="token operator">=</span> <span class="token boolean">false</span>

          self<span class="token punctuation">.</span>pinchScale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

          <span class="token comment">// 否则就说明是要进行放大操作</span>
          self<span class="token punctuation">.</span>originX <span class="token operator">=</span> d<span class="token punctuation">.</span>offsetX<span class="token punctuation">;</span>
          self<span class="token punctuation">.</span>originY <span class="token operator">=</span> d<span class="token punctuation">.</span>offsetY<span class="token punctuation">;</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransition <span class="token operator">=</span> <span class="token string">'-webkit-transform .2s ease-in-out'</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransform <span class="token operator">=</span> <span class="token string">'scale3d('</span><span class="token operator">+</span>self<span class="token punctuation">.</span>scaleMax<span class="token operator">+</span><span class="token string">','</span><span class="token operator">+</span>self<span class="token punctuation">.</span>scaleMax<span class="token operator">+</span><span class="token string">',1)'</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransformOriginX <span class="token operator">=</span> self<span class="token punctuation">.</span>originX <span class="token operator">+</span> <span class="token string">'px'</span>
          target<span class="token punctuation">.</span>style<span class="token punctuation">.</span>webkitTransformOriginY <span class="token operator">=</span> self<span class="token punctuation">.</span>originY <span class="token operator">+</span> <span class="token string">'px'</span>


          self<span class="token punctuation">.</span>pinchScale <span class="token operator">=</span> self<span class="token punctuation">.</span>scaleMax<span class="token punctuation">;</span>

          <span class="token comment">// 进入双击放大状态</span>
          self<span class="token punctuation">.</span>joinDbClickScale <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>


  <span class="token keyword">var</span> <span class="token function-variable function">tapCloseHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>wrap<span class="token punctuation">.</span>style<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>wrap<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> lastClickTime <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">var</span> clickTimer
  <span class="token keyword">var</span> <span class="token function-variable function">clkHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nowTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nowTime <span class="token operator">-</span> lastClickTime <span class="token operator">&lt;</span> <span class="token number">230</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* 双击 */</span>
      lastClickTime <span class="token operator">=</span> <span class="token number">0</span>
      clickTimer <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>clickTimer<span class="token punctuation">)</span>
      <span class="token function">dbHandler</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">/* 单击 */</span>
      lastClickTime <span class="token operator">=</span> nowTime
      clickTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">tapCloseHandler</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  ···


</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上面代码中，我们主要做了这几件事：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">移动端的双击事件我们是采用的单击事件，在回调里判断第二次点击的时间间隔来模拟实现的，当然，各位也可以借助 <a href="http://hammerjs.github.io/">hammer.js</a> 来实现。</li>
<li style="font-size: 20px; line-height: 38px;">如果已经在双击方法或者双指放大状态下有双击操作，就让图片恢复原样，反之就表明是进入双击放大的逻辑。</li>
<li style="font-size: 20px; line-height: 38px;">借助 <code>transform</code> 的 <code>scale3d</code> 属性，可以将一个 dom 放大，而放大的原点，则利用 <code>transformOriginX</code> 和 <code>transformOriginY</code> 来设置。原点的座标就是手指双击时的座标 <code>offsetY</code> 和 <code>offsetX</code>。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>注意：由于我们使用的 javascript 来设置元素的动画和 transform 样式，所以我们需要加上 <code>webkit</code> 的前缀，例如 <code>webkitTransform</code>，<code>webkitTransition</code> 等等。</strong></p>
</div><div class="cl-preview-section"><h3 id="将事件绑定到我们outer上：">将事件绑定到我们 outer 上：</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><code>outer</code> 是在我们在开始的 <code>renderDOM</code> 方法中定义的外层父元素，我们要把事件绑定在 <code>outer</code> 上面，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">  outer<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> startHandler<span class="token punctuation">)</span>
  outer<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> moveHandler<span class="token punctuation">)</span>
  outer<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchend'</span><span class="token punctuation">,</span> endHandler<span class="token punctuation">)</span>
  outer<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> clkHandler<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="阻止ios的原生双击放大功能">阻止 iOS 的原生双击放大功能</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 iOS 10 以后，Safari 已经不再识别我们在 <code>&lt;meta&gt;</code> 标签中设置的 <code>name="viewport" maximum-scale=1.0,minimum-scale=1.0,user-scalable=no"</code> 这个属性来阻止页面触发原生的双击放大功能了，所以需要使用另外的替代方法，代码如下：</p>
</div><div class="cl-preview-section"><pre class="  language-javascript"><code class="prism  language-javascript">window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 阻止双指放大</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'gesturestart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="小结：">小结：</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本章节主要讲解了自研图片查看器 slider.js 的开发。<br>
相关技术点：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">移动端 web 的图片查看器的基本功能，包括点击查看大图，前后拖动查看上一张和下一张，双击放大，双指放大查看功能。</li>
<li style="font-size: 20px; line-height: 38px;">介绍了移动端 <code>touchstart</code>，<code>touchmove</code>，<code>touchend</code> 事件的用法结合图片查看器，实现拖动交互。难点在于放大之后的拖动行为，要记录每次拖动结束的值。</li>
<li style="font-size: 20px; line-height: 38px;">双击事件的原理，以及利用 <code>transform</code> 的 <code>scale3d</code> 属性，可以将一个 dom 放大，利用 <code>transform</code> 的 <code>translate3d</code>，可以实现一个 dom 位移。</li>
<li style="font-size: 20px; line-height: 38px;">最后想说的是，尽快现在有很多的开源图片查看器可以直接使用，但是大多数是基于 React 或者 Vue 版本的，这样的跨平台性并不是很好，并且如果直接采用开源的组件是可以实现我们的功能，但是其中的原理就不能很好的理解，所以本章节的意义就在于让学生明白其中的原理，授人以鱼不如授人以渔。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本章节完整源代码地址：<a href="https://github.com/lvming6816077/wecircleCode/blob/master/app/public/lib/slider/slider.js">Github</a></p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/42/article/659">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            16 单条内容组件开发
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/42/article/661">
                                                                    <div class="next r clearfix">
                                        <p>
                                            18 下拉刷新组件开发
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img.mukewang.com/5d5a700d0001363505400600.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课前端核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">1907231049307411</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：722466314</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=5l9EFfc" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>