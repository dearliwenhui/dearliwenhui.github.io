<html><head><meta charset="utf-8"><title>19 测试BookSpider-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">

<div class="container clearfix" id="top" style="display: block; width: 1134px;">
    
    <div class="center_con js-center_con l" style="width: 1134px;">
        <div class="article-con">
                            <!-- 买过的阅读 -->
                <div class="map">
                    <a href="/read" target="_blank"><i class="imv2-feather-o"></i></a>
                    <a href="/read/34" target="_blank">从 0 开始学爬虫</a>
                    <a href="" target="_blank">
                        <span>
                            / 5-3 19 测试BookSpider
                        </span>
                    </a>
                </div>

            


            <div class="art-title" style="margin-top: 0px;">
                19 测试BookSpider
            </div>
            <div class="art-info">
                
                <span>
                    更新时间：2019-06-17 16:11:54
                </span>
            </div>
            <div class="art-top">
                                <img src="https://img1.mukewang.com/5cf73b790001a05c06400359.jpg" alt="">
                                                <div class="famous-word-box">
                    <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                    <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                    <div class="famous-word">世上无难事,只要肯登攀。<p class="author">——毛泽东</p></div>
                </div>
                            </div>
            <div class="art-content js-lookimg">
                <div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在上一节我们完成了<code>Processor</code>的测试编写，<code>Processor</code>比较简单只是测试一个输入输出，那如何来测试<code>BookSpider</code>呢？首先，Scrapy是一个高度模块化的框架，蜘蛛只是其中提供爬网路径与内容分析的其中的个模块。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外，更重要的一点还是回归到"我们想测试什么"，测试的期望值是什么。我们可以回顾一下上一节的内容，这个<code>BookSpider</code>蜘蛛是怎么设计出来的，我们最终的思路是什么，那么这个就是预期：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">蜘蛛是否能按照我们的期望执行从 标签页-&gt;标签分类页-&gt;图书详情页这样的路径前行。</li>
<li style="font-size: 20px; line-height: 38px;"><code>ItemLoader</code>中的CSS选择器和XPath选择器的写法是否正确，提取出来的数据项(<code>Item</code>)中的内容是否正确。</li>
</ol>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在<code>tests</code>目录下创建一个<code>test_spiders.py</code>的文件并添加以下的代码:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># coding:utf-8</span>
<span class="token keyword">import</span> unittest
<span class="token keyword">import</span> os
<span class="token keyword">from</span> douban<span class="token punctuation">.</span>spiders<span class="token punctuation">.</span>book <span class="token keyword">import</span> BookSpider
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>http <span class="token keyword">import</span> HtmlResponse<span class="token punctuation">,</span> Request

<span class="token keyword">class</span> <span class="token class-name">SpiderTest</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

		<span class="token keyword">def</span> <span class="token function">test_bookspider</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">pass</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">测试有时可以很直接，既然我们的测试目标就是<code>BookSpider</code>那么就直接实例化它，然后调用里面的方法看最终输出结果不就行了？与实际运行时不同的只不过是引导程序不一样而已，实际运行是依赖于scrapy cli来引导执行，而测试不过是通过unittest引导。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">直接实例化<code>BookSpider</code>:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">spider <span class="token operator">=</span> BookSpider<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们要测试蜘蛛就得深入了解蜘蛛的动作机理，由于<code>BookSpider</code>是从<code>CrawlSpider</code>继承而来，我们就可以好好地读一读<code>CrawlSpider</code>是怎么实现的，那个才是<code>CrawlSpider</code>的入口方法。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">蜘蛛在Scrapy是负责处理返回请求的，至于<code>start_urls</code>是告诉Scrapy从哪里开始发请请求，<code>Rules</code>则是告诉Scrapy在处理完当前请求后如何生成一下步的请求，真正发出请求的是由下载器中间件<code>DownloaderMiddleware</code>完成处理的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">查看<code>CrawlSpider</code>你会找到一个<code>parse</code>函数，是提供给Scrapy当生成了请求的响应结果后调用的。它就是我们要找的函数！</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> self<span class="token punctuation">.</span>_parse_response<span class="token punctuation">(</span>response<span class="token punctuation">,</span> self<span class="token punctuation">.</span>parse_start_url<span class="token punctuation">,</span> cb_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> follow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">_parse_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> cb_kwargs<span class="token punctuation">,</span> follow<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">if</span> callback<span class="token punctuation">:</span>
    cb_res <span class="token operator">=</span> callback<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token operator">**</span>cb_kwargs<span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    cb_res <span class="token operator">=</span> self<span class="token punctuation">.</span>process_results<span class="token punctuation">(</span>response<span class="token punctuation">,</span> cb_res<span class="token punctuation">)</span>
    <span class="token keyword">for</span> requests_or_item <span class="token keyword">in</span> iterate_spider_output<span class="token punctuation">(</span>cb_res<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">yield</span> requests_or_item

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><code>parse</code>函数调用了<code>_parse_reponse</code>这个私有函数，是分析相应结果中是否有符合<code>Rule</code>中定义的提取结果，如果符合则会判断是继续生成新请求还是执行蜘蛛内的响应分析方法返回数据项(<code>Item</code>)</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么，我们只要模拟Scrapy分别向标签页、标签分类页与详情页发出请求，然后生成对应的响应对象调用这个<code>parse</code>函数并判断这个函数中返回的请求对象或数据项是否合符我们的预期就表示测试成功了。</p>
</div><div class="cl-preview-section"><h3 id="测试数据的准备">测试数据的准备</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">要模拟发出的这个请求并不是真的将请求发送到的豆瓣上去，测试一定做到无依赖可独立执行才是一个真正合格的测试。因此，我们可以直接访问那三个待页面并且直接在浏览器中将访问的页面的源代码保存下来作为<strong>仿真数据</strong>样本。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">建立一个<code>data</code>目录，将这三个html页面保存其中。如下图所示：<br>
<img src="http://img.mukewang.com/5cf48f6500019a6132542278.png" alt="图片描述" data-original="http://img.mukewang.com/5cf48f6500019a6132542278.png" class="" style="cursor: pointer;">### 数据仿真 Mock</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来我们就需要编写一个函数来产生仿真的请求与响应，因为我们已经有响应结果了所以并不需要真正地发出请求，而只是直接返回想要的请求结果对象就行了。代码如下所示：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">mock_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> target_url<span class="token punctuation">,</span> mock_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>mock_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    body <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>target_url<span class="token punctuation">,</span>
                        request <span class="token operator">=</span> Request<span class="token punctuation">(</span>target_url<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        body<span class="token operator">=</span>body<span class="token punctuation">,</span> 
                        encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个<code>mock_response</code>函数只要输入请求地址与该请求对应的网页就可以直接生成一个<code>HtmlResponse</code>对象实例了，这一过程就相当于跳过了Scrapy在真实运行的时候执行的请求过程，Scrapy的处理过程我们是不用理会的，因为那个根本不会出错所以就没有测试的必要。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来就是真正单元测试函数的内容了：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">test_crawl_rules</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
  spider <span class="token operator">=</span> BookSpider<span class="token punctuation">(</span><span class="token punctuation">)</span>

  url_and_files <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'./data/tag.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'./data/tag_list.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'./data/book.html'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>

  item_or_request <span class="token operator">=</span> spider<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>self<span class="token punctuation">.</span>build_response<span class="token punctuation">(</span><span class="token operator">*</span>url_and_files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">##TODO:对标签页处理结果进行判断</span>

  item_or_request <span class="token operator">=</span> spider<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>self<span class="token punctuation">.</span>build_response<span class="token punctuation">(</span><span class="token operator">*</span>url_and_files<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">##TODO:对标签页列表处理结果进行判断</span>
  
  item_or_request <span class="token operator">=</span> spider<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>self<span class="token punctuation">.</span>build_response<span class="token punctuation">(</span><span class="token operator">*</span>url_and_files<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">##TODO:对ItemLoader的提取内容进行测试判断</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我将对应的请求地址与结果文件放在一个由元组(Tuple)数组中，然后分别调用三次<code>spider.parse</code>函数(实际上Scrapy也是这样运行的)。先把这个爬行路径的执行逻辑编写好。暂时还不清楚要怎么写断言则先用<code>TODO</code>加上标记，下一步来做。</p>
</div><div class="cl-preview-section"><h2 id="编写断言" style="font-size: 30px;">编写断言</h2>
</div><div class="cl-preview-section"><h4 id="标签页的断言" style="font-size: 26px;">标签页的断言</h4>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">标签页是依赖于<code>CrawlSpider</code>按照<code>Rule</code>中的<code>LinkExtracotr</code>定义的提取规则从响应页面读取标签链接然后进一步地生成新的<code>Request</code>对象来完成页面的跟进的(follow)。所以第一次的调用<code>parse</code>返回的应该是一个<code>Request</code>的对象列表，而且它们的URL都是与<code>\/tag\/(.*?)</code>匹配的。那么这个断言的写法就应该如下：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">tag_pattern <span class="token operator">=</span> u<span class="token string">'\/tag\/(.*?)'</span>
<span class="token keyword">for</span> request <span class="token keyword">in</span> item_or_request<span class="token punctuation">:</span>
	self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>tag_pattern<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">如果是自己动手的同学要注意，在实例化<code>BookSpider</code>后要手动设置 <code>self._follow=True</code>否则会报错，因为这个值本来是由Scrapy内部设置的，我们在模拟时就需要改为手动设置了。</p>
</blockquote>
</div><div class="cl-preview-section"><h4 id="标签分类页的断言" style="font-size: 26px;">标签分类页的断言</h4>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于标签分类页也是相同的逻辑，只是正则表达式有所不同罢了：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">list_pattern <span class="token operator">=</span> u<span class="token string">'\/tag\/(.*?)\?start\='</span>
<span class="token keyword">for</span> request <span class="token keyword">in</span> item_or_request<span class="token punctuation">:</span>
result <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>list_pattern<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span> <span class="token operator">or</span> \
re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>tag_pattern<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span>
self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>result<span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于以上的代码你一定会产生疑惑：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">result <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>list_pattern<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span> <span class="token operator">or</span> \
re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>tag_pattern<span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为什么要对两个规则同时判断？这是因为<code>CrawlSpider</code>在每次返回的响应对象是对所有的<code>Rules</code>中的<code>LinkExtractor</code>都执行一次的，而不是只执行其中符合条件的一个。这是你不做测试是难以观察到的干货。</p>
</div><div class="cl-preview-section"><h4 id="详细页的断言" style="font-size: 26px;">详细页的断言</h4>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">同样地，将最后规则加到其中:</p>
</div><div class="cl-preview-section"><pre class="  language-pyton"><code class="prism  language-pyton">book_pattern = u'\/subject\/.*'
for request in item_or_request:
result = re.search(list_pattern, request.url) is not None or \
re.search(tag_pattern, request.url) is not None or \
re.search(book_pattern, request.url) is not None
self.assertIsNotNone(result)

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">以上的代码其实逻辑上都是重复的，我们可以精简一下代码把重用的部分都给抽出来：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">test_crawl_rules</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
  spider <span class="token operator">=</span> BookSpider<span class="token punctuation">(</span><span class="token punctuation">)</span>
  spider<span class="token punctuation">.</span>_follow_links <span class="token operator">=</span> <span class="token boolean">True</span>
  url_and_files <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'tests/data/tag.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'tests/data/tag_list.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'tests/data/book.html'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>

  <span class="token keyword">def</span> <span class="token function">check_result</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>u<span class="token string">'\/tag\/(.*?)\?start\='</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span> <span class="token operator">or</span> \
  re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>u<span class="token string">'\/tag\/(.*?)'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span> <span class="token operator">or</span> \
  re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>u<span class="token string">'\/subject\/.*'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span>

  <span class="token keyword">for</span> kv <span class="token keyword">in</span> url_and_files<span class="token punctuation">:</span>
    <span class="token punctuation">[</span>self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>check_result<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> spider<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>self<span class="token punctuation">.</span>build_response<span class="token punctuation">(</span><span class="token operator">*</span>kv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这样我们就完成对的三个不同页的爬取路径的测试了，最后就是对<code>parse_item</code>函数的单元测试了。因为我们跳过了一些处理机制，直接调用<code>parse</code>并没有办法执行<code>Rule</code>中的回调函数，所以我们就得手工测试<code>parse_item</code>了。</p>
</div><div class="cl-preview-section"><h4 id="测试itemloader" style="font-size: 26px;">测试<code>ItemLoader</code></h4>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><code>ItemLoader</code>的测试就更简单了，直接调用<code>parse_item</code>然后将采集的仿真数据中值与分析得到的值直接对比就可以知道那个提取逻辑有问题了：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">test_parse_item</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
  spider <span class="token operator">=</span> BookSpider<span class="token punctuation">(</span><span class="token punctuation">)</span>
  item <span class="token operator">=</span> spider<span class="token punctuation">.</span>parse_item<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mock_response<span class="token punctuation">(</span><span class="token string">"https://book.douban.com/tag"</span><span class="token punctuation">,</span> <span class="token string">'tests/data/book.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'解忧杂货店'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'authors'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'[日]东野圭吾'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'publishing_house'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'南海出版公司'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'publisher'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'新经典文化'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'origin_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'ナミヤ雑貨店の奇蹟'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'translators'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'李盈春'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'pub_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'2014-05-02T00:00:00'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'pages'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'291'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'price'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'39.50'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'isbn'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'9787544270878'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'rates'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'8.5'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'rating_count'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> u<span class="token string">'438151'</span><span class="token punctuation">)</span>
  self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">'summary'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上述的这个测试看似无聊，但却让我改了10个以上的错误！包括<code>BookItem</code>:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># coding:utf-8</span>

<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Item<span class="token punctuation">,</span> Field
<span class="token keyword">from</span> <span class="token punctuation">.</span>processors <span class="token keyword">import</span> Number<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> Price<span class="token punctuation">,</span> Text<span class="token punctuation">,</span>CleanText
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>processors <span class="token keyword">import</span> TakeFirst<span class="token punctuation">,</span> Join


<span class="token keyword">class</span> <span class="token class-name">BookItem</span><span class="token punctuation">(</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 书名</span>
    name <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 作者</span>
    authors <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 出版社</span>
    publishing_house <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 出品方</span>
    publisher <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 原名</span>
    origin_name <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 译者</span>
    translators <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 出版时间</span>
    pub_date <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 页数</span>
    pages <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>Number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 定价</span>
    price <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>Price<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># ISBN</span>
    isbn <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 豆瓣评分</span>
    rates <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>Number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 评价数</span>
    rating_count <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>Number<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 简介</span>
    summary <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>Text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    output_processor<span class="token operator">=</span>Join<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 作者简介</span>
    about_authors <span class="token operator">=</span> Field<span class="token punctuation">(</span>input_processor<span class="token operator">=</span>CleanText<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          output_processor<span class="token operator">=</span>TakeFirst<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">还有<code>ItemLoader</code>的提取逻辑:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">parse_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
  loader <span class="token operator">=</span> ItemLoader<span class="token punctuation">(</span>item<span class="token operator">=</span>BookItem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token operator">=</span>response<span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_css<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">"h1 span::text"</span><span class="token punctuation">)</span> <span class="token comment"># 标题</span>
  loader<span class="token punctuation">.</span>add_css<span class="token punctuation">(</span><span class="token string">'summary'</span><span class="token punctuation">,</span><span class="token string">'.related_info #link-report .intro p::text'</span><span class="token punctuation">)</span> <span class="token comment"># 简介</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'authors'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="作者:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'authors'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="作者:"]]/following::text()[2]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'publishing_house'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="出版社:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'publisher'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="出品方:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'publisher'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="出品方:"]]/following::text()[2]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'origin_name'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="原作名:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'translators'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="译者:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'translators'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="译者"]]/following::text()[2]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'pub_date'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="出版年:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'pages'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="页数:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="定价:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'isbn'</span><span class="token punctuation">,</span> u<span class="token string">'//span[.//text()[normalize-space(.)="ISBN:"]]/following::text()[1]'</span><span class="token punctuation">)</span>
  loader<span class="token punctuation">.</span>add_css<span class="token punctuation">(</span><span class="token string">'rates'</span><span class="token punctuation">,</span><span class="token string">".rating_num::text"</span><span class="token punctuation">)</span> <span class="token comment"># 得分</span>
  loader<span class="token punctuation">.</span>add_css<span class="token punctuation">(</span><span class="token string">'rating_count'</span><span class="token punctuation">,</span> <span class="token string">".rating_people&gt;span::text"</span><span class="token punctuation">)</span> <span class="token comment">#投票</span>
  <span class="token keyword">return</span> loader<span class="token punctuation">.</span>load_item<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">个中的不同你可以与上一节的内容进行对照。</p>
</div><div class="cl-preview-section"><h2 id="小结" style="font-size: 30px;">小结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我发现源代码中的错误需要运行超过20次以上，到底是在命令行运行<code>scrapy crawl</code>等待它运行到需要调试的位置快呢还是我直接在IDE上按F9运行调试直接观察错误引发的位置更快呢？你可以实际动手尝试一下体验两者的对比。只有真的尝试过测试所带来的好处你才会真正认识到测试的重要性。测试带给我们的开发过程是: 编码-&gt;测试-&gt;重构然后往复循环，在重构中改善代码。当测试已经成为你开发的一种习惯以后，这个过程会演变为：测试-&gt;编码-&gt;重构。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">注：你可以去 <a href="https://github.com/DotNetAge/douban">Github</a> 获取本节课的源代码</p>
</blockquote>
</div></div>
            </div>
                            <!-- 买过的阅读 -->
                <div class="art-next-prev clearfix">
                                                                        <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/34/article/324">
                                                    <div class="prev l clearfix">
                                <div class="icon l">
                                    <i class="imv2-arrow3_l"></i>
                                </div>
                                <p>
                                    18 测试驱动开发（TDD）网络爬虫项目
                                </p>
                            </div>
                        </a>
                                                                                            <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/34/article/325">
                                                    <div class="next r clearfix">
                                <p>
                                    20 基于SQL的数据导出机制
                                </p>
                                <div class="icon r">
                                    <i class="imv2-arrow3_r"></i>
                                </div>

                            </div>
                        </a>
                                    </div>
                    </div>
        <div class="comments-con js-comments-con" id="coments_con">     <div class="number">精选留言 <span class="js-number">0</span></div>     <div class="comments">         <div class="input-fake js-showcommentModal">             欢迎在这里发表留言，作者筛选后可公开显示         </div>                      <div class="noData">                 <p>                     <i class="imv2-error_c"></i>                 </p>                 <p>目前暂无任何讨论</p>             </div>              </div>  </div>



    </div>
    
    
    

</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>