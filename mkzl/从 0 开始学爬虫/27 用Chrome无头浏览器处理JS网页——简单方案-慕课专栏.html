<html><head><meta charset="utf-8"><title>用Chrome无头浏览器处理JS网页——简单方案-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">

<div class="container clearfix" id="top" style="display: block; width: 1134px;">
    
    <div class="center_con js-center_con l" style="width: 1134px;">
        <div class="article-con">
                            <!-- 买过的阅读 -->
                <div class="map">
                    <a href="/read" target="_blank"><i class="imv2-feather-o"></i></a>
                    <a href="/read/34" target="_blank">从 0 开始学爬虫</a>
                    <a href="" target="_blank">
                        <span>
                            / 6-4 用Chrome无头浏览器处理JS网页——简单方案
                        </span>
                    </a>
                </div>

            


            <div class="art-title" style="margin-top: 0px;">
                用Chrome无头浏览器处理JS网页——简单方案
            </div>
            <div class="art-info">
                
                <span>
                    更新时间：2019-07-03 15:11:55
                </span>
            </div>
            <div class="art-top">
                                <img src="https://img1.mukewang.com/5d1984120001b4eb06400359.jpg" alt="">
                                                <div class="famous-word-box">
                    <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                    <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                    <div class="famous-word">人的差异在于业余时间。<p class="author">——爱因斯坦</p></div>
                </div>
                            </div>
            <div class="art-content js-lookimg">
                <div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如何使用 chrome 更好地处理重深度集成 javascript 框架的网站。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可能不少读者会觉得采用Splash的爬取方式会比较难学，而且原理上也比较绕但毕竟那是在GitHub上获得超过2K star的一个出名的库，这个数字也证明了从众之多必然有其优势。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了可以更加让更多读者可以更简单地在scrapy正确地渲染重度应用javascript的网站，本节将会介绍另一种更简单也更传统的做法——Chrome无头浏览器(Chrome Headless Browser)</p>
</div><div class="cl-preview-section"><h2 id="seleiumn-与过去的-phantomjs" style="font-size: 30px;">Seleiumn 与过去的 PhantomJS</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Selenium是一个基于Java开发的自动化浏览器处理器，从另一个角度来说,它更像是一个浏览器驱动的代理。它提供了一套访问浏览器内核的编程接口，程序可以调用Selenium的编程接口以控制浏览器的行为，甚至操控DOM。它自身是没有配备浏览器的,因此需要配合本机上安装的浏览器驱动一同使用，例如，Firefox、Chrome、Safari等。由于自动化测试与持续集成的大面积推广，使得Selenium被广泛地应用于各种语言平台。NodeJS、Python、Ruby、Java等主流Web开发语言工具链中必然会发现它的身影。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Selenium支持各种主流浏览器，更重要的是，它的接口是统一的，并不需要因为更换浏览器而改动任何的编码。因此我们也可以使用它来作为爬虫渲染动态网页的工具。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Selenium多用于界面测试的开发场景，由于Selenium能完全以编程方式模仿真人浏览网页的特性也非常符合我们用来开发各种高匿爬虫。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Selenium多年来更多是配合着PhantomJS这个无头浏览器一并使用，PhantomJS的内核是采用Google V8引擎进行开发的，它可以属于一个Chrome的第三方开发的无头浏览器版本。</p>
</div><div class="cl-preview-section"><h2 id="新一代的-chrome-无头浏览器" style="font-size: 30px;">新一代的 Chrome 无头浏览器</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因为界面测试的普及，界业对无头浏览器的需求也在激增。所以在新一代的Chrome驱动中就附带了Chrome的无头浏览器版本。它与普通的Chrome不同的地方是它是不会显示界面的，所有的功能都需要通过编程实现，这样会比引导一个完全版的Chrome来访问网页会省下更多的内存消耗，继而会得到更高的运行效率。</p>
</div><div class="cl-preview-section"><h3 id="安装chrome无头浏览器">安装Chrome无头浏览器</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Ubuntu</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第一步：更新必要的安装包</p>
</div><div class="cl-preview-section"><pre><code>$ sudo apt-get update
$ sudo apt-get install -y unzip xvfb libxi6 libgconf-2-4
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果你的机器上没有安装 JDK还需要执行以下的步骤：</p>
</div><div class="cl-preview-section"><pre><code>$ sudo apt-get install default-jdk 
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第二步：安装Chrome浏览器</p>
</div><div class="cl-preview-section"><pre><code>$ sudo curl -sS -o - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add
$ sudo echo "deb [arch=amd64]  http://dl.google.com/linux/chrome/deb/ stable main" &gt;&gt; /etc/apt/sources.list.d/google-chrome.list
$ sudo apt-get -y update
$ sudo apt-get -y install google-chrome-stable
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第三步：安装ChromeDriver</p>
</div><div class="cl-preview-section"><pre><code>$ wget https://chromedriver.storage.googleapis.com/2.41/chromedriver_linux64.zip
$ unzip chromedriver_linux64.zip
$ sudo mv chromedriver /usr/bin/chromedriver
$ sudo chown root:root /usr/bin/chromedriver
$ sudo chmod +x /usr/bin/chromedriver
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">macOS</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于macOS而言这个过程就变得相当简单了，用Homebrew安装只需要执行以下几步</p>
</div><div class="cl-preview-section"><pre><code>$ brew tap homebrew/cask
$ brew update
$ brew cask install chromedriver
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Windows</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">windows的安装请移步到<a href="http://chromedriver.chromium.org/downloads">ChromeDriver - WebDriver for Chrome</a>上下载吧。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;"><strong>建议</strong>：我强烈建议不要在windows环境下进行python开发，windows只适用于办公，用于做一些高级的服务端开发只会产生各种各样的坑，毕竟windows的编程生态只适合于 .net 生存，其它的语言还是回归到 linux的怀抱会更省心省力，生命如此短暂可不是用来为windows填坑的。</p>
</blockquote>
</div><div class="cl-preview-section"><h3 id="chrome无头浏览器的实例化">Chrome无头浏览器的实例化</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在使用selenium + Chrome无头浏览器来改写我们的花瓣蜘蛛之前，我们可以先来写个测试对Chrome无头浏览器的使用有一个简单的认识。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来要在scrapy的虚拟环境中安装selenium：</p>
</div><div class="cl-preview-section"><pre><code>$ pip install selenium
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">建立一个<code>test_chromeheadless.py</code>的测试文件，然后在这个测试文件中先将在上一章我们在lua代码中进行模拟登录的代码用python来进行复现。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先导入必要的库</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>options <span class="token keyword">import</span> Options
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>keys <span class="token keyword">import</span> Keys
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">然后构造一个浏览器实例:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">test_should_login_huaban</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># 以无头方式使用 Chrome 而无需再采用PhantomJS的方式</span>
  chrome_options <span class="token operator">=</span> Options<span class="token punctuation">(</span><span class="token punctuation">)</span>
  chrome_options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--headless"</span><span class="token punctuation">)</span>  <span class="token comment"># 指定采用无头方式</span>

  browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">"/usr/local/Caskroom/chromedriver/75.0.3770.90/chromedriver"</span><span class="token punctuation">,</span>
  options<span class="token operator">=</span>chrome_options<span class="token punctuation">)</span>
  
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上述的代码中<code>add_argument("--headless)"</code>Chrome新增的无头浏览器功能，在过去的版本中如果没有加上这个参数的话selenium会直接起动一个Chrome的浏览器并在窗口中打开，只要你去观察内存的消耗就会发现一个这样的实例一起动就得消耗掉200M以上的内存，打开一个网页这个消耗量还会不停地增加，随之而来的就是速度的下降。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于测试程序和爬虫项目而言这个我们只需要Chrome的功能而不需要它的界面，无头浏览器功能的加入就完美地解决了这一问题。</p>
</div><div class="cl-preview-section"><h3 id="隐式等待与显式等待">隐式等待与显式等待</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一步就如同在Splash中一样直接打开一个网页：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"https://huaban.com"</span><span class="token punctuation">)</span>
browser<span class="token punctuation">.</span>implicitly_wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">与Splash中一样的是这里也需要调用一个等待方法<code>implicitly_wait</code>先阻塞住线程，等待浏览器将网页加载完了再进入下步。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">两者相比的话Chrome会更好用！在Chrome的中<code>implicitly_wait</code>被称为<strong>隐式等待</strong>，也就是这种等待方式并不无明确地知道页面是否真的加载完成，只是给一个大约数字而已（包括Splash也是采用这种模式）。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Chrome更一步的是可以进行<strong>显式等待</strong>，如果我们希望花瓣网的页面加载完最后的页脚能完成加载那代码就可以这样写：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
    element <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span>
    EC<span class="token punctuation">.</span>presence_of_element_located<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span><span class="token string">"#index_footer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># 加载完成进行下一步的操作</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这段代码会等待10秒，如果10秒内找到元素则立即返回，否则抛出<code>TimeoutException</code>异常。<code>EC</code>是<code>ExpectedCondition</code>的缩写，意思就是期待条件/等待条件。 WebDriverWait默认每500毫秒调用一次<code>ExpectedCondition</code>，直到它返回成功为止。<code>ExpectedCondition</code>的类型是布尔型的，成功的返回值就是<code>true</code>，其他类型的<code>ExpectedCondition</code>成功的返回值就是<code>not null</code>。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">selenium提供了一系列的这种等待条件的判断，以下是我整理的一个表格，便于你以后使用的时候进行查阅：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>条件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>title_is</code></td>
<td>判断当前页面的title是否精确等于预期</td>
</tr>
<tr>
<td><code>title_contains</code></td>
<td>判断当前页面的title是否包含预期字符串</td>
</tr>
<tr>
<td><code>presence_of_element_located</code></td>
<td>判断某个元素是否被加入DOM树中，并不代表该元素一定可见</td>
</tr>
<tr>
<td><code>visibility_of_element_located</code></td>
<td>判断某个元素是否可见。可见代表元素非隐藏，并且元素的宽和高都不等于0</td>
</tr>
<tr>
<td><code>visibility_of</code></td>
<td>跟上面的方法做一样的事情，只是上面的方法要传入locator，这个方法直接传定位到element就好了</td>
</tr>
<tr>
<td><code>presence_of_all_elements_located</code></td>
<td>判断是否至少有1个元素存在于DOM树中。举个例子，如果页面上有n个元素的class都是’column-md-3’，那么只要有1个元素存在，这个方法就返回True</td>
</tr>
<tr>
<td><code>text_to_be_present_in_element</code></td>
<td>判断某个元素中的text是否包含了预期的字符串</td>
</tr>
<tr>
<td><code>text_to_be_present_in_element_value</code></td>
<td>判断某个元素中的<code>value</code>属性是否包含了预期的字符串</td>
</tr>
<tr>
<td><code>frame_to_be_available_and_switch_to_it</code></td>
<td>判断该frame是否可以“switch”进去，如果可以，则返回True并且“switch”进去，否则返回False</td>
</tr>
<tr>
<td><code>invisibility_of_element_located</code></td>
<td>判断某个元素中是否不存在于DOM树或不可见</td>
</tr>
<tr>
<td><code>element_to_be_clickable</code></td>
<td>判断某个元素中是否可见并且是enable的，这样才叫clickable</td>
</tr>
<tr>
<td><code>staleness_of</code></td>
<td>等某个元素从dom树中移除，注意，这个方法也返回True或False</td>
</tr>
<tr>
<td><code>element_to_be_selected</code></td>
<td>判断某个元素是否被选中了，一般用在下拉列表中</td>
</tr>
<tr>
<td><code>element_located_to_be_selected</code></td>
<td>跟上面的方法作用一样，只是上面的方法传入定位到的element，而这个方法传入locator</td>
</tr>
<tr>
<td><code>element_selection_state_to_be</code></td>
<td>判断某个元素的选中状态是否符合预期</td>
</tr>
<tr>
<td><code>element_located_selection_state_to_be</code></td>
<td>跟上面的方法作用一样，只是上面的方法传入定位到的element，而这个方法传入locator</td>
</tr>
<tr>
<td><code>alert_is_present</code></td>
<td>判断页面上是否存在alert</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">以下是隐式等待与显式等待的一些区别：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">显示等待: 明确的行为表现，在本地的selenium中运行（选择的编程语言）。可以在任何能想到的条件下工作，返回成功或者超时；可以定义元素的缺失为条件；可以定制重试间隔；可以忽略某些异常。</li>
<li style="font-size: 20px; line-height: 38px;">隐式等待: 不明确的行为表现，同一个问题在不同的操作系统、不同的浏览器、不同的selenium版本下会有各种不同的表现。在远程selenium上运行（控制浏览器的那部分），只能在寻找元素的函数上工作，返回找到元素或者（在超时以后）没有找到 。如果检查元素缺失，那么总是会等待到超时，除了时间什么都不能指定。</li>
</ul>
</div><div class="cl-preview-section"><h3 id="模拟登录">模拟登录</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来就是模拟人工操作：点击网页上的"登录"按钮，弹出登录框后填写用户名与密码进行登录：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">login_button <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">'.login.btn'</span><span class="token punctuation">)</span>
login_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
form <span class="token operator">=</span> browser<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">'form.mail-login'</span><span class="token punctuation">)</span>
email_input <span class="token operator">=</span> form<span class="token punctuation">.</span>find_element_by_name<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
password_input <span class="token operator">=</span> form<span class="token punctuation">.</span>find_element_by_name<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
email_input<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'&lt;你的用户名&gt;'</span><span class="token punctuation">)</span>
password_input<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'&lt;你的密码&gt;'</span><span class="token punctuation">)</span>
form<span class="token punctuation">.</span>submit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">selenium定位元素的方式很丰富，都是以<code>find_element_by_xxxx</code>提供，更多的方法可以参考<a href="https://selenium-python.readthedocs.io/locating-elements.html">selenium文档的locating elements</a>的具体说明。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里要注意的是填充<code>input</code>元素时用的并不是复制语句，而是使用<code>send_keys(值)</code>。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">完成登录之后就可以从<code>browser</code>中获取Cookie了:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">cookies <span class="token operator">=</span> browser<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><h2 id="编写-chromemiddleware-中间件" style="font-size: 30px;">编写 <code>ChromeMiddleware</code> 中间件</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果使用selenium + chrome方式来访问网页那么就不能将这个访问写到蜘蛛中了，因为这样做就会失去Scrapy的并发能力。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">原因是<code>browser.get(url)</code>方法是由浏览器自己发出请求并获得响应结果，这样就会完全打断了scrapy的处理链条。蜘蛛将会一次性处理所有发出的请求与返回请求，如果用这样的思路来写编写的话可能不用scrapy比用scrapy还省事。因为只是写一个能作循环处理的简单脚本即可了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">所以，在使用这个技术之前我们得做一些设计，要基于scrapy的机制在其运行环节中增加一个中间件来截获由scrapy引擎传递的请求，在中间件中将请求的处理转发给chrome然后直接返回一个标准scrapy 响应对象。这样一来我们又可以像之前的方式来设计与编写蜘蛛了。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>common<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> TimeoutException
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>http <span class="token keyword">import</span> HtmlResponse
<span class="token keyword">from</span> logging <span class="token keyword">import</span> getLogger


<span class="token keyword">class</span> <span class="token class-name">ChromeMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Chrome 无头浏览器中间件。
    """</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">from_crawler</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>timeout<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SELENIUM_TIMEOUT'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   exec_path<span class="token operator">=</span>crawler<span class="token punctuation">.</span>settings<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'CHROMEDRIVER'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> exec_path<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>  <span class="token comment"># 打开日志</span>
        self<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout
        options <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
        options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'headless'</span><span class="token punctuation">)</span>  <span class="token comment"># 采用无头浏览器</span>
        self<span class="token punctuation">.</span>browser <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span>exec_path<span class="token punctuation">,</span>
                 options<span class="token operator">=</span>options<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>set_window_size<span class="token punctuation">(</span><span class="token number">1400</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">)</span>  <span class="token comment"># 设置浏览窗口</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>set_page_load_timeout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>  <span class="token comment"># 设置浏览器加载网页的超时时间</span>

    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 释构时关闭浏览器实例</span>


    <span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        login_button <span class="token operator">=</span> self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">'.login.btn'</span><span class="token punctuation">)</span>
        login_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>
        form <span class="token operator">=</span> self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>find_element_by_css_selector<span class="token punctuation">(</span><span class="token string">'form.mail-login'</span><span class="token punctuation">)</span>
        email_input <span class="token operator">=</span> form<span class="token punctuation">.</span>find_element_by_name<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span>
        password_input <span class="token operator">=</span> form<span class="token punctuation">.</span>find_element_by_name<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span>
        email_input<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'13725260426'</span><span class="token punctuation">)</span>
        password_input<span class="token punctuation">.</span>send_keys<span class="token punctuation">(</span><span class="token string">'Lruikun'</span><span class="token punctuation">)</span>
        form<span class="token punctuation">.</span>submit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>implicitly_wait<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        用Chrome抓取页面
        :param request: Request对象
        :param spider: Spider对象
        :return: HtmlResponse
        """</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>u<span class="token string">'启动Chrome...'</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            <span class="token comment"># 等待页脚被渲染完成</span>
            self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>implicitly_wait<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

            <span class="token comment"># 检查浏览器中是否已经存有登录的Cookie</span>
            cookies <span class="token operator">=</span> self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get_cookies<span class="token punctuation">(</span><span class="token punctuation">)</span>
            is_login <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">for</span> cookie <span class="token keyword">in</span> cookies<span class="token punctuation">:</span>
                <span class="token keyword">if</span> cookie<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'sid'</span><span class="token punctuation">:</span>
                    is_login <span class="token operator">=</span> <span class="token boolean">True</span>
                    <span class="token keyword">break</span>

            <span class="token keyword">if</span> <span class="token operator">not</span> is_login<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>implicitly_wait<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
                                body<span class="token operator">=</span>self<span class="token punctuation">.</span>browser<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span>
                                request<span class="token operator">=</span>request<span class="token punctuation">,</span>
                                encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                                status<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> TimeoutException<span class="token punctuation">:</span>
            <span class="token comment"># 超时抛出异常</span>
            <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> request<span class="token operator">=</span>request<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="蜘蛛">蜘蛛</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当我们将Chrome集成到中间件时蜘蛛的逻辑又将回归到原有的路上，与本专栏开始介绍的蜘蛛的编写方式完全一致：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>spiders <span class="token keyword">import</span> Spider
<span class="token keyword">from</span> huaban<span class="token punctuation">.</span>items <span class="token keyword">import</span> HuabanItem


<span class="token keyword">def</span> <span class="token function">_gen_start_urls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> <span class="token string">'https://huaban.com/search/?q=app&amp;type=pins&amp;page=%s&amp;per_page=20'</span> <span class="token operator">%</span> i

<span class="token keyword">class</span> <span class="token class-name">Bee</span><span class="token punctuation">(</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'bee'</span>
    start_urls <span class="token operator">=</span> _gen_start_urls<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        item <span class="token operator">=</span> HuabanItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pinEles <span class="token operator">=</span> response<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">"#waterfall div.pin"</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> pinEle <span class="token keyword">in</span> pinEles<span class="token punctuation">:</span>
            item<span class="token punctuation">[</span><span class="token string">'img_url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'https:%s'</span> <span class="token operator">%</span> pinEle<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'a.img&gt;img::attr(src)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'link'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pinEle<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'a::attr(href)'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            item<span class="token punctuation">[</span><span class="token string">'desc'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pinEle<span class="token punctuation">.</span>css<span class="token punctuation">(</span><span class="token string">'p.description::text'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">yield</span> item
</code></pre>
</div><div class="cl-preview-section"><h3 id="配置">配置</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">以下是整个爬虫项目的配置：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

BOT_NAME <span class="token operator">=</span> <span class="token string">'bee'</span>

SPIDER_MODULES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'huaban.spiders'</span><span class="token punctuation">]</span>
NEWSPIDER_MODULE <span class="token operator">=</span> <span class="token string">'huaban.spiders'</span>
ROBOTSTXT_OBEY <span class="token operator">=</span> <span class="token boolean">False</span>

SELENIUM_TIMEOUT <span class="token operator">=</span><span class="token number">10</span>
CHROMEDRIVER <span class="token operator">=</span> <span class="token string">"/usr/local/Caskroom/chromedriver/75.0.3770.90/chromedriver"</span>

<span class="token comment"># 加入Chrome中间件</span>
DOWNLOADER_MIDDLEWARES <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token string">'huaban.middlewares.ChromeMiddleware'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

CONCURRENT_REQUESTS <span class="token operator">=</span> <span class="token number">2</span>
COOKIES_ENABLED <span class="token operator">=</span> <span class="token boolean">False</span>
TELNETCONSOLE_ENABLED <span class="token operator">=</span> <span class="token boolean">False</span>
AUTOTHROTTLE_ENABLED <span class="token operator">=</span> <span class="token boolean">True</span>
AUTOTHROTTLE_START_DELAY <span class="token operator">=</span> <span class="token number">5</span>
AUTOTHROTTLE_MAX_DELAY <span class="token operator">=</span> <span class="token number">60</span>
AUTOTHROTTLE_TARGET_CONCURRENCY <span class="token operator">=</span> <span class="token number">1.0</span>

HTTPCACHE_ENABLED <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里要注意的地方，首先是要将Chrome的中间件加入到<code>DOWNLOADER_MIDDLEWARES</code>配置中，并且将优级调节到最高，其次就是要打开自动降速配置<code>AUTOTHROTTLE_ENABLED = True</code>，如果不打开自动降速配置的话蜘蛛就会以一种**”非人“**的速度来爬网了，这样就对方一定会发现这是爬虫行为，而失去了隐秘性了。</p>
</div><div class="cl-preview-section"><h2 id="小结" style="font-size: 30px;">小结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">至此我们已经能够成功地爬取花瓣网这种重度使用Javascript的网站内容了，这种蜘蛛的特性就是“慢”与“高匿”，它的速度只是比我们人工访问网站的速度快上一些，但决不能与之前所介绍的所有爬虫相比，这一点在本章第一节中已经很详细地提及。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本章书的爬网方法不单单能应用于爬虫，还可以应用在软件的界面测试中。更确切地说这种渲染Javascript网页的爬虫方式就是借用python界面测试的方法而来的。</p>
</div></div>
            </div>
                            <!-- 买过的阅读 -->
                <div class="art-next-prev clearfix">
                                                                        <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/34/article/331">
                                                    <div class="prev l clearfix">
                                <div class="icon l">
                                    <i class="imv2-arrow3_l"></i>
                                </div>
                                <p>
                                    用Splash服务处理花瓣网JS网页—高速方案
                                </p>
                            </div>
                        </a>
                                                                                            <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/34/article/333">
                                                    <div class="next r clearfix">
                                <p>
                                    将采集到的图片存储于阿里云oss
                                </p>
                                <div class="icon r">
                                    <i class="imv2-arrow3_r"></i>
                                </div>

                            </div>
                        </a>
                                    </div>
                    </div>
        <div class="comments-con js-comments-con" id="coments_con">
        </div>



    </div>
    
    
    

</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>