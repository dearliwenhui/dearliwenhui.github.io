<html><head><meta charset="utf-8"><title>打开花瓣网的大门-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">

<div class="container clearfix" id="top" style="display: block; width: 1134px;">
    
    <div class="center_con js-center_con l" style="width: 1134px;">
        <div class="article-con">
                            <!-- 买过的阅读 -->
                <div class="map">
                    <a href="/read" target="_blank"><i class="imv2-feather-o"></i></a>
                    <a href="/read/34" target="_blank">从 0 开始学爬虫</a>
                    <a href="" target="_blank">
                        <span>
                            / 6-2 打开花瓣网的大门
                        </span>
                    </a>
                </div>

            


            <div class="art-title" style="margin-top: 0px;">
                打开花瓣网的大门
            </div>
            <div class="art-info">
                
                <span>
                    更新时间：2019-06-28 17:52:37
                </span>
            </div>
            <div class="art-top">
                                <img src="https://img.mukewang.com/5d15e3410001de9406400359.jpg" alt="">
                                                <div class="famous-word-box">
                    <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                    <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                    <div class="famous-word">对自己不满是任何真正有才能的人的根本特征之一。<p class="author">——契诃夫</p></div>
                </div>
                            </div>
            <div class="art-content js-lookimg">
                <div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在上一节我们已经有一个基本的开发思路，在这一节一上来当然就是建立一个花瓣网爬虫直接动手开干！</p>
</div><div class="cl-preview-section"><h2 id="建立基本环境" style="font-size: 30px;">建立基本环境</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">建立项目并激活 Python 虚环境</p>
</div><div class="cl-preview-section"><pre><code>$ scrapy startproject huaban
$ cd huahan
$ virtualenv -p python3
$ . venv/bin/activate
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">先打开配置文件将爬虫配置为低速运行并且可以随机降速：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">USER_AGENT <span class="token operator">=</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/601.7.8 (KHTML, like Gecko) Version/9.1.3 Safari/537.86.7'</span><span class="token punctuation">,</span>

CONCURRENT_REQUESTS <span class="token operator">=</span> <span class="token number">1</span>
AUTOTHROTTLE_ENABLED <span class="token operator">=</span> <span class="token boolean">True</span>
AUTOTHROTTLE_START_DELAY <span class="token operator">=</span> <span class="token number">5</span>
AUTOTHROTTLE_MAX_DELAY <span class="token operator">=</span> <span class="token number">60</span>
AUTOTHROTTLE_TARGET_CONCURRENCY <span class="token operator">=</span> <span class="token number">1.0</span>
AUTOTHROTTLE_DEBUG <span class="token operator">=</span> <span class="token boolean">False</span>
TELNETCONSOLE_ENABLED <span class="token operator">=</span> <span class="token boolean">False</span>
HTTPCACHE_ENABLED <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我禁用了 HTTP 缓存，因为花瓣的每个请求所返回的内容是随机的，同一样 URL 返回的内容可能不同，所以不使用缓存。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">将<code>TELNETCONSOLE_ENABLED = False</code>是为了让项目起动得更快，我们有 PyCharm 的调试器根本就不需要用 Telnet 来进入到 Scrapy 的内嵌调试外壳中。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">启用自动降速，并且将<code>CONCURRENT_REQUESTS = 1</code>让爬虫只能每次启用一个线程，让爬虫不要因为速度过快而暴露了非人的身份。</p>
</div><div class="cl-preview-section"><h2 id="如何进行登录？" style="font-size: 30px;">如何进行登录？</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">要开始爬取之前就必须先用已注册的身份进行登录。在浏览器中退出原有的登录然后重新打开登录对话框<br>
<img src="http://img.mukewang.com/5d15ded30001b7bb27822218.png" alt="图片描述" data-original="http://img.mukewang.com/5d15ded30001b7bb27822218.png" class="" style="cursor: pointer;">打开它的网页源码可以发现这个登录模态框的代码是个标准式的登录表单:</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/auth/<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mail-login<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_ref<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>frame<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span>
    <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span>
    <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>输入手机号或邮箱<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clear-input<span class="token punctuation">"</span></span>
  <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
    <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span>
    <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>密码<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>clear-input<span class="token punctuation">"</span></span>
  <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return false;<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn18 rbtn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果要实现代码登录只要向<code>https://huaban.com/auth</code>发送一个<code>POST</code>请求将手机与密码发到服务端可以了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因为我们并不确定这个想法是否靠谱，也不清楚用代码 POST 到服务器后会有什么限制，那么最佳的办法就是先写个测试来验证一下以上的想法。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">先来安装一个<code>requests</code>工具来发送网络请求:</p>
</div><div class="cl-preview-section"><pre><code>(venv) $ pip install requests
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在<code>tests/test_login.py</code>文件内添加以下的代码内容:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">from</span> unittest <span class="token keyword">import</span> TestCase<span class="token punctuation">,</span>skip
<span class="token keyword">import</span> requests

<span class="token keyword">class</span> <span class="token class-name">LoginTestCase</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">test_login</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">'https://huaban.com/auth/'</span>
        values <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的手机号'</span><span class="token punctuation">,</span>
            <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的密码'</span><span class="token punctuation">,</span>
            <span class="token string">'_ref'</span><span class="token punctuation">:</span> <span class="token string">'frame'</span>
        <span class="token punctuation">}</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>values<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个测试只是检查请求是否正常地返回<code>200</code>的响应代码，但这是不够的。只要仔细一想就能了解到这么一点：那服务器是凭什么记住了我的登录信息的呢？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">答案很简单，那就是 Cookie。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">绝大多数的网站都会采用 Cookie 来存储用户的登录后信息，花瓣也不例外。即使不写代码也能从 Chrome 的开发人员工具里面找到由花瓣网产生的 Cookie:<br>
<img src="http://img.mukewang.com/5d15df06000111a135842278.png" alt="图片描述" data-original="http://img.mukewang.com/5d15df06000111a135842278.png" class="" style="cursor: pointer;">那只要在上述测试中加入一个对 Cookie 的断言就可以确认是否能正确地登入花瓣网了：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment">#根据Domain获取花瓣颁发的Cookie</span>
cookies <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'.huaban.com'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>cookies<span class="token punctuation">[</span><span class="token string">'sid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>assertIsNotNone<span class="token punctuation">(</span>cookies<span class="token punctuation">[</span><span class="token string">'uid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">只要在调试器或者直接打印一下<code>cookies</code>对象就可以知道花瓣登录之后会生成一个有<code>sid</code>与<code>uid</code>值对的<code>Cookie</code>，也就是这两个值"记住"了我们的登录状态。</p>
</div><div class="cl-preview-section"><h2 id="formrequest" style="font-size: 30px;"><code>FormRequest</code></h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来就是要将<code>requests</code>的方式转化为 Scrapy 的写法。在 Scrapy 中有一个<code>FormRequest</code>对象专门用于处理<code>Form</code>请求。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这是一个继承自<code>Request</code>对象并专门用于处理表单请求的对象。<code>FormRequest</code>可以从<code>Response</code>对象中自动分析响应网页结果中的表单并对表单内的输入域进行预填充。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">以下是<code>FormRequest</code>的构造函数：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">scrapy</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span>FormRequest<span class="token punctuation">(</span>url<span class="token punctuation">[</span><span class="token punctuation">,</span> formdata<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><code>FormRequest</code>的使用非常简单，只要提供表单提交时的目标 URL 和表单中必备的输入域的“键-值”对的字典或元组对象即可。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">将测试中的请求对象改写为：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">req <span class="token operator">=</span> FormRequest<span class="token punctuation">(</span>
            url<span class="token operator">=</span><span class="token string">'https://huaban.com/auth/'</span><span class="token punctuation">,</span>
            method<span class="token operator">=</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
            formdata<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的手机号'</span><span class="token punctuation">,</span>
                <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的密码'</span><span class="token punctuation">,</span>
                <span class="token string">'_ref'</span><span class="token punctuation">:</span> <span class="token string">'frame'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            callback<span class="token operator">=</span>self<span class="token punctuation">.</span>after_login
        <span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那这个请求应该在哪里发起呢？接下来我们就创建一个蜘蛛对象，在开始爬网之前就发起这个<code>FormRequest</code>请求。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">创建一个新的蜘蛛:</p>
</div><div class="cl-preview-section"><pre><code>(venv) $ scrapy genspider -t basic bee https://huaban.com
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">修改 <code>settings.py</code></p>
</div><div class="cl-preview-section"><pre><code>BOT_NAME = 'bee'
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 spaiders 目录的<code>__init__.py</code>文件中加以下代码，令到 Scrapy 可以发现这个蜘蛛:</p>
</div><div class="cl-preview-section"><pre><code>from .bee import BeeSpider
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">打开<code>bee.py</code>蜘蛛文件，删除掉<code>allowed_domains</code>和<code>start_urls</code>:</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">BeeSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'bee'</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上文中我们第一次用<code>basic</code>模板来创建蜘蛛，这个模板所创建出来的蜘蛛是最简单的。<code>Spider</code>类提供了蜘蛛的最基本行为与特性，其他蜘蛛都必须继承自该类（包括 Scrapy 自带的蜘蛛以及用户自己编写的蜘蛛）。<code>Spider</code>类并没有提供太多什么特殊的功能，其仅仅请求给定的<code>start_urls/start_requests</code>，并根据返回的结果（resulting responses）然后调用<code>parse</code>方法对返回结果进行深入爬取或提取出目标数据。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">借此机会，我们不妨来看看这个基类的源码，然后回顾一下我们曾经使用过的蜘蛛的一些特性，你可能会从中理解很多当时使用之时没有理解清楚的概念，以下是我截取<code>Spider</code>部分重要的源代码：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Spider</span><span class="token punctuation">(</span>object_ref<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># 定义蜘蛛的名称</span>
    custom_settings <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> name <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">elif</span> <span class="token operator">not</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"%s must have a name"</span> <span class="token operator">%</span> <span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>update<span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'start_urls'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">"""
      就是这个方法将 start_urls生成种子请求
      """</span>
        <span class="token keyword">for</span> url <span class="token keyword">in</span> self<span class="token punctuation">.</span>start_urls<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>make_requests_from_url<span class="token punctuation">(</span>url<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">make_requests_from_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">"""
      将URL转换成为Request对象
      """</span>
        <span class="token keyword">return</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token triple-quoted-string string">"""
      子类必须实现此方法用于分析返回的响应对象的内容
      """</span>
        <span class="token keyword">raise</span> NotImplementedError
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从<code>Spider</code>类的源代码中可以得知，一旦<code>Spider</code>的子类被实例化，<code>__init__</code>中的代码就会被执行，</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> name <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">elif</span> <span class="token operator">not</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"%s must have a name"</span> <span class="token operator">%</span> <span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>__dict__<span class="token punctuation">.</span>update<span class="token punctuation">(</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'start_urls'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么就需要设定<code>name</code>与<code>start_urls</code>两个属性，这就解释了为什么我们之的范例中所有的蜘蛛在一开始就初始化<code>name</code>与<code>start_urls</code>两个属性。然而<code>Spider</code>的子类被实例化后并不会马上执行爬网，只有<code>start_requests</code>被调用时，蜘蛛才会执行爬网的动作。我们重点看一下<code>start_requests</code>方法：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> url <span class="token keyword">in</span> self<span class="token punctuation">.</span>start_urls<span class="token punctuation">:</span>
        <span class="token keyword">yield</span> self<span class="token punctuation">.</span>make_requests_from_url<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个函数非常简单，它只是一个生成<code>make_requests_from_url</code>方法调用结果的枚举器，枚举的条件就是 Spider 实例化时设定的<code>start_urls</code>，也就是爬虫爬网的“起点”。那么<code>make_requests_from_url</code>又干了什么呢？以下是它的代码：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token keyword">def</span> <span class="token function">make_requests_from_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> dont_filter<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">它只是一个工厂方法，用于生成<code>Request</code>对象。将<code>start_urls</code>、<code>start_requests</code>和<code>make_requests_from_url</code>合起来理解就是：<code>start_requests</code>一旦被调用就会产生与<code>start_urls</code>相同数量的<code>Request</code>对象的枚举器。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为什么需要了解这个工作过程？因为只有了解了<code>Request</code>是如何产生的，我们才能在一些特殊的场合深度地定制自已的蜘蛛。例如，在很多情况下<code>start_urls</code>有可能不是一个常量，而是一个生成规则，这样就可以通过方法重写来重新实现<code>start_requests</code>。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果想要修改最初爬取某个网站的<code>Request</code>对象，可以重写（override）<code>start_requests</code>方法。 例如每次访问花瓣网我们都需要先进行登录，那么我们就可以重写<code>start_requests</code>这个方法，在此进行登录操作。</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> scrapy

<span class="token keyword">class</span> <span class="token class-name">BeeSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'bee'</span>

    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	req <span class="token operator">=</span> FormRequest<span class="token punctuation">(</span>
            url<span class="token operator">=</span><span class="token string">'https://huaban.com/auth/'</span><span class="token punctuation">,</span>
            method<span class="token operator">=</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
            formdata<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的手机号'</span><span class="token punctuation">,</span>
                <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的密码'</span><span class="token punctuation">,</span>
                <span class="token string">'_ref'</span><span class="token punctuation">:</span> <span class="token string">'frame'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            callback<span class="token operator">=</span>self<span class="token punctuation">.</span>after_login
        <span class="token punctuation">)</span>
      <span class="token keyword">yield</span> req

    <span class="token keyword">def</span> <span class="token function">after_login</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
    	<span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	<span class="token keyword">pass</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当成功登录后上述的<code>FormRequest</code>对象就会调用<code>after_login</code>并传入响应对象。<code>after_login</code>此时才是真正爬虫起点，它应该处理两个问题：</p>
</div><div class="cl-preview-section"><ol>
<li style="font-size: 20px; line-height: 38px;">Hold 住 Cookie 并将其加载到每次新发出到花瓣的请求中</li>
<li style="font-size: 20px; line-height: 38px;">执行返回后的响应对象正文中的 Javascript。</li>
</ol>
</div><div class="cl-preview-section"><h2 id="cookie" style="font-size: 30px;">Cookie</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">前文我们通过 Chrome 浏览器的开发人员工具得知当成功登录后会得到两个 Cookie，一存放的是<code>uid</code>另一个存放的是<code>sid</code>虽然没有看懂这个两个 Cookie 内的值有什么具体含义，但只有它们不过期，仍然可以存在客户端则就会被花瓣网认为是已登录用户。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">那么在代码之中应该如何去获取 Cookie 呢？它在<code>response</code>对象的哪里？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Scrapy 搭载了一个<code>CookiesMiddleware</code>的中间件，这个中间件提供了自动管理Cookie的功能。如果在<code>after_login</code>中加入一个断点观察返回的<code>response</code>变量在<code>headers</code>中有一个<code>Set-Cookie</code>的字段，它保存了以下的一段内容：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python"><span class="token punctuation">[</span>
  b<span class="token string">'uid=27460062; domain=huaban.com; path=/'</span><span class="token punctuation">,</span>
  b<span class="token string">'sid=NtgJGFSG0LNxsOxfgpm1rudu9vt.d6mhETDGJbFVUToaLor0%2BV%2FSF0sZDr6eRjJH9r0hcdc; domain=huaban.com; path=/; expires=Tue, 23 Jul 2019 11:33:44 GMT; httpOnly'</span><span class="token punctuation">]</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个字节串列表就是在成功登录花瓣网之后由服务器颁发的，只要每次发出请求时都将两个<code>uid</code>和<code>sid</code>Cookie一并放回到请求的<code>headers</code>中，花瓣网就会认为我们是已经通过身份验证了。<code>CookieMiddleware</code>所谓的自动管理Cookie功能就是如此了，一定要先从服务器端获取一次Cookie然后将其放到<code>CookieMiddleware</code>内部的一个<code>CookieJar</code>对象中（你可以理解为一个专门存放Cookie的容器）当发送一下个请求时<code>CookieMiddleware</code>会自动地从<code>CookieJar</code>中重新拿出Cookie写入到的请求头中。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">此时就可以在<code>after_login</code>方法中生成通过身份验证后的起始网络请求。至于怎么能让我们的Scrapy在获取网页内容后执行上面的javascript我会在下一节中进行详细的讲解。</p>
</div><div class="cl-preview-section"><h2 id="request-与-response-中的-meta" style="font-size: 30px;">Request 与 Response 中的 meta</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在本节结束之前还有一个预备知识，那就是如何在Scrapy的<code>Request</code>与<code>Response</code>之间传输变量。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">有些时候我们需要在发出请求的时候产生一些数据在得到该请求的响应之后重新从响应对象中取出来使用，这时就需要使用到<code>meta</code>这个变量了，假如在上述的例子中，如果我需要将用户名与密码在得到服务器响应后重新如出就可以像以下代码这样做：</p>
</div><div class="cl-preview-section"><pre class="  language-python"><code class="prism  language-python">    <span class="token keyword">def</span> <span class="token function">start_requests</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	req <span class="token operator">=</span> FormRequest<span class="token punctuation">(</span>
            url<span class="token operator">=</span><span class="token string">'https://huaban.com/auth/'</span><span class="token punctuation">,</span>
            method<span class="token operator">=</span><span class="token string">'POST'</span><span class="token punctuation">,</span>
            formdata<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的手机号'</span><span class="token punctuation">,</span>
                <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的密码'</span><span class="token punctuation">,</span>
                <span class="token string">'_ref'</span><span class="token punctuation">:</span> <span class="token string">'frame'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            callback<span class="token operator">=</span>self<span class="token punctuation">.</span>after_login<span class="token punctuation">,</span>
            meta <span class="token operator">=</span> <span class="token punctuation">{</span>
            	<span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的手机号'</span><span class="token punctuation">,</span>
              <span class="token string">'password'</span><span class="token punctuation">:</span> <span class="token string">'这里输入你注册的密码'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token keyword">yield</span> req

    <span class="token keyword">def</span> <span class="token function">after_login</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
    	<span class="token keyword">print</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span> 
      <span class="token keyword">print</span> response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span> 
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个小技巧非常的实用，而且这个<code>meta</code>属性也是非常有用，里面还有不少保留关键字，在此卖个关子，有兴趣的可以深入了解一下<code>meta</code>。</p>
</div><div class="cl-preview-section"><h2 id="小结" style="font-size: 30px;">小结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">至此，我们已经敲开了花瓣网的大门，只有成功走出这一步才可能更进一步地做到拟人式的爬网。</p>
</div></div>
            </div>
                            <!-- 买过的阅读 -->
                <div class="art-next-prev clearfix">
                                                                        <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/34/article/330">
                                                    <div class="prev l clearfix">
                                <div class="icon l">
                                    <i class="imv2-arrow3_l"></i>
                                </div>
                                <p>
                                    花瓣网爬虫的分析和设计
                                </p>
                            </div>
                        </a>
                                                                                            <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/34/article/331">
                                                    <div class="next r clearfix">
                                <p>
                                    用Splash服务处理花瓣网JS网页—高速方案
                                </p>
                                <div class="icon r">
                                    <i class="imv2-arrow3_r"></i>
                                </div>

                            </div>
                        </a>
                                    </div>
                    </div>
        <div class="comments-con js-comments-con" id="coments_con">
        </div>



    </div>
    
    
    

</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>