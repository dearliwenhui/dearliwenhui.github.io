<html><head><meta charset="utf-8"><title>08 数据交互：云开发让数据库操作如此简单-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">

<div class="container clearfix" id="top" style="display: block; width: 1134px;">
    
    <div class="center_con js-center_con l" style="width: 1134px;">
        <div class="article-con">
                            <!-- 买过的阅读 -->
                <div class="map">
                    <a href="/read" target="_blank"><i class="imv2-feather-o"></i></a>
                    <a href="/read/40" target="_blank">零基础实现微信电商小程序开发</a>
                    <a href="" target="_blank">
                        <span>
                            / 3-2 08 数据交互：云开发让数据库操作如此简单
                        </span>
                    </a>
                </div>

            


            <div class="art-title" style="margin-top: 0px;">
                08 数据交互：云开发让数据库操作如此简单
            </div>
            <div class="art-info">
                
                <span>
                    更新时间：2019-07-11 15:01:05
                </span>
            </div>
            <div class="art-top">
                                <img src="https://img.mukewang.com/5d1ee753000124f906400359.jpg" alt="">
                                                <div class="famous-word-box">
                    <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                    <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                    <div class="famous-word">学习从来无捷径，循序渐进登高峰。 <p class="author">—— 高永祚</p></div>
                </div>
                            </div>
            <div class="art-content js-lookimg">
                <div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上一节我们实践了使用 “分类拆解法” 的思维，利用小程序生态丰富的组件，开发一个小程序页面。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在实际小程序应用开发中，除了开发手机端的小程序页面，还需要一个服务端来向小程序页面提供显示数据。如果我们把所有显示数据都直接写在小程序页面中，每次我们改变任何一个数据，我们都必须修改小程序页面，然后发布一个新版本的小程序，这显然是不现实的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上一节的小程序页面中幻灯片具体显示的图片是什么，三个板块菜单点击后显示的具体内容是什么，这些显示数据都需要小程序页面从服务端获取。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，本节我们将讲解如何使用云开发实现服务端的数据存储，以及小程序手机端如何实现与服务端的数据交互。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第一个实践内容是页面访问计数功能，如图 10 所示。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 10 页面访问计数Demo</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d206d570001884d04160736.png" alt="图片描述" data-original="http://img.mukewang.com/5d206d570001884d04160736.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><h2 id="页面访问计数功能分析" style="font-size: 30px;">1. 页面访问计数功能分析</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">页面访问计数要实现的功能是，当用户打开一次页面，我们就要记录一次该用户打开页面的次数，并将该用户打开页面的总次数显示在页面底部（图 10 红框部分）。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">举例来说，当张三第一次打开页面，页面应该显示“这是你第 1 次访问本页面”；当张三再次打开页面，页面应该显示“这是你第 2 次访问本页面”。而当李四第一次打开页面，页面应该显示“这是你第 1 次访问本页面”。</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>用户ID</th>
<th>打开页面次数</th>
</tr>
</thead>
<tbody>
<tr>
<td>张三</td>
<td>2</td>
</tr>
<tr>
<td>李四</td>
<td>1</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，我们可以总结出页面访问计数功能有以下规则：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">规则 1 ：每个用户打开页面的次数要单独计算，即每个用户打开页面的次数要使用一条单独的数据记录保存；</li>
<li style="font-size: 20px; line-height: 38px;">规则 2 ：需要一个数据库集合 <code>counters</code> 来存储每个用户打开页面次数的数据记录；</li>
<li style="font-size: 20px; line-height: 38px;">规则 3 ：每条数据记录至少要包含两个信息，用户的 ID 和 打开页面的次数；</li>
<li style="font-size: 20px; line-height: 38px;">规则 4 ：当用户第一次打开页面，需要在数据库集合中添加一条该用户打开页面次数的数据记录，并设置打开页面的次数为 1；</li>
<li style="font-size: 20px; line-height: 38px;">规则 5 ：当用户再次打开页面，该用户数据记录的打开页面次数加 1；</li>
<li style="font-size: 20px; line-height: 38px;">规则 6 ：将用户打开页面次数的记录数据显示在页面中。</li>
</ul>
</div><div class="cl-preview-section"><h2 id="建立云开发数据库" style="font-size: 30px;">2. 建立云开发数据库</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在第二章第一节的实践环节，已经请各位同学先行阅读小程序云开发“基础”章节。如你还未完成该实践环节，请暂停阅读本节内容，完成该实践环节，在微信开发者工具中建立好一个已开通云开发的项目，再继续学习本节后续内容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用云开发建立数据库非常简单，微信官方的“小程序开发文档”有详细的图文教程，<strong>云开发数据库教程位置如下：</strong></p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;"><strong>入口网址：<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/getting-started.html">云开发数据库教程</a>，如果微信官方文档改版导致链接失效，请按图索骥。</strong></li>
<li style="font-size: 20px; line-height: 38px;"><strong>入口位置：在“小程序开发文档”的“云开发”栏目，如图 11 红框标出部分。</strong></li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 11 云开发数据教程位置</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d2075db0001ec1b14070845.png" alt="图片描述" data-original="http://img.mukewang.com/5d2075db0001ec1b14070845.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">按照云开发数据库教程 “上手” 小节介绍的操作步骤，我们首先建立一个数据库集合 <code>counters</code> ，完成规则 1 与规则 2 。</p>
</div><div class="cl-preview-section"><h2 id="云开发数据库操作" style="font-size: 30px;">3. 云开发数据库操作</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">数据库操作一般分为查询数据、插入数据、更新数据和删除数据。<strong>云开发的数据库操作在图11所示的教程中也有详细的讲解，请仔细阅读、学习。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">规则 3 描述了一条记录要包括用户 ID才能分别存储不同用户的访问次数数据。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过阅读云开发数据库教程 “权限管理”小节的内容，我们知道<strong>云开发数据库中的每一条记录都会自动带上该记录创建者（即小程序用户）的信息。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">所以在我们向数据库集合插入数据时，我们只需要插入打开页面次数 count 这一个信息，云开发数据库会自动加上用户 ID 信息（<strong>以 <code>_openid</code> 字段保存用户的 <code>openid</code> 在每个相应用户创建的记录中</strong>）。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">openid 是小程序中用户的唯一标识，每个微信用户都有不同的 openid 。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了实现规则 6 ，我们需要在 WXML 页面模板中添加一个交互界面：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>这是你第{{count}}次访问本页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">然后，在 JS 逻辑中设置一个数据 count , 用来向界面提供用户访问次数的数据：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 页面的初始数据
   */</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment">//用于显示的页面访问次数数据</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们还需要在 JS 逻辑的页面加载事件 onLoad 中定义一个函数 pageCounter ，当用户打开小程序页面时去云开发数据库中获取访问次数：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 生命周期函数--监听页面加载
   */</span>
  onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//当页面加载时，从数据库集合中获取用户的页面访问次数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pageCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>小程序页面的系统事件，请参阅微信官方“小程序开发文档”的<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html">“框架”-&gt;“框架接口”-&gt;“页面”-&gt;“Page”</a>小节。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">规则 4 与 规则 5 在函数 pageCounter 中具体实现：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 从数据库集合中获取用户的页面访问次数，并设置用于显示的页面访问次数数据
   */</span>
  pageCounter<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//语句含义见云开发数据库教程 “初始化” 小节</span>
    <span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">//语句含义见云开发数据库教程 “指令” 小节</span>
    <span class="token keyword">const</span> _ <span class="token operator">=</span> db<span class="token punctuation">.</span>command

    <span class="token comment">//语句含义见云开发数据库教程 “查询数据” 小节</span>
    db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'counters'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        
        <span class="token comment">//判断数据库中是否已有用户的页面访问次数记录，以决定执行规则 4 或 规则 5</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          
        <span class="token comment">//规则 5 ：当用户再次打开页面，该用户数据记录的 打开页面次数 加 1</span>
          
          <span class="token comment">//语句含义见云开发数据库教程 “更新数据” 小节</span>
          db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'counters'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              count<span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          
          <span class="token comment">//设置用于显示的页面访问次数数据</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            count<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 规则 4 ：当用户第一次打开页面，需要在数据库表中添加一条该用户打开页面次数的数据记录，</span>
        <span class="token comment">// 并设置打开页面的次数为 1</span>
          
          <span class="token comment">//语句含义见云开发数据库教程 “插入数据” 小节</span>
          db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'counters'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              count<span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          
          <span class="token comment">//设置用于显示的页面访问次数数据</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            count<span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在实现代码中详细写明了每一个云开发数据库操作语句的教程位置，请仔细阅读对应内容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">至此，我们就完成了页面访问计数功能的开发。完整源代码获取方式见本节 “5. 专栏源代码”。</p>
</div><div class="cl-preview-section"><h2 id="列表数据显示" style="font-size: 30px;">4. 列表数据显示</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来我们来看第二个实践内容：页面列表数据显示，如图 12 所示。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">图 12 页面列表数据显示 Demo</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d20768600011e9a04110738.png" alt="图片描述" data-original="http://img.mukewang.com/5d20768600011e9a04110738.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这个Demo展示了小程序应用中常用的滑动屏幕显示多条列表数据的功能。</p>
</div><div class="cl-preview-section"><h3 id="功能分析">4.1 功能分析</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">列表数据显示需要实现的功能点包括：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">功能点 1：当页面加载时，从云开发数据库中分页获取第一页数据；</li>
<li style="font-size: 20px; line-height: 38px;">功能点 2：当用户下滑屏幕到页面底部时，从云开发数据库中分页获取下一页数据；</li>
<li style="font-size: 20px; line-height: 38px;">功能点 3：当云开发数据库中所有数据都已经在页面上显示出来后，用户下滑屏幕将不再访问云开发数据库；</li>
<li style="font-size: 20px; line-height: 38px;">功能点 4：将从数据库中获取到的多条数据显示在页面中。</li>
</ul>
</div><div class="cl-preview-section"><h3 id="导入列表数据到数据库">4.2 导入列表数据到数据库</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">要实现这个功能，我们需要先准备好数据库中的数据。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">数据库数据位于专栏源代码的 <code>demo/pages/05_list_template/list_demo_data.json</code> 文件，各位同学可以在自己的云开发数据库中新建一个数据库集合 <code>list_demo</code> ，然后将数据导入到这个数据库集合。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如何在云开发数据库中导入数据请阅读图 11 所示的云开发数据库教程 “导入” 小节。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">**导入数据后请将数据库集合 <code>list_demo</code> 的“权限设置”修改为“所有用户可读，仅创建者可读写”。**设置方式请阅读云开发数据库教程 “权限管理”小节的内容。</p>
</div><div class="cl-preview-section"><h3 id="实现从数据库分页获取数据">4.3 实现从数据库分页获取数据</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从数据库分页获取数据的实现思路如下：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">首先定义每次获取多少条数据 <code>page_count</code> ；</li>
<li style="font-size: 20px; line-height: 38px;">再定义一个变量来记录页面已获取过几次数据 <code>list_index</code> ；</li>
<li style="font-size: 20px; line-height: 38px;">定义一个数据集合 <code>title_desc_array</code>  来保存从数据库中获取到的数据，同时这个数据集合向页面提供显示内容；</li>
<li style="font-size: 20px; line-height: 38px;">根据功能点 3 ，还需要定义一个标志 <code>is_no_more_data</code> , 来供程序判断是否云开发数据库中的所有数据都已经显示到页面中。</li>
</ul>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 页面的初始数据
   */</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    title_desc_array<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//分页获取到的数据集合，[]表示这是一个数组数据类型</span>
    list_index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//分页获取数据的当前页索引</span>
    page_count<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">//每次分页获取多少数据</span>
    is_no_more_data<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment">//记录是否已加载完所有分页数据</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">计算 <code>page_count</code> 乘以  <code>list_index</code> 的值  <code>offset</code> ，就可以知道我们已经获取过多少条数据，下次一获取数据应该从 <code>offset+1</code> 条开始；</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">每次获取到数据后，我们需要将  <code>list_index</code> 的值增加1，这样下次获取数据才会跳过本次已获取到的数据；</p>
<p style="font-size: 20px; line-height: 38px;">举例来说，当页面加载时， <code>page_count=5</code>  ， <code>list_index=0</code> ，所以  <code>offset=0</code>，从第 1 条数据开始获取，并在获取到数据后设置 <code>list_index=1</code> ；</p>
<p style="font-size: 20px; line-height: 38px;">当第二次获取数据时，  <code>page_count=5</code>  ， <code>list_index=1</code> ，所以  <code>offset=5</code>，从第 6 条数据开始获取，并在获取到数据后设置 <code>list_index=2</code> 。</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">在每次获取到数据后，我们需要将新获取到的数据放到数据集合 <code>title_desc_array</code>  的末尾，这样才能保证页面最底部的数据是最新获取的数据；</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">如果一次分页查询只返回了 0 行数据，说明云开发数据库中所有数据都已经获取完毕，我们应该设置 <code>is_no_more_data=true</code> ， 确保用户后续下滑屏幕到底部时将不再访问云开发数据库，避免对数据库的无谓请求。</p>
</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">有了以上思路，我们就可以写出分页获取数据库数据的函数了，完整函数如下：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 从云数据库分页获取数据
   */</span>
  <span class="token function">getTitleDescList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> db <span class="token operator">=</span> wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//计算已经获取过多少条数据</span>
    <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>list_index <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>page_count

    <span class="token keyword">var</span> query
    <span class="token comment">//skip和limit的传入参数必须大于0，</span>
    <span class="token comment">//因此此处需要对offset等于0（即当页面加载时，从云开发数据库中分页获取第一页数据）的情况进行特殊处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      query <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'list_demo'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>page_count<span class="token punctuation">)</span> <span class="token comment">// 限制返回数量为 page_count 条</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      query <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'list_demo'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token comment">// 跳过已经获取过的数据，从第 offset + 1 条开始返回</span>
        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>page_count<span class="token punctuation">)</span> <span class="token comment">// 限制返回数量为 page_count 条</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//执行云开发数据查询</span>
    query
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断本次查询是否没有获取到数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//使用数组的 concat 方法将新获取到的数据添加到数据集合末尾</span>
          <span class="token keyword">var</span> title_desc_array <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>title_desc_array
          title_desc_array <span class="token operator">=</span> title_desc_array<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">//更新数据集合，使页面显示新获取到的数据</span>
            title_desc_array<span class="token punctuation">:</span> title_desc_array<span class="token punctuation">,</span>
            <span class="token comment">//已获取过数据次数加1</span>
            list_index<span class="token punctuation">:</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>list_index
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果查询没有获取到数据，说明云开发数据库中所有数据都已经获取完毕</span>
          <span class="token comment">//设置数据全部加载完毕的标志</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            is_no_more_data<span class="token punctuation">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>请注意代码中关于 skip 和 limit 传入值的限制以及处理方式。</strong></p>
</div><div class="cl-preview-section"><h3 id="实现页面显示列表数据">4.4 实现页面显示列表数据</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在从云开发数据库获取到数据后，我们需要将它们显示在界面上。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这次我们要显示的数据跟以往不同，以往是显示一条数据，这次我们需要显示多条数据。这就需要用 WXML 页面模板的“列表渲染”语法。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">WXML 页面模板的语法主要包括单条数据的“数据绑定”，多条数据的“列表渲染”，以及显示隐藏界面的“条件渲染”。在微信官方的“小程序开发文档”中对 WXML 语法有详细解的讲解，请各位同学先阅读、理解官方内容后再继续阅读本节后续内容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>WXML 语法讲解的文档位置如下：</strong></p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;"><strong>入口网址：<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/">WXML 语法讲解</a>，如果微信官方文档改版导致链接失效，请按图索骥。</strong></li>
<li style="font-size: 20px; line-height: 38px;"><strong>入口位置：在“小程序开发文档”的“框架”栏目，如图 13 红框标出部分。</strong></li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 13 WXML 语法文档位置</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d2076c80001b5a512830793.png" alt="图片描述" data-original="http://img.mukewang.com/5d2076c80001b5a512830793.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在上一节介绍的 <strong>WeUI 中，有一个用于列表显示的组件 Panel</strong> ，使用它再结合 “列表渲染” 可以很简单地实现图 12 所示的列表显示效果：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel weui-panel_access<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel__bd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>block</span> <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{title_desc_array}}<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_id<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">wx:</span>for-item</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>title_desc<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-media-box weui-media-box_text<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-media-box__title weui-media-box__title_in-text<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{title_desc.title}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-media-box__desc<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{title_desc.description}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>block</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">此外，我们还需要在页面加载时，从云开发数据库中分页获取第一页数据。这需要在页面的 onReady 事件中调用在 4.3 中已编写好的分页获取数据函数 getTitleDescList ：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 生命周期函数--监听页面初次渲染完成
   */</span>
  onReady<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTitleDescList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="实现用户下滑屏幕到页面底部时刷新数据">4.5 实现用户下滑屏幕到页面底部时刷新数据</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">此时，我们还剩一下一个功能点需要实现：当用户下滑屏幕到页面底部时，从云开发数据库中分页获取下一页数据。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当用户下滑屏幕到页面底部，在小程序的页面中会触发一个事件 onReachBottom， 我们需要在这个事件中调用分页获取数据函数 getTitleDescList 。另外，我们还应该判断标志 <code>is_no_more_data</code> ，只有当未获取到所有数据的时候，才去数据库中获取新的数据。</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 页面滑动到达底部事件的处理函数
   */</span>
  onReachBottom<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>is_no_more_data<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//如果还有数据未加载完，则获取更多数据</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTitleDescList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">至此，我们就完成了页面列表数据显示功能的开发。完整源代码获取方式见本节“5. 专栏源代码”。</p>
</div><div class="cl-preview-section"><h2 id="专栏源代码" style="font-size: 30px;">5. 专栏源代码</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本专栏源代码已上传到 GitHub ，请访问以下地址获取：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><a href="https://github.com/liujiec/Membership-ECommerce-Miniprogram">https://github.com/liujiec/Membership-ECommerce-Miniprogram</a></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节源代码内容在图 14 红框标出的位置。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 14 本节源代码位置</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img src="http://img.mukewang.com/5d2077080001925407670543.png" alt="图片描述" data-original="http://img.mukewang.com/5d2077080001925407670543.png" class="" style="cursor: pointer;"></p>
</div><div class="cl-preview-section"><h2 id="下节预告" style="font-size: 30px;">下节预告</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一节，我们将讲解如何编写输入界面（即表单），如何提交表单，以及云开发中简洁的自动登录能力。</p>
</div><div class="cl-preview-section"><h2 id="实践环节" style="font-size: 30px;">实践环节</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">实践是通往大神之路的唯一捷径。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节实操内容：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;"><strong>使用云开发，编写代码完成图 10 、图 12 所示的页面，如碰到问题，请阅读本专栏源代码学习如何实现。</strong></li>
</ul>
</div></div>
            </div>
                            <!-- 买过的阅读 -->
                <div class="art-next-prev clearfix">
                                                                        <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/40/article/565">
                                                    <div class="prev l clearfix">
                                <div class="icon l">
                                    <i class="imv2-arrow3_l"></i>
                                </div>
                                <p>
                                    07 页面布局：使用组件让页面开发如此简单
                                </p>
                            </div>
                        </a>
                                                                                            <!-- 已买且开放 或者可以试读 -->
                            <a href="/read/40/article/567">
                                                    <div class="next r clearfix">
                                <p>
                                    09 云函数与表单校验组件让表单提交如此简单
                                </p>
                                <div class="icon r">
                                    <i class="imv2-arrow3_r"></i>
                                </div>

                            </div>
                        </a>
                                    </div>
                    </div>
        <div class="comments-con js-comments-con" id="coments_con">
        </div>



    </div>
    
    
    

</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>