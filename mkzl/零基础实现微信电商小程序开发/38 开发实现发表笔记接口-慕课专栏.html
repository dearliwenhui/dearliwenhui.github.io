<html><head><meta charset="utf-8"><title>38 开发实现发表笔记接口-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        38 开发实现发表笔记接口
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-09-18 17:47:33
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img3.mukewang.com/5d81fd220001c63306400360.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">知识犹如人体的血液一样宝贵。<p class="author">——高士其</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在开发 UGC 社区的页面之前，我们需要先实现发表笔记接口，然后开发发表笔记页面调用接口实现发表笔记功能，在实现发表笔记功能后 UGC 社区首页与笔记详情页面中才会有数据供显示。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节将实现发表笔记接口，发表笔记页面在下一节实现。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在前一节中，我们已经整理了发表笔记接口的功能，包括：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">小程序客户端：
<ul>
<li style="font-size: 20px; line-height: 38px;">如果用户有选择图片，读取每张图片的高度与宽度，然后上传每张图片到云开发的图片存储中</li>
<li style="font-size: 20px; line-height: 38px;">将用户选择的每张图片的高度、宽度、云开发中图片存储地址，用户输入的文字内容传递给云函数</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">云函数：
<ul>
<li style="font-size: 20px; line-height: 38px;">将用户输入的文字内容和选择的图片存储到笔记记录表中</li>
<li style="font-size: 20px; line-height: 38px;">在成长值获取记录表中记录用户发表笔记获得 1000 成长值</li>
<li style="font-size: 20px; line-height: 38px;">用户表中的用户当前总成长值增加 1000 成长值</li>
<li style="font-size: 20px; line-height: 38px;">调用成长值风控规则校验成长值记录是否有异常</li>
</ul>
</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据以上功能设计，我们可以整理出发表笔记接口的程序逻辑。</p>
</div><div class="cl-preview-section"><h2 id="小程序客户端程序逻辑" style="font-size: 30px;">1. 小程序客户端程序逻辑</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">由于用户发表的笔记包含图片，我们首先需要搞清楚两个问题：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;"><strong>如何实现用户从相册选择图片或打开相机拍照？</strong></p>
<p style="font-size: 20px; line-height: 38px;">通过阅读微信官方的 “小程序开发文档”，我们会发现小程序官方提供了丰富的媒体 API ，使用这些 API 可以调用微信的原生能力非常方便的实现图片、音频、视频等操作。</p>
<p style="font-size: 20px; line-height: 38px;"><strong>使用小程序的图片 API 就可以实现用户从相册选择图片或打开相机拍照</strong>，微信官方的 “小程序开发文档” 有详细的 图片 API 说明文档，<strong>文档位置如下：</strong></p>
<ul>
<li style="font-size: 20px; line-height: 38px;"><strong>入口网址：<a href="https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html">小程序图片 API 文档</a>，如果微信官方文档改版导致链接失效，请按图索骥。</strong></li>
<li style="font-size: 20px; line-height: 38px;"><strong>入口位置：在 “小程序开发文档” 的 “ API ” 栏目，如图 4 红框标出部分。</strong></li>
</ul>
<p style="font-size: 20px; line-height: 38px;"><strong>图 4 小程序图片 API 文档位置</strong></p>
</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d81fca20001289814050817.png" data-original="//img.mukewang.com/5d81fca20001289814050817.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>在微信官方的小程序示例中，对每个媒体 API 的具体使用都有 Demo 进行展示（在 Demo 底部 “接口” 菜单中），各位同学可以下载小程序示例源代码进行学习（源代码与 Demo 二维码请回顾第三章第一节 “2.4 使用小程序组件开发页面”）。</strong></p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;"><strong>用户的图片上传到哪里进行存储？</strong></p>
<p style="font-size: 20px; line-height: 38px;">除了云数据库和云函数之外，小程序云开发还提供了云存储的能力，<strong>用户的图片可以上传到云开发的云存储中</strong>。</p>
<p style="font-size: 20px; line-height: 38px;">使用云开发在云存储中保存图片很简单，微信官方的 “小程序开发文档” 有详细的说明文档，<strong>小程序客户端云存储 API 的说明文档位置如下：</strong></p>
<ul>
<li style="font-size: 20px; line-height: 38px;"><strong>入口网址：<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/storage/uploadFile.html">小程序客户端云存储 API 文档</a>，如果微信官方文档改版导致链接失效，请按图索骥。</strong></li>
<li style="font-size: 20px; line-height: 38px;"><strong>入口位置：在 “小程序开发文档” 的 “云开发” 栏目，如图 5 红框标出部分。</strong></li>
</ul>
<p style="font-size: 20px; line-height: 38px;"><strong>图 5 小程序客户端云存储文档位置</strong></p>
</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d81fcc0000101a313990962.png" data-original="//img.mukewang.com/5d81fcc0000101a313990962.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>请各位同学阅读完上述 2 个文档后再继续学习本节后续内容。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在详细阅读小程序图片 API 文档与云开发的云存储文档后，我们可以整理出小程序客户端的程序逻辑：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">输入参数</p>
<p style="font-size: 20px; line-height: 38px;">在发表笔记页面，我们会使用图片 API 的方法 <code>wx.chooseImage</code> 来让用户选择图片，在用户选择图片后该方法会返回用户选择的图片的本地临时文件路径列表 <code>tempFilePaths</code> ，这即是笔记的图片内容，我们可以定义输入参数 <code>imageList</code> 来接收图片内容 。</p>
<p style="font-size: 20px; line-height: 38px;">另外，用户输入的笔记文字内容也需要作为参数传递，我们可以定义输入参数 <code>content</code> 来接收文字内容 。</p>
<pre class=" language-js"><code class="prism  language-js">   <span class="token operator">*</span> @param <span class="token punctuation">{</span>string<span class="token punctuation">}</span> content 用户输入的笔记文字内容
   <span class="token operator">*</span> @param <span class="token punctuation">{</span>array<span class="token punctuation">}</span> imageList 用户选择的图片的本地临时文件路径列表
</code></pre>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">构造存入数据库的笔记数据结构</p>
<p style="font-size: 20px; line-height: 38px;">每条笔记包括文字内容和图片内容，图片内容是一个数组，里面每条记录为一张图片的信息，包括图片的高度、宽度和图片地址，在 UGC 首页以瀑布流的形式显示的笔记列表中需要图片的高度和宽度信息。</p>
<pre class=" language-js"><code class="prism  language-js">note <span class="token operator">=</span> <span class="token punctuation">{</span>
      content<span class="token punctuation">:</span> <span class="token punctuation">,</span> <span class="token comment">//用户输入的笔记文字内容</span>
      images<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token punctuation">,</span> <span class="token comment">//图片地址</span>
        width<span class="token punctuation">:</span> <span class="token punctuation">,</span> <span class="token comment">//图片宽度</span>
        height<span class="token punctuation">:</span> <span class="token comment">//图片高度          </span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">上传图片到云存储</p>
<p style="font-size: 20px; line-height: 38px;">笔记中可包含图片，也可不含图片。</p>
<p style="font-size: 20px; line-height: 38px;">如果笔记中不含图片，则直接调用云函数操作数据库。</p>
<p style="font-size: 20px; line-height: 38px;">如果笔记中包含图片，需要使用图片 API 的 <code>wx.getImageInfo</code> 获得每张图片的高度 <code>height</code> 与宽度 <code>width</code> ，然后调用云存储 API 的 <code>wx.cloud.uploadFile</code> 方法将每张图片上传到云存储，并设置图片地址 <code>url</code> 为云存储地址。</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">调用云函数操作数据库</p>
<p style="font-size: 20px; line-height: 38px;">调用云函数在云数据库中存储笔记数据及执行其他数据库操作。</p>
</li>
</ul>
</div><div class="cl-preview-section"><h2 id="云函数程序逻辑" style="font-size: 30px;">2. 云函数程序逻辑</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">云函数的主要程序逻辑是数据库操作，具体程序逻辑为：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">输入参数</p>
<p style="font-size: 20px; line-height: 38px;">云函数的输入参数包括笔记的文字内容 <code>content</code> 和已上传到云存储的图片内容 <code>images</code>。</p>
<pre class=" language-js"><code class="prism  language-js"> <span class="token operator">*</span> @param <span class="token punctuation">{</span>data<span class="token punctuation">}</span> 要发表的笔记内容
 <span class="token operator">*</span> <span class="token punctuation">{</span>
 <span class="token operator">*</span>    data<span class="token punctuation">:</span><span class="token punctuation">{</span>
 <span class="token operator">*</span>      content<span class="token punctuation">,</span>   <span class="token comment">//文字内容</span>
 <span class="token operator">*</span>      images     <span class="token comment">//已上传到云存储的图片内容</span>
 <span class="token operator">*</span>    <span class="token punctuation">}</span>
 <span class="token operator">*</span>  <span class="token punctuation">}</span>
</code></pre>
<p style="font-size: 20px; line-height: 38px;">用户的 OpenID 可以直接使用云函数的 <code>cloud.getWXContext()</code> 得到。</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">从用户表 <code>user</code> 中获取用户当前总成长值 <code>growthValue</code></p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">向笔记信息表 <code>user_note</code> 中插入一条新记录，记录用户发表的笔记信息（content、images、发表时间等）</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">向成长值获取记录表 <code>user_growth_value</code> 中插入一条新记录，记录用户发表笔记获得的成长值信息（发表一篇笔记获得 1000 成长值）</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">计算用户发表笔记后新的用户当前总成长值 <code>newGrowthValue</code> = 用户原当前总成长值 <code>growthValue</code> + 1000</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">在用户表 <code>user</code> 中更新用户的当前总成长值为 <code>newGrowthValue</code></p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">调用在第五章第五节已实现的用户成长体系风控规则云函数 <code>growthValueRiskControl</code>，校验数据库 <code>user_growth_value</code> 中该用户的成长值记录是否有异常</p>
</li>
</ul>
</div><div class="cl-preview-section"><h2 id="发表笔记接口代码实现" style="font-size: 30px;">3. 发表笔记接口代码实现</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>如还未在云数据库中创建笔记信息表 <code>user_note</code> 的同学，请先在云数据中新建该表。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据已经整理出的输入输出参数与程序逻辑，我们就可以新建发表笔记的数据库操作云函数 <code>postNote</code> ，然后在 index.js 中实现程序逻辑：</p>
</div><div class="cl-preview-section"><pre class=" language-js"><code class="prism  language-js"><span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wx-server-sdk'</span><span class="token punctuation">)</span>

<span class="token comment">// 初始化 cloud</span>
cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> _ <span class="token operator">=</span> db<span class="token punctuation">.</span>command

<span class="token comment">//发表笔记获得的成长值</span>
<span class="token keyword">const</span> NOTEADDGROWTHVALUE <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">// 云函数入口函数</span>
<span class="token comment">/**
 * 发表笔记
 * @param {data} 要发表的笔记内容
 * {
 *    data:{
 *      content,   //文字内容
 *      images     //[] 已上传到云存储的图片内容数组
 *    }
 *  }
 * @return {object} 结果 
 * { 
 *    data,    //bool 发表笔记成功或失败
 *    errMsg   //如果发表笔记失败，该字段包含具体错误信息
 * }
 */</span>
exports<span class="token punctuation">.</span>main <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wxContext <span class="token operator">=</span> cloud<span class="token punctuation">.</span><span class="token function">getWXContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//设置默认返回值</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">var</span> errMsg <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token comment">//读取用户信息</span>
  <span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">//云函数是在服务端操作，对所有用户的数据都有操作权限</span>
      <span class="token comment">//在云函数中查询用户数据，需要添加openid的查询条件</span>
      _openid<span class="token punctuation">:</span> wxContext<span class="token punctuation">.</span>OPENID
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token comment">//向笔记信息表中插入一条新记录，记录用户发表的笔记信息</span>
  <span class="token comment">//插入记录后获得插入的笔记 ID</span>
  <span class="token keyword">var</span> noteId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'user_note'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        _openid<span class="token punctuation">:</span> wxContext<span class="token punctuation">.</span>OPENID<span class="token punctuation">,</span> <span class="token comment">//云函数添加数据不会自动插入openid，需要手动定义</span>
        date<span class="token punctuation">:</span> db<span class="token punctuation">.</span><span class="token function">serverDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//发表笔记时间</span>
        content<span class="token punctuation">:</span> event<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token comment">//笔记文字内容</span>
        images<span class="token punctuation">:</span> event<span class="token punctuation">.</span>images<span class="token punctuation">,</span> <span class="token comment">//笔记图片内容</span>
        upvoteNum<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">//点赞数，笔记发表时为0</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_id
  <span class="token comment">//向成长值获取记录表中插入一条新记录，记录用户发表笔记获得的成长值信息</span>
  <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'user_growth_value'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        _openid<span class="token punctuation">:</span> wxContext<span class="token punctuation">.</span>OPENID<span class="token punctuation">,</span> <span class="token comment">//云函数添加数据不会自动插入openid，需要手动定义</span>
        date<span class="token punctuation">:</span> db<span class="token punctuation">.</span><span class="token function">serverDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//获取成长值时间</span>
        changeGrowthValue<span class="token punctuation">:</span> NOTEADDGROWTHVALUE<span class="token punctuation">,</span> <span class="token comment">//获得的成长值</span>
        operation<span class="token punctuation">:</span> <span class="token string">"发表笔记"</span><span class="token punctuation">,</span> <span class="token comment">//成长值来源</span>
        timestamp<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        orderId<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        noteId<span class="token punctuation">:</span> noteId <span class="token comment">//对应的笔记 ID</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//用户发表笔记后新的用户当前总成长值</span>
  <span class="token keyword">var</span> newGrowthValue <span class="token operator">=</span> user<span class="token punctuation">.</span>growthValue <span class="token operator">+</span> NOTEADDGROWTHVALUE
  <span class="token comment">//在用户表中更新用户的当前总成长值</span>
  <span class="token keyword">var</span> updateUserResult <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">//云函数是在服务端操作，对所有用户的数据都有操作权限</span>
      <span class="token comment">//在云函数中查询用户数据，需要添加openid的查询条件</span>
      _openid<span class="token punctuation">:</span> wxContext<span class="token punctuation">.</span>OPENID
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        growthValue<span class="token punctuation">:</span> newGrowthValue <span class="token comment">//新的用户当前总成长值</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateUserResult<span class="token punctuation">.</span>stats<span class="token punctuation">.</span>updated <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//调用用户成长体系风控规则云函数，校验用户的成长值记录是否有异常</span>
    <span class="token keyword">await</span> cloud<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token string">'growthValueRiskControl'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        openid<span class="token punctuation">:</span> wxContext<span class="token punctuation">.</span>OPENID
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    errMsg <span class="token operator">=</span> <span class="token string">"系统异常，如有疑问请联系客服"</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//返回数据库操作结果</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> result<span class="token punctuation">,</span>
    errMsg<span class="token punctuation">:</span> errMsg
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据已经整理出的小程序客户端程序逻辑，我们可以新建一个数据服务文件 <code>NoteService.js</code>，在其中定义笔记信息表的数据服务 <code>NoteService</code> ，然后在 <code>NoteService</code> 中实现供发表笔记页面调用的发表笔记接口 <code>postNote</code>（上传图片到云存储、调用云函数操作数据库）：</p>
</div><div class="cl-preview-section"><pre class=" language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 添加用户笔记到数据库
   * @method postNote
   * @for NoteService
   * @param {string} content 笔记文字
   * @param {array} imageList 笔记图片地址列表（即wx.chooseImage的返回值tempFilePaths）
   * @param {function} successCallback() 处理数据查询结果的回调函数
   */</span>
  <span class="token function">postNote</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> imageList<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//构造存入数据库的图片信息数据结构，包括图片的高度、宽度和图片地址</span>
    <span class="token keyword">var</span> images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token keyword">in</span> imageList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      images<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> imageList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        width<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//构造笔记的数据格式</span>
    <span class="token keyword">var</span> note <span class="token operator">=</span> <span class="token punctuation">{</span>
      content<span class="token punctuation">:</span> content<span class="token punctuation">,</span>
      images<span class="token punctuation">:</span> images
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>images<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果笔记中包含图片，获取图片的宽度和高度并上传图片到云存储</span>
      <span class="token comment">//使用递归调用方法来完成每张图片的处理</span>
      <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//从第一张图片开始处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addImage</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> note<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果不包含图片，直接调用云函数添加笔记到数据库</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addNote</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 私有方法-上传图片到云开发图片存储-递归调用
   * @method _addImage
   * @for NoteService
   * @param {string} index 当前上传图片的数组序号
   * @param {object} note 笔记
   * @param {function} successCallback() 处理数据查询结果的回调函数
   */</span>
  <span class="token function">_addImage</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> note<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//调用图片 API 获取图片的高度宽度信息</span>
    wx<span class="token punctuation">.</span><span class="token function">getImageInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      src<span class="token punctuation">:</span> note<span class="token punctuation">.</span>images<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token comment">//图片 API 调用成功的回调函数</span>
      <span class="token function">success</span><span class="token punctuation">(</span>imageInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        note<span class="token punctuation">.</span>images<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>width <span class="token operator">=</span> imageInfo<span class="token punctuation">.</span>width
        note<span class="token punctuation">.</span>images<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>height <span class="token operator">=</span> imageInfo<span class="token punctuation">.</span>height
        <span class="token comment">//调用云存储 API 上传图片到云存储</span>
        wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          cloudPath<span class="token punctuation">:</span> <span class="token string">'user/note/images/'</span> <span class="token operator">+</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>openid <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token comment">//云存储路径</span>
          filePath<span class="token punctuation">:</span> note<span class="token punctuation">.</span>images<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token comment">// 图片本地路径</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//图片上传成功后的操作</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          note<span class="token punctuation">.</span>images<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>url <span class="token operator">=</span> res<span class="token punctuation">.</span>fileID <span class="token comment">//修改图片URL为云存储地址</span>
          <span class="token comment">//判断当前处理的图片是否为最后一张图片</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> note<span class="token punctuation">.</span>images<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果还有图片，继续递归调用，上传下一张图片到云存储</span>
            that<span class="token punctuation">.</span><span class="token function">_addImage</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> note<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果图片已全部上传到云存储，调用云函数添加笔记到数据库</span>
            that<span class="token punctuation">.</span><span class="token function">_addNote</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//云存储 API 出错处理</span>
        <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//跳转出错页面</span>
          wx<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">:</span> <span class="token string">'../../errorpage/errorpage'</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">//图片 API 出错处理</span>
      <span class="token function">fail</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//跳转出错页面</span>
        wx<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          url<span class="token punctuation">:</span> <span class="token string">'../../errorpage/errorpage'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 私有方法-发表笔记到云开发数据库
   * @method _addNote
   * @for NoteService
   * @param {object} note 笔记
   * @param {function} successCallback() 处理数据查询结果的回调函数
   */</span>
  <span class="token function">_addNote</span><span class="token punctuation">(</span>note<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//调用云函数执行发表笔记操作</span>
    wx<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token string">'postNote'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        content<span class="token punctuation">:</span> note<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        images<span class="token punctuation">:</span> note<span class="token punctuation">.</span>images
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>result<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//回调函数处理数据查询结果</span>
          <span class="token keyword">typeof</span> successCallback <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">successCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//云函数返回结果为添加笔记失败，跳转出错页面</span>
          wx<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">:</span> <span class="token string">'../../errorpage/errorpage'</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fail<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//云函数执行出错，跳转出错页面</span>
        wx<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          url<span class="token punctuation">:</span> <span class="token string">'../../errorpage/errorpage'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>请注意公有方法与私有方法在 JS 中的命名区别。</strong></p>
</div><div class="cl-preview-section"><h2 id="专栏源代码" style="font-size: 30px;">4. 专栏源代码</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本专栏源代码已上传到 GitHub ，请访问以下地址获取：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><a href="https://github.com/liujiec/Membership-ECommerce-Miniprogram">https://github.com/liujiec/Membership-ECommerce-Miniprogram</a></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节源代码内容在图 6 红框标出的位置。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 6 本节源代码位置</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d81fcf6000117b507750699.png" data-original="//img.mukewang.com/5d81fcf6000117b507750699.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><h2 id="下节预告" style="font-size: 30px;">下节预告</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一节，我们将调用本节编写的发表笔记接口实现发表笔记页面。</p>
</div><div class="cl-preview-section"><h2 id="实践环节" style="font-size: 30px;">实践环节</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">实践是通往大神之路的唯一捷径。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节实操内容：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;"><strong>编写代码完成发表笔记接口，如碰到问题，请阅读本专栏源代码学习如何实现。</strong></li>
</ul>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/40/article/596">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            37 UGC 社区功能与数据库设计
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/40/article/598">
                                                                    <div class="next r clearfix">
                                        <p>
                                            39 发个朋友圈：开发实现发表笔记页面
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img3.mukewang.com/5d5a70850001363505400600.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课前端核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">1907191830328156</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：722466314</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=5l9EFfc" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>