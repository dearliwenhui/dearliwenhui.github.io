<html><head><meta charset="utf-8"><title>33 让用户掏钱：开发实现商城商品详情页面-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        33 让用户掏钱：开发实现商城商品详情页面
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-09-04 13:57:17
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img4.mukewang.com/5d6b59840001836a06400360.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">为中华之崛起而读书。<p class="author">——周恩来</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们在上一节实现了商城支付接口，本节将实现商品详情的展示，并调用支付接口完成商品购买流程。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在第二节中，我们已经设计了商品详情的页面效果，完整的商品详情页面如图 14 所示。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 14 商品详情页面</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d6b5e400001465d03491600.jpg" data-original="//img.mukewang.com/5d6b5e400001465d03491600.jpg" alt="图片描述"></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">接下来，我们根据业务设计、功能设计和页面效果图，按照 “分类拆解法” 的步骤实现商品详情页面。</p>
</div><div class="cl-preview-section"><h2 id="拆解步骤" style="font-size: 30px;">1. 拆解步骤</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>在本节仅给出拆解结果，拆解过程请回顾第二章第三节对 “分类拆解法” 的详细讲解内容。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>请各位同学自己动手实践，按照拆解步骤拆解，结合第一节的业务设计、第二节的功能设计，拆解本节图 14 的商品详情页面，然后将自己的拆解结果与本节列出的拆解结果进行对照总结。这是本节内容的实践环节之一。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">商品详情页面可以由上到下拆解为 8 个子部件，具体拆解结果如下：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 1 ：商品大图栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 1 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">商品大图</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面、无事件、数据为商品信息的封面大图字段</p>
<p style="font-size: 20px; line-height: 38px;">商品大图水平居中显示</p>
<p style="font-size: 20px; line-height: 38px;">商品信息在页面加载时，通过其他页面跳转到商品详情页面时传递的商品 ID 从云数据库的商品信息表中获取</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 2 ：商品价格栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 2 的数据包括商品信息（价格字段）、用户信息（当前总成长值字段、付费会员到期时间字段）、用户等级与等级特权表</p>
<p style="font-size: 20px; line-height: 38px;">子部件 2 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">非付费会员商品折扣价</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件</p>
<p style="font-size: 20px; line-height: 38px;">如果用户不是付费会员（付费会员到期时间小于当前时间），且用户等级有购物折扣（等级 1 用户没有购物折扣特权）时，显示非付费会员商品折扣价，折扣价 = 商品原价 * 用户当前等级享受的购物折扣率</p>
<p style="font-size: 20px; line-height: 38px;">非付费会员商品折扣价同时显示折扣价与原价，分两行显示：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">第一行，折扣价放大红字显示，左边有红底白字的 “限时特价” 标记</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">第二行，原价灰色删除线显示</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">付费会员商品折扣价</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件</p>
<p style="font-size: 20px; line-height: 38px;">如果用户是付费会员（付费会员到期时间大于等于当前时间），显示付费会员商品折扣价，折扣价 = 商品原价 * 付费会员享受的购物折扣率</p>
<p style="font-size: 20px; line-height: 38px;">付费会员商品折扣价同时显示折扣价与原价，分两行显示：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">第一行，折扣价放大红字显示，左边有红底白字的 “会员专享价” 标记</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">第二行，原价灰色删除线显示</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">商品原价</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件</p>
<p style="font-size: 20px; line-height: 38px;">如果用户不是付费会员（付费会员到期时间小于当前时间），且用户等级没有购物折扣 （等级 1 用户没有购物折扣特权）时，仅显示商品原价</p>
<p style="font-size: 20px; line-height: 38px;">商品原价左边有红底白字的 “限时特价” 标记，商品原价放大红字显示</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 3 ：付费会员促销栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 3 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">小 M 卡会员专享价</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，事件为用户点击事件，数据为商品原价、付费会员商品折扣价</p>
<p style="font-size: 20px; line-height: 38px;">小 M 卡会员专享价仅在用户不是付费会员（付费会员到期时间小于当前时间）时显示</p>
<p style="font-size: 20px; line-height: 38px;">小 M 卡会员专享价的显示内容包括：</p>
<p style="font-size: 20px; line-height: 38px;">左侧第一行，放大红字显示付费会员商品折扣价</p>
<p style="font-size: 20px; line-height: 38px;">左侧第二行，推广文案 “开卡仅 p20000，此商品省 pXXXX” （XXXX 为商品原价 - 付费会员商品折扣价）</p>
<p style="font-size: 20px; line-height: 38px;">右侧 “开通会员” 引导标记</p>
<p style="font-size: 20px; line-height: 38px;">用户点击事件的事件响应为，页面跳转到付费会员首页面</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 4 ：商品简介栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 4 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">商品名称</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件，数据为商品信息的书名与作者字段</p>
<p style="font-size: 20px; line-height: 38px;">书名第一行黑色大字体显示，作者第二行灰色小字体显示</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">商品描述</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件，数据为商品信息的本书简介字段</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 5 ：商品目录栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 5 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">标题</p>
<p style="font-size: 20px; line-height: 38px;">静态界面，无事件，无数据</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">提示</p>
<p style="font-size: 20px; line-height: 38px;">静态界面，无事件，无数据</p>
<p style="font-size: 20px; line-height: 38px;">红色字体显示提示 “购买后即可查看目录”</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 6 ：商品详情栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 6 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">标题</p>
<p style="font-size: 20px; line-height: 38px;">静态界面，无事件，无数据</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">作品特色</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件，数据为商品信息的本书特色字段</p>
<p style="font-size: 20px; line-height: 38px;">第一行黑色大字体显示 “作品特色”，第二行显示本书特色字段内容</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">作者介绍</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，无事件，数据为商品信息的作者介绍字段</p>
<p style="font-size: 20px; line-height: 38px;">第一行黑色大字体显示 “作者介绍”，第二行显示作者介绍字段内容</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 7 ：相关商品栏</p>
<p style="font-size: 20px; line-height: 38px;">子部件 7 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">商品列表</p>
<p style="font-size: 20px; line-height: 38px;">多条数据的交互界面，事件为用户屏幕滑动事件与用户点击屏幕事件，数据为：与当前商品属于同一分类的商品信息数组</p>
<p style="font-size: 20px; line-height: 38px;">在页面加载时，从商品信息表中查找商品分类与当前商品相同的商品信息列表</p>
<p style="font-size: 20px; line-height: 38px;">用户下滑屏幕到页面底部事件的事件响应为：从商品信息表中分页获取相同分类的下一页商品信息数据，并追加到商品信息数组末尾。如果商品信息表中相同分类的所有数据都获取完毕，用户下滑屏幕将不再获取分页数据</p>
<p style="font-size: 20px; line-height: 38px;">商品信息数组中的商品数据以左右两列卡片式瀑布流的方式显示，一个卡片显示一个商品信息，每个卡片显示商品的缩略图、商品名称（黑色）、商品简介（灰色）、商品原价（红色）</p>
<p style="font-size: 20px; line-height: 38px;">用户点击屏幕事件的事件响应为：在用户点击商品卡片后，页面跳转到商品详情页面，需要向商品详情页面传递商品 ID</p>
<p style="font-size: 20px; line-height: 38px;">商品信息表的数据需要从云数据库中获取</p>
</li>
</ul>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">子部件 8 ：底部操作栏</p>
<p style="font-size: 20px; line-height: 38px;">底部操作栏固定在页面底部显示，不随屏幕滑动变化</p>
<p style="font-size: 20px; line-height: 38px;">子部件 8 的显示元素包括：</p>
<ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">首页按钮</p>
<p style="font-size: 20px; line-height: 38px;">静态界面，事件为用户点击事件，无数据</p>
<p style="font-size: 20px; line-height: 38px;">按钮包含图标和文字</p>
<p style="font-size: 20px; line-height: 38px;">用户点击事件的事件响应为：页面跳转到商城首页</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">购物车按钮</p>
<p style="font-size: 20px; line-height: 38px;">单条内容交互界面，事件为用户点击事件，数据为微信客户端的购物车缓存</p>
<p style="font-size: 20px; line-height: 38px;">按钮包含图标和文字，如果微信客户端的购物车缓存中有商品，则在该按钮上显示缓存中的商品数量，数字在图标的右上角用红色标记显示</p>
<p style="font-size: 20px; line-height: 38px;">用户点击事件的事件响应为：页面跳转到购物车页面</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">加入购物车按钮</p>
<p style="font-size: 20px; line-height: 38px;">静态界面，事件为用户点击事件，无数据</p>
<p style="font-size: 20px; line-height: 38px;">用户点击事件的事件响应为：将当前商品信息加入微信客户端的购物车缓存中，提示用户加入购物车成功，并更新购物车按钮右上角的数字</p>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">购买商品按钮</p>
<p style="font-size: 20px; line-height: 38px;">静态界面，事件为用户点击事件，无数据</p>
<p style="font-size: 20px; line-height: 38px;">用户点击事件的事件响应为：调用服务端的支付接口，并在页面中显示支付接口返回的支付结果</p>
<p style="font-size: 20px; line-height: 38px;">用户购买商品要支付的积分为子部件 2 中放大红字显示的价格</p>
</li>
</ul>
</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">除上述的 8 个子部件外，与第七章第四节类似，我们还需要两个子部件用于显示支付结果：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">子部件 9 ：显示支付成功结果</li>
<li style="font-size: 20px; line-height: 38px;">子部件 10 ：显示支付失败结果</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">此外，在专栏的源代码中还设计了一个购买后的环节：当用户未购买商品时，无法查看目录；当用户已购买商品后，在商品详情页面中不再显示商品价格栏、付费会员促销栏和底部菜单栏，而显示商品的详细目录。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，还需要一个子部件来显示购买后的商品详情：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">子部件 11 ：显示购买后的商品详情</li>
</ul>
</div><div class="cl-preview-section"><h2 id="数据服务" style="font-size: 30px;">2. 数据服务</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">商品详情页面需要从商品信息表根据商品 ID 获取商品信息，需要从商品信息表获取与当前商品分类一致的商品信息列表，还需要从商品购买记录表中查询用户是否已购买商品。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据分类获取商品列表的数据服务已在本章第三节中实现。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据商品 ID 获取商品信息的数据服务需要在 ProductService.js 的 <code>ProductService</code> 类中添加一个方法 <code>getProductByIndex</code> 来实现：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 根据商品 ID 从商品信息表获取商品信息
   * @method getProductByIndex
   * @for ProductService
   * @param {string}} index 商品 ID
   * @param {function} successCallback(product) 处理数据查询结果的回调函数
   * product示例数据：
   *  {
   *    index: "2599",
   *    bookname: "Python深度学习",
   *    author: "[美]弗朗索瓦•肖莱...",
   *    price: "119.00",
   *    desc: "本书由Keras之父...",
   *    feature: "“本书在当前的...",
   *    authorinfo: "【作者简介】...",
   *    firstcategory: "计算机",
   *    secondcategory: "",
   *    thirdcategory: "",
   *    coverimg: "cloud://xxx",
   *    smallcoverimg: "cloud://xxx",
   *    catelog: [{
   *      name: "前言",
   *      index: "23171"
   *    },],
   *    smallcoverimgwidth: 231,
   *    smallcoverimgheight: 290,
   *    coverimgwidth: 700,
   *    coverimgheight: 879
   *  }
   */</span>
  <span class="token function">getProductByIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> successCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//执行数据库查询</span>
    db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'product'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        index<span class="token punctuation">:</span> index
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//回调函数处理数据查询结果</span>
          <span class="token keyword">typeof</span> successCallback <span class="token operator">==</span> <span class="token string">"function"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">successCallback</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//在商品信息表中没有查找到商品 ID 对应的商品信息时，不应该显示商品详情页面，而应该跳转出错页面</span>
          wx<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            url<span class="token punctuation">:</span> <span class="token string">'../../errorpage/errorpage'</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//访问数据库失败 的 系统异常处理</span>
        <span class="token comment">//跳转出错页面</span>
        wx<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          url<span class="token punctuation">:</span> <span class="token string">'../../errorpage/errorpage'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>当方法返回值是一个对象时，建议在方法返回值的注释中编写对象的示例，方便自己或其他人在调用该方法时能快速明白该方法的用法，如上述代码所示。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从商品购买记录表中查询用户是否已购买商品，需要新建一个数据服务 <code>PaidService</code>  提供 <code>getPaidInfo</code> 方法，该方法请各位同学自行编写代码实现，具体实现代码可参考专栏源代码的 <code>PaidService.js</code> 文件，具体代码位置见本节末尾图 15。</p>
</div><div class="cl-preview-section"><h2 id="编程步骤" style="font-size: 30px;">3. 编程步骤</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在商品详情页面实现支付结果显示，需要在显示支付结果子部件时隐藏其他子部件，即：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">显示子部件 1 - 8 时隐藏子部件 9 、子部件 10、子部件 11</li>
<li style="font-size: 20px; line-height: 38px;"> 显示子部件 9 时隐藏子部件 1 - 8 与子部件 10、子部件 11</li>
<li style="font-size: 20px; line-height: 38px;"> 显示子部件 10 时隐藏子部件 1 - 8 与子部件 9、子部件 11</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，我们需要两个标志 <code>showPaySuccess</code>  和 <code>showPayFaild</code> 来控制显示哪些子部件。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">同时还需要一个标志 <code>isPaid</code> 来控制用户打开已购买商品的商品详情页面，只显示子部件 11，隐藏其他子部件。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从数据库读取用户、商品信息等需要一定时间，还需要一个从数据库获取完数据的标志 <code>inited</code> ，当从数据库获取到数据后再显示页面。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">子部件 3 ：付费会员促销栏仅在用户不是小 M 卡会员时显示，因此需要一个数据标志 <code>isMembershipExpired</code> 来标识用户是否小 M 卡会员。</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    showPaySuccess<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//是否显示支付成功结果</span>
    showPayFaild<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//是否显示支付失败结果</span>
    isPaid<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//用户是否已购买该商品</span>
    inited<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//是否已从数据库读取数据</span>
    isMembershipExpired<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//用户是否是小M卡会员（还在会员有效期中）</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">由于商品详情页需要读取的数据较多，且页面各子部件隐藏显示的逻辑较复杂，我们应该首先理清数据读取的顺序与读取内容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">数据内容包括：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    myInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//用户信息，在支付时需要根据当前可用积分判断用户是否有足够积分购买商品</span>
    price<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//商品原价</span>
    discount<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//用户会员等级或小M卡会员对应的折扣率</span>
    discountedPrice<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//用户实际支付的商品价格</span>
    membershipPrice<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//用于子部件 3 ：付费会员促销栏显示的付费会员商品折扣价</span>
    productInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//商品信息</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">数据读取的顺序为：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">无论用户是否购买商品，都需要显示商品的详细信息，因此首先读取的数据应该是商品信息：</p>
<pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 生命周期函数--监听页面加载
   */</span>
  onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从数据库读取数据，options.index为页面跳转时传递的商品 ID</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getProductByIndex</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
      
  <span class="token comment">/**
   * 从商品信息表查询商品 ID 对应的商品信息
   */</span>
  <span class="token function">getProductByIndex</span><span class="token punctuation">(</span>productIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//调用数据服务获取商品信息</span>
    productService<span class="token punctuation">.</span><span class="token function">getProductByIndex</span><span class="token punctuation">(</span>
      productIndex<span class="token punctuation">,</span>
      <span class="token comment">//回调函数</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//设置商品数据</span>
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          productInfo<span class="token punctuation">:</span> productInfo<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//查询用户是否已购买商品</span>
        that<span class="token punctuation">.</span><span class="token function">getPaidInfo</span><span class="token punctuation">(</span>productIndex<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">第二步需要读取的是用户是否已购买该商品的信息，如果用户已购买该商品则只显示子部件 11 ，因此不需要再计算商品价格：</p>
<pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 从商品购买记录表中查询用户是否已购买商品
   */</span>
  <span class="token function">getPaidInfo</span><span class="token punctuation">(</span>productIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//调用数据服务获取用户购买商品记录</span>
    paidService<span class="token punctuation">.</span><span class="token function">getPaidInfo</span><span class="token punctuation">(</span>
      productIndex<span class="token punctuation">,</span>
      <span class="token comment">//回调函数</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span>paidInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>paidInfo<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果在商品购买记录表中查询到购买记录，显示已购买界面</span>
          that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            isPaid<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">//设置用户已购买商品标志</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token comment">//如果用户还未购买商品，则需要计算商品价格信息</span>
          that<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre>
</li>
<li style="font-size: 20px; line-height: 38px;">
<p style="font-size: 20px; line-height: 38px;">如果用户未购买商品，则需要读取用户信息计算用户享受的折扣率，并计算用户实际支付价格：</p>
<pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 根据用户等级与是否付费会员计算商品价格信息
   */</span>
  <span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//调用数据服务获取用户的用户等级与付费会员有效期</span>
    levelService<span class="token punctuation">.</span><span class="token function">getLevelList</span><span class="token punctuation">(</span>
      <span class="token comment">//获取成长体系中的所有成长等级回调函数</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span>levelList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> levels <span class="token operator">=</span> levelList
        userService<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>
          <span class="token comment">//获取用户信息回调函数</span>
          <span class="token keyword">function</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> myInfo <span class="token operator">=</span> userinfo
            <span class="token comment">//获取用户等级</span>
            <span class="token keyword">var</span> myLevel <span class="token operator">=</span> levels<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> e<span class="token punctuation">.</span>minGrowthValue <span class="token operator">&lt;=</span> myInfo<span class="token punctuation">.</span>growthValue <span class="token operator">&amp;&amp;</span> myInfo<span class="token punctuation">.</span>growthValue <span class="token operator">&lt;=</span> e<span class="token punctuation">.</span>maxGrowthValue<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment">//根据付费会员有效期计算用户是否是小M卡会员</span>
            <span class="token keyword">var</span> isMembershipExpired <span class="token operator">=</span> myInfo<span class="token punctuation">.</span>memberExpDate <span class="token operator">&lt;</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//设置用户是否是小M卡会员的标志</span>
            that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              myInfo<span class="token punctuation">:</span> myInfo<span class="token punctuation">,</span>
              isMembershipExpired<span class="token punctuation">:</span> isMembershipExpired<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMembershipExpired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//如果用户是在有效期的小M卡会员，设置小M卡会员折扣</span>
              that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                discount<span class="token punctuation">:</span> MEMBERSHIPDISCOUNT
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>myLevel<span class="token punctuation">.</span>bonus<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//如果用户不是小M卡会员，设置用户当前等级对应的折扣</span>
              that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                discount<span class="token punctuation">:</span> myLevel<span class="token punctuation">.</span>bonus<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>discount
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设置商品价格数据</span>
            that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              price<span class="token punctuation">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>productInfo<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token comment">//根据折扣计算商品折扣价</span>
              discountedPrice<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>productInfo<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">*</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>discount<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token comment">//用于子部件 3 ：付费会员促销栏显示的付费会员商品折扣价</span>
              membershipPrice<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>productInfo<span class="token punctuation">.</span>price<span class="token punctuation">)</span> <span class="token operator">*</span> MEMBERSHIPDISCOUNT<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">//在读取完所有数据后，设置从数据库读取数据完成标志</span>
            that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              inited<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">//在用户未购买该商品时，需要显示子部件 7 ：相关商品栏的第一页分页数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>isPaid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              that<span class="token punctuation">.</span><span class="token function">getProductList</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>请参照前面章节的内容自行添加数据服务引用。</strong></p>
</div><div class="cl-preview-section"><h3 id="定义页面子部件及其排列顺序">3.1 定义页面子部件及其排列顺序</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 WXML 页面模板中我们需要定义在什么条件下显示哪些子部件：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- 当从数据库读取到数据后，用户未购买该商品，并且不显示支付结果时，才显示子部件 1 - 8 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{inited &amp;&amp; !showPaySuccess &amp;&amp; !showPayFaild &amp;&amp; !isPaid}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bg-white<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 子部件 1 ：商品大图栏 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 子部件 2 ：商品价格栏 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>padding-lr padding-bottom-sm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子部件 3 ：付费会员促销栏 当用户不是小M卡会员时才显示 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{isMembershipExpired}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel weui-panel_access<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子部件 4 ：商品简介栏 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子部件 5 ：商品目录栏 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子部件 6 ：商品详情栏 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子部件 7 ：相关商品栏 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子部件 8 ：底部操作栏 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cu-bar bg-white tabbar border shop bottom_pay_button<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 当支付接口返回支付成功时，显示支付成功结果 --&gt;</span>
<span class="token comment">&lt;!-- 子部件 9 ：显示支付成功结果 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{showPaySuccess}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-msg bg-white padding<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 当支付接口返回支付失败时，显示支付失败结果 --&gt;</span>
<span class="token comment">&lt;!-- 子部件 10 ：显示支付失败结果 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{showPayFaild}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-msg bg-white padding<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 如用户已购买该商品，则显示购买后界面 --&gt;</span>
<span class="token comment">&lt;!-- 子部件 11 ：显示购买后的商品详情 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{isPaid}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用 WeUI 的 Panel 组件实现子部件之间由灰色色块区隔的效果，使用 WeUI 的 Msg 组件的 成功提示页与失败提示页可以快速的实现支付成功与支付失败结果的显示。</p>
</div><div class="cl-preview-section"><h3 id="实现子部件-1-：商品大图栏">3.2 实现子部件 1 ：商品大图栏</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">商品大图使用小程序官方媒体组件 image 显示，显示模式为 <code>mode="widthFix"</code> （缩放模式，宽度不变，高度自动变化，保持原图宽高比不变）：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- 子部件 1 ：商品大图栏 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>widthFix<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ productInfo.coverimg ? productInfo.coverimg : <span class="token punctuation">'</span><span class="token punctuation">'</span> }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="实现子部件-2-：商品价格栏">3.3 实现子部件 2 ：商品价格栏</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">商品价格栏有三个显示元素，根据不同的条件显示不同的显示元素，这可以使用 <code>block</code>  标签配合条件渲染 <code>wx:if</code> 来实现；红底白字的 “限时特价” 等标记使用 WeUI 的 Badge 组件实现：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- 子部件 2 ：商品价格栏 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>padding-lr padding-bottom-sm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 非付费会员商品折扣价 如果用户不是付费会员，且用户等级有购物折扣时显示 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>block</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{isMembershipExpired &amp;&amp; discount &lt; 1}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge weui-badge_space<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>折扣价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge_after text-xl text-red<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            p{{discountedPrice}}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>line_through text-sm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> 原价 p{{price}} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>block</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 付费会员商品折扣价 用户是小M卡会员时显示 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>block</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{!isMembershipExpired}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge weui-badge_space<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge_after<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            小M卡会员专享价
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-red<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> p{{ discountedPrice }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>line_through text-sm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> 原价 p{{price}} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>block</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 商品原价 如果用户不是付费会员，且用户等级没有购物折扣时显示--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>block</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{isMembershipExpired &amp;&amp; discount == 1}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge weui-badge_space<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>限时特价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge_after text-xl text-red<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            p{{discountedPrice}}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>block</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="实现子部件-3-：付费会员促销栏">3.4 实现子部件 3 ：付费会员促销栏</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">付费会员促销栏的小 M 卡会员专享价的显示样式使用 WeUI 的 Panel 组件与 Badge 组件实现，页面跳转使用 Navigator 实现：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- 子部件 3 ：付费会员促销栏 当用户不是小M卡会员时才显示 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{isMembershipExpired}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel weui-panel_access<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-panel__bd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>navigator</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../../my/membershipcard/membershipcard<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-cell weui-cell_access weui-cell_hide_line<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-cell__bd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge weui-badge_space<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>M<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-badge_after<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        小M卡会员专享价
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-lg text-red margin-left-sm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>p{{ membershipPrice }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-sm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        {{ '开卡仅p20000，此商品省p'+ (productInfo.price - membershipPrice) }}
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>weui-cell__ft weui-cell__ft_in-access<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>开通会员<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>navigator</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="实现子部件-4---子部件-6">3.5 实现子部件 4 - 子部件 6</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">子部件 4 ：商品简介栏 、子部件 5 ：商品目录栏与子部件 6 ：商品详情栏的实现均较简单，只需使用 WeUI 的 Panel 组件显示商品信息的部分字段内容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">请各位同学自行编写代码实现，具体实现代码可参考专栏源代码的 <code>product.wxml</code> 文件，具体代码位置见本节末尾图 15。</p>
</div><div class="cl-preview-section"><h3 id="实现子部件-7-：相关商品栏">3.6 实现子部件 7 ：相关商品栏</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">相关商品栏的代码实现与本章第三节商品列表栏几乎相同，不再复述。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">相关商品栏的实现代码请参考：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">本章第三节中商品列表栏的代码，不使用自定义组件，直接在页面中编写全部代码</li>
<li style="font-size: 20px; line-height: 38px;">专栏源代码，使用自定义组件实现</li>
</ul>
</div><div class="cl-preview-section"><h3 id="实现子部件-8---子部件-11">3.7 实现子部件 8 - 子部件 11</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在子部件 8 ：底部操作栏中需要显示购物车中的商品数量，因此需要添加一个数据：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    cart<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//购物车数据</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">并在页面加载时读取购物车数据，购物车数据存储在微信客户端的数据缓存中，使用小程序官方提供的数据缓存 API 读取（数据缓存 API 的使用方法请回顾本章第四节内容）：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 生命周期函数--监听页面加载
   */</span>
  onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//读取购物车数据</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
      
    <span class="token comment">/**
   * 页面加载时读取用户本地缓存的购物车数据
   */</span>
  initCart<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        cart<span class="token punctuation">:</span> value
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        cart<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>在第七章第三节中我们提到过一个特殊场景：由于小程序的页面路由机制，点击小程序左上角的返回按钮后只是将前一页面出栈显示出来，并不会重新加载页面（即不会触发 onLoad 事件）。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>在商品详情页同样存在该特殊场景：</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>当用户点击购物车按钮，在购物车中删除一些商品，再点击小程序左上角的返回按钮返回商品详情页面时，应该显示最新的购物车中的商品数量。</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，我们需要增加一个页面显示事件的定义，在页面显示时重新获取购物车中的商品数量：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 生命周期函数--监听页面显示
   */</span>
  onShow<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//页面显示，需要刷新购物车数据</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">点击加入购物车按钮后，需要将当前页面的商品添加到微信客户端的购物车数据缓存中，并提示用户加入购物车成功：</p>
</div><div class="cl-preview-section"><pre class="  language-js"><code class="prism  language-js">  <span class="token comment">/**
   * 添加商品到购物车
   */</span>
  addCart<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从缓存读取购物车数据</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果缓存中已经存在购物车数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> e<span class="token punctuation">.</span>index <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>productInfo<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//如果购物车数据中没有当前页面的商品，就将当前页面的商品添加到购物车数据的末尾</span>
        value<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果缓存中不存在购物车数据，新建购物车数据并添加当前页面的商品</span>
      value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//更新显示数据</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      cart<span class="token punctuation">:</span> value
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将最新的购物车数据更新到本地缓存</span>
    wx<span class="token punctuation">.</span><span class="token function">setStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      key<span class="token punctuation">:</span> <span class="token string">"cart"</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> value<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//提示用户已加入购物车,2秒后隐藏提示</span>
    wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">'已加入购物车'</span><span class="token punctuation">,</span>
      icon<span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span>
      duration<span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">底部操作栏的样式可以在 ColorUI 的操作条组件中找到，简单修改 ColorUI Demo 小程序的代码即可实现 WXML 页面模板：</p>
</div><div class="cl-preview-section"><pre class="  language-html"><code class="prism  language-html"><span class="token comment">&lt;!-- 子部件 8 ：底部操作栏 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cu-bar bg-white tabbar border shop bottom_pay_button<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>navigator</span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>switchTab<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../index/index<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>action<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-home<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        首页
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>navigator</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>navigator</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../cart/cart<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>action<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-cart<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{cart.length &gt; 0}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cu-tag badge<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{cart.length}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
        购物车
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>navigator</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>addCart<span class="token punctuation">'</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bg-orange submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>加入购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>onPayButtonClick<span class="token punctuation">'</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bg-red submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>立即购买<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">底部操作栏固定在页面底部，可使用 <code>position</code> 与 <code>z-index</code>  样式属性实现：</p>
</div><div class="cl-preview-section"><pre class="  language-css"><code class="prism  language-css"><span class="token comment">/* 底部支付按钮样式 */</span>
<span class="token selector"><span class="token class">.bottom_pay_button</span> </span><span class="token punctuation">{</span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> <span class="token number">9999</span><span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> <span class="token number">0</span>px<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100%</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">子部件 8 中购买商品按钮点击事件的实现逻辑与实现代码，与第七章第五节付费会员支付按钮完全一致，区别仅在于调用的支付接口名称不同。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">请各位同学参考第七章第五节的代码自行实现购买商品按钮的点击事件 <code>onPayButtonClick</code> ，也可参考专栏源代码的 <code>product.js</code> 文件，具体代码位置见本节末尾图 15。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">子部件 9 与 子部件 10 的实现请参考第七章第五节 “2.7 实现子部件 6 与 子部件 7 ：显示支付结果” 或专栏源代码。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">子部件 11 仅显示商品各字段信息，具体实现代码请阅读专栏源代码的 <code>product.wxml</code> 文件。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>由于篇幅所限，包含完整样式的 WXML 页面模板代码请查阅专栏源代码 product.wxml 与 product.wxss ，完整的 JS 逻辑代码见 product.js ，具体代码位置见本节末尾图 15 。</strong></p>
</div><div class="cl-preview-section"><h2 id="专栏源代码" style="font-size: 30px;">4. 专栏源代码</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本专栏源代码已上传到 GitHub ，请访问以下地址获取：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><a href="https://github.com/liujiec/Membership-ECommerce-Miniprogram">https://github.com/liujiec/Membership-ECommerce-Miniprogram</a></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节源代码内容在图 15 红框标出的位置。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>图 15 本节源代码位置</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d6b5eac0001ca9e07830836.png" data-original="//img.mukewang.com/5d6b5eac0001ca9e07830836.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><h2 id="下节预告" style="font-size: 30px;">下节预告</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下一节，我们将实现购物车页面及购物车合并支付功能。</p>
</div><div class="cl-preview-section"><h2 id="实践环节" style="font-size: 30px;">实践环节</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">实践是通往大神之路的唯一捷径。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节实操内容：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;"><strong>请结合第二章第三节对 “分类拆解法” 的详细讲解内容，拆解本节图 14 的商品详情页面，然后将自己的拆解结果与本节列出的拆解结果进行对照总结。</strong></li>
<li style="font-size: 20px; line-height: 38px;"><strong>编写代码完成商品详情页面，如碰到问题，请阅读本专栏源代码学习如何实现。</strong></li>
</ul>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/40/article/591">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            32 准备好收银机：开发实现商城支付接口
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/40/article/593">
                                                                    <div class="next r clearfix">
                                        <p>
                                            34 让用户买买买：开发实现商城购物车页面
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img1.mukewang.com/5d5a70850001363505400600.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课前端核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">1907191830328156</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：722466314</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=5l9EFfc" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>