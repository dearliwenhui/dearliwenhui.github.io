<html><head><meta charset="utf-8"><title>02 快速学会分析SQL执行效率（上）-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        02 快速学会分析SQL执行效率（上）
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-07-30 10:13:59
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img.mukewang.com/5d3ed5ee00010d5106400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">勤学如春起之苗，不见其增，日有所长。<p class="author">——陶潜</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从开篇词我们了解到，本专栏首先会一起讨论一下 SQL 优化，而优化 SQL 的前提是能定位到慢 SQL 并对其进行分析，因此在专栏的开始，会跟大家分享<strong>如何定位慢查询和如何分析 SQl 执行效率</strong>。在前面两节，会用一些简单的例子让大家学会这些分析技巧。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在工作中可能会遇到某个新功能在测试时需要很久才返回结果，这时就应该分析是不是慢查询导致的。如果确实有慢查询，又应该怎么去分析 SQL 执行效率呢？这一篇文章我们就来学习怎么找到慢查询和怎么分析 SQL 执行效率。</p>
</div><div class="cl-preview-section"><h2 id="定位慢-sql" style="font-size: 30px;">1 定位慢 SQL</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当我们实际工作中，碰到某个功能或者某个接口需要很久才能返回结果，我们就应该去确定是不是慢查询导致的。定位慢 SQL 有如下两种解决方案：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">查看慢查询日志确定已经执行完的慢查询</li>
<li style="font-size: 20px; line-height: 38px;">show processlist 查看正在执行的慢查询</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们一起来了解下这两种方法的使用场景和使用技巧吧！</p>
</div><div class="cl-preview-section"><h3 id="通过慢查询日志">1.1 通过慢查询日志</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果需要定位到慢查询，一般的方法是通过慢查询日志来查询的，MySQL 的慢查询日志用来记录在 MySQL 中响应时间超过参数 long_query_time（单位秒，默认值 10）设置的值并且扫描记录数不小于 min_examined_row_limit（默认值0）的语句，<strong>能够帮我们找到执行完的慢查询，方便我们对这些 SQL 进行优化</strong>。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">知识扩展：</p>
<p style="font-size: 20px; line-height: 38px;">默认情况下，慢查询日志中不会记录管理语句，可通过设置 log_slow_admin_statements = on 让管理语句中的慢查询也会记录到慢查询日志中。</p>
<p style="font-size: 20px; line-height: 38px;">默认情况下，也不会记录查询时间不超过 long_query_time 但是不使用索引的语句，可通过配置log_queries_not_using_indexes = on 让不使用索引的 SQL 都被记录到慢查询日志中（即使查询时间没超过 long_query_time 配置的值）。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果需要使用慢查询日志，一般分为四步：开启慢查询日志、设置慢查询阀值、确定慢查询日志路径、确定慢查询日志的文件名。下面我们来学习下:</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先开启慢查询日志，由参数 slow_query_log 决定是否开启，在 MySQL 命令行下输入下面的命令：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>

Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">默认环境下，慢查询日志是关闭的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">设置慢查询时间阀值</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">知识扩展：<br>
<strong>MySQL 中 long_query_time 的值如何确定呢？</strong></p>
<p style="font-size: 20px; line-height: 38px;">线上业务一般建议把 long_query_time 设置为 1 秒，如果某个业务的 MySQL 要求比较高的 QPS，可设置慢查询为 0.1 秒。发现慢查询及时优化或者提醒开发改写。</p>
<p style="font-size: 20px; line-height: 38px;">一般测试环境建议 long_query_time 设置的阀值比生产环境的小，比如生产环境是 1 秒，则测试环境建议配置成 0.5 秒。便于在测试环境及时发现一些效率低的 SQL。</p>
<p style="font-size: 20px; line-height: 38px;">甚至某些重要业务测试环境 long_query_time 可以设置为 0，以便记录所有语句。并留意慢查询日志的输出，上线前的功能测试完成后，分析慢查询日志每类语句的输出，重点关注 Rows_examined（语句执行期间从存储引擎读取的行数），提前优化。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">确定慢查询日志路径</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">慢查询日志的路径默认是 MySQL 的数据目录</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">"datadir"</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">---------------+------------------------+</span>
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+------------------------+</span>
<span class="token operator">|</span> datadir       <span class="token operator">|</span> <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3306</span><span class="token operator">/</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+------------------------+</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">确定慢查询日志的文件名</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">"slow_query_log_file"</span><span class="token punctuation">;</span>

<span class="token operator">+</span><span class="token comment">---------------------+----------------+</span>
<span class="token operator">|</span> Variable_name       <span class="token operator">|</span> <span class="token keyword">Value</span>          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------+</span>
<span class="token operator">|</span> slow_query_log_file <span class="token operator">|</span> mysql<span class="token operator">-</span>slow<span class="token punctuation">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+----------------+</span>

<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">根据上面的查询结果，可以直接查看 /data/mysql/data/3306/mysql-slow.log 文件获取已经执行完的慢查询</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># tail -n5 /data/mysql/data/3306/mysql-slow.log</span>

Time: <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span>21T09:<span class="token number">15</span>:<span class="token number">06.255554</span><span class="token operator">+</span><span class="token number">08</span>:<span class="token number">00</span>

<span class="token keyword">User</span><span class="token variable">@Host</span>: root<span class="token punctuation">[</span>root<span class="token punctuation">]</span> @ localhost <span class="token punctuation">[</span><span class="token punctuation">]</span>  Id: <span class="token number">8591152</span>

Query_time: <span class="token number">10.000260</span>  Lock_time: <span class="token number">0.000000</span> Rows_sent: <span class="token number">1</span>  Rows_examined: <span class="token number">0</span>

<span class="token keyword">SET</span> <span class="token keyword">timestamp</span><span class="token operator">=</span><span class="token number">1558401306</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里对上方的执行结果详细描述一下：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">tail  -n5：只查看慢查询文件的最后5行</li>
<li style="font-size: 20px; line-height: 38px;">Time：慢查询发生的时间</li>
<li style="font-size: 20px; line-height: 38px;">User@Host：客户端用户和IP</li>
<li style="font-size: 20px; line-height: 38px;">Query_time：查询时间</li>
<li style="font-size: 20px; line-height: 38px;">Lock_time：等待表锁的时间</li>
<li style="font-size: 20px; line-height: 38px;">Rows_sent：语句返回的行数</li>
<li style="font-size: 20px; line-height: 38px;">Rows_examined：语句执行期间从存储引擎读取的行数</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">上面这种方式是用系统自带的慢查询日志查看的，如果觉得系统自带的慢查询日志不方便查看，小伙伴们可以使用 pt-query-digest 或者 mysqldumpslow 等工具对慢查询日志进行分析，由于本节重点是找到慢查询，这里就不一一示例了。</p>
</div><div class="cl-preview-section"><h3 id="通过-show-processlist">1.2 通过 show processlist;</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">有时慢查询正在执行，已经导致数据库负载偏高了，而由于慢查询还没执行完，因此慢查询日志还看不到任何语句。此时可以使用 show processlist 命令判断正在执行的慢查询。show processlist 显示哪些线程正在运行。如果有 PROCESS 权限，则可以看到所有线程。否则，只能看到当前会话的线程。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">知识扩展：如果不使用 FULL 关键字，在 info 字段中只显示每个语句的前 100 个字符，如果想看语句的全部内容可以使用 full 修饰（show full processlist）。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">执行结果如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> processlist\G<span class="token punctuation">`</span>

<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">`</span>

<span class="token punctuation">`</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">`</span>

     <span class="token punctuation">`</span>Id: <span class="token number">7651833</span><span class="token punctuation">`</span>

   <span class="token punctuation">`</span><span class="token keyword">User</span>: one<span class="token punctuation">`</span>

   <span class="token punctuation">`</span>Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">1.251</span>:<span class="token number">52154</span><span class="token punctuation">`</span>

     <span class="token punctuation">`</span><span class="token number">db</span>: ops<span class="token punctuation">`</span>

<span class="token punctuation">`</span>Command: Query<span class="token punctuation">`</span>

   <span class="token punctuation">`</span>Time: <span class="token number">3</span><span class="token punctuation">`</span>

  <span class="token punctuation">`</span>State: <span class="token keyword">User</span> sleep<span class="token punctuation">`</span>

   <span class="token punctuation">`</span>Info: <span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">`</span>

<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">`</span>

<span class="token punctuation">`</span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token punctuation">`</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里对上面结果解释一下：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">Time：表示执行时间</li>
<li style="font-size: 20px; line-height: 38px;">Info：表示 SQL 语句</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们这里可以通过它的执行时间（Time）来判断是否是慢 SQL。</p>
</div><div class="cl-preview-section"><h2 id="使用-explain-分析慢查询" style="font-size: 30px;">2 使用 explain 分析慢查询</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">分析 SQL 执行效率是优化 SQL 的重要手段，通过上面讲的两种方法，定位到慢查询语句后，我们就要开始分析 SQL 执行效率了，子曾经曰过：“工欲善其事，必先利其器”，我们可以通过 explain、show profile 和 trace 等诊断工具来分析慢查询。本节先讲解 explain 的使用，在下节将分享 show profile 和 trace 的使用。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Explain 可以获取 MySQL 中 SQL 语句的执行计划，比如语句是否使用了关联查询、是否使用了索引、扫描行数等。可以帮我们选择更好地索引和写出更优的 SQL 。使用方法：在查询语句前面加上 explain 运行就可以了。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这也是分析 SQL 时最常用的，也是作者最推荐的一种分析慢查询的方式。下面我们来看下示例~~</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了便于理解，先创建两张测试表（方便第 1、2 节实验使用），建表及数据写入语句如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> muke<span class="token punctuation">;</span>           <span class="token comment">/* 创建测试使用的database，名为muke */</span>
<span class="token keyword">use</span> muke<span class="token punctuation">;</span>                       <span class="token comment">/* 使用muke这个database */</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t1<span class="token punctuation">;</span>        <span class="token comment">/* 如果表t1存在则删除表t1 */</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token punctuation">(</span>             <span class="token comment">/* 创建表t1 */</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">b</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'记录创建时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'记录更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_a<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_b<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">b</span><span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>	

<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> insert_t1<span class="token punctuation">;</span> <span class="token comment">/* 如果存在存储过程insert_t1，则删除 */</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">/* 创建存储过程insert_t1 */</span>
<span class="token keyword">begin</span>
  <span class="token keyword">declare</span> i <span class="token keyword">int</span><span class="token punctuation">;</span>                    <span class="token comment">/* 声明变量i */</span>
  <span class="token keyword">set</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                          <span class="token comment">/* 设置i的初始值为1 */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token keyword">do</span>                  <span class="token comment">/* 对满足i&lt;=1000的值进行while循环 */</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> t1<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">,</span><span class="token number">b</span><span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 写入表t1中a、b两个字段，值都为i当前的值 */</span>
    <span class="token keyword">set</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                      <span class="token comment">/* 将i加1 */</span>
  <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span>                 <span class="token comment">/* 创建批量写入1000条数据到表t1的存储过程insert_t1 */</span>
<span class="token keyword">call</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">/* 运行存储过程insert_t1 */</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t2<span class="token punctuation">;</span>    <span class="token comment">/* 如果表t2存在则删除表t2 */</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2 <span class="token operator">like</span> t1<span class="token punctuation">;</span>    <span class="token comment">/* 创建表t2，表结构与t1一致 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>   <span class="token comment">/* 将表t1的数据导入到t2 */</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面尝试使用 explain 分析一条 SQL，例子如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3aa6eb00011e2511760160.png" data-original="//img.mukewang.com/5d3aa6eb00011e2511760160.png" alt="图片描述">Explain 的结果各字段解释如下：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">加粗的列为需要重点关注的项。</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th align="left">列名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">id</td>
<td>查询编号</td>
</tr>
<tr>
<td align="left"><strong>select_type</strong></td>
<td>查询类型：显示本行是简单还是复杂查询</td>
</tr>
<tr>
<td align="left">table</td>
<td>涉及到的表</td>
</tr>
<tr>
<td align="left">partitions</td>
<td>匹配的分区：查询将匹配记录所在的分区。仅当使用 partition 关键字时才显示该列。对于非分区表，该值为 NULL。</td>
</tr>
<tr>
<td align="left"><strong>type</strong></td>
<td>本次查询的表连接类型</td>
</tr>
<tr>
<td align="left">possible_keys</td>
<td>可能选择的索引</td>
</tr>
<tr>
<td align="left"><strong>key</strong></td>
<td>实际选择的索引</td>
</tr>
<tr>
<td align="left">key_len</td>
<td>被选择的索引长度：一般用于判断联合索引有多少列被选择了</td>
</tr>
<tr>
<td align="left">ref</td>
<td>与索引比较的列</td>
</tr>
<tr>
<td align="left"><strong>rows</strong></td>
<td>预计需要扫描的行数，对 InnoDB 来说，这个值是估值，并不一定准确</td>
</tr>
<tr>
<td align="left">filtered</td>
<td>按条件筛选的行的百分比</td>
</tr>
<tr>
<td align="left"><strong>Extra</strong></td>
<td>附加信息</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"> <center>表1-explain 各字段解释</center>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">其中 explain 各列都有各种不同的值，这里介绍几个比较重要列常包含的值:包含 select_typ、type 和 Extra。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面将列出它们常见的一些值，可稍微过一遍，不需要完全记下来，在后续章节分析 SQL 时，可以返回查询本节内容并对比各种值的区别。</p>
</div><div class="cl-preview-section"><h3 id="select_type">2.1 select_type</h3>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>select_type 的值</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIMPLE</td>
<td>简单查询(不使用关联查询或子查询)</td>
</tr>
<tr>
<td>PRIMARY</td>
<td>如果包含关联查询或者子查询，则最外层的查询部分标记为primary</td>
</tr>
<tr>
<td>UNION</td>
<td>联合查询中第二个及后面的查询</td>
</tr>
<tr>
<td>DEPENDENT   UNION</td>
<td>满足依赖外部的关联查询中第二个及以后的查询</td>
</tr>
<tr>
<td>UNION RESULT</td>
<td>联合查询的结果</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>子查询中的第一个查询</td>
</tr>
<tr>
<td>DEPENDENT   SUBQUERY</td>
<td>子查询中的第一个查询，并且依赖外部查询</td>
</tr>
<tr>
<td>DERIVED</td>
<td>用到派生表的查询</td>
</tr>
<tr>
<td>MATERIALIZED</td>
<td>被物化的子查询</td>
</tr>
<tr>
<td>UNCACHEABLE      SUBQUERY</td>
<td>一个子查询的结果不能被缓存，必须重新评估外层查询的每一行</td>
</tr>
<tr>
<td>UNCACHEABLE   UNION</td>
<td>关联查询第二个或后面的语句属于不可缓存的子查询</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"> <center>表2-select_type 各项值解释</center>
</div><div class="cl-preview-section"><h3 id="type">2.2 type</h3>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>type的值</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>system</td>
<td>查询对象表只有一行数据,且只能用于 MyISAM 和 Memory 引擎的表，这是最好的情况</td>
</tr>
<tr>
<td>const</td>
<td>基于主键或唯一索引查询，最多返回一条结果</td>
</tr>
<tr>
<td>eq_ref</td>
<td>表连接时基于主键或非 NULL 的唯一索引完成扫描</td>
</tr>
<tr>
<td>ref</td>
<td>基于普通索引的等值查询，或者表间等值连接</td>
</tr>
<tr>
<td>fulltext</td>
<td>全文检索</td>
</tr>
<tr>
<td>ref_or_null</td>
<td>表连接类型是 ref，但进行扫描的索引列中可能包含 NULL 值</td>
</tr>
<tr>
<td>index_merge</td>
<td>利用多个索引</td>
</tr>
<tr>
<td>unique_subquery</td>
<td>子查询中使用唯一索引</td>
</tr>
<tr>
<td>index_subquery</td>
<td>子查询中使用普通索引</td>
</tr>
<tr>
<td>range</td>
<td>利用索引进行范围查询</td>
</tr>
<tr>
<td>index</td>
<td>全索引扫描</td>
</tr>
<tr>
<td>ALL</td>
<td>全表扫描</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"> <center>表3-type 各项值解释</center>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>上表的这些情况，查询性能从上到下依次是最好到最差。</strong></p>
</div><div class="cl-preview-section"><h3 id="extra">2.3 Extra</h3>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>Extra 常见的值</th>
<th>解释</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>Using filesort</td>
<td>将用外部排序而不是索引排序，数据较小时从内存排序，否则需要在磁盘完成排序</td>
<td>explain select * from   t1 order  by create_time;</td>
</tr>
<tr>
<td>Using   temporary</td>
<td>需要创建一个临时表来存储结构，通常发生对没有索引的列进行 GROUP BY 时</td>
<td>explain select * from   t1 group by create_time;</td>
</tr>
<tr>
<td>Using index</td>
<td>使用覆盖索引</td>
<td>explain select a from   t1 where a=111;</td>
</tr>
<tr>
<td>Using where</td>
<td>使用 where 语句来处理结果</td>
<td>explain select * from t1 where create_time=‘2019-06-18 14:38:24’;</td>
</tr>
<tr>
<td>Impossible   WHERE</td>
<td>对 where 子句判断的结果总是 false 而不能选择任何数据</td>
<td>explain select * from t1 where 1&lt;0;</td>
</tr>
<tr>
<td>Using join   buffer (Block Nested Loop)</td>
<td>关联查询中，被驱动表的关联字段没索引</td>
<td>explain   select * from t1 straight_join t2 on (t1.create_time=t2.create_time);</td>
</tr>
<tr>
<td>Using index   condition</td>
<td>先条件过滤索引，再查数据</td>
<td>explain   select * from t1 where a &gt;900 and a like “%9”;</td>
</tr>
<tr>
<td>Select tables   optimized away</td>
<td>使用某些聚合函数（比如 max、min）来访问存在索引的某个字段是</td>
<td>explain select max(a)   from t1;</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"> <center>表4-Extra 常见值解释及举例</center>
</div><div class="cl-preview-section"><h2 id="总结" style="font-size: 30px;">3 总结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">今天我分享的关于定位慢 SQL 及使用 explain 分析慢 SQL 到这里就结束了。本节知识点总结如下：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节首先讲到如何定位慢 SQL:</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">一种方法是查看慢查询日志</li>
<li style="font-size: 20px; line-height: 38px;">另一种方法是 show process 查看正在执行的 SQL</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">再讲到通过 explain 分析慢 SQL，explain 会返回很多字段，其中 select_type、type、key、rows、Extra 是重点关注项。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在工作中及面试时，SQL 性能优化都是我们经常遇到的问题，要想做好性能优化，我们必须学会使用 SQL 优化时需要的工具，进行定位和分析。由于篇幅的问题，本小节只介绍了 explain 工具的使用，在下节将补充另外两种分析慢查询的工具：show profile 和 trace。在后面我会再讲解 SQL 优化的一些知识点，相信小伙伴们 SQL 性能优化时一定可以越来越熟练。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">最后小伙伴们可以将处理问题时的心得体会进行总结，也欢迎给我留言分享，我们一起来交流、学习、进步。</p>
</div><div class="cl-preview-section"><h2 id="问题" style="font-size: 30px;">4 问题</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">你在平常工作中是怎么降低慢查询在生产环境出现的概率？</p>
</div><div class="cl-preview-section"><h2 id="参考资料" style="font-size: 30px;">5 参考资料</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">《深入浅出 MySQL》（第2版）：第 18 章第 1 节</p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/43/article/715">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            01 开篇词
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/43/article/683">
                                                                    <div class="next r clearfix">
                                        <p>
                                            03 快速学会分析SQL执行效率（下）
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>