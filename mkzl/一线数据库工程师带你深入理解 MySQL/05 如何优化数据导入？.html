<html><head><meta charset="utf-8"><title>05 如何优化数据导入？-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        05 如何优化数据导入？
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-08-01 11:19:49
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img1.mukewang.com/5d3aca47000160b306400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">天才就是百分之二的灵感，百分之九十八的汗水。<p class="author">——爱迪生</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们有时会遇到批量数据导入的场景，而数据量稍微大点，会发现导入非常耗时间。这篇文稿将介绍一些常用的加快数据导入的方法。</p>
</div><div class="cl-preview-section"><h2 id="一次插入多行的值" style="font-size: 30px;">1 一次插入多行的值</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">插入行所需的时间由以下因素决定（参考MySQL 5.7参考手册：<a href="https://dev.mysql.com/doc/refman/5.7/en/insert-optimization.html">8.2.4.1优化INSERT语句</a>）</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">连接：30%</li>
<li style="font-size: 20px; line-height: 38px;">向服务器发送查询：20%</li>
<li style="font-size: 20px; line-height: 38px;">解析查询：20%</li>
<li style="font-size: 20px; line-height: 38px;">插入行：10% * 行的大小</li>
<li style="font-size: 20px; line-height: 38px;">插入索引：10% * 索引数</li>
<li style="font-size: 20px; line-height: 38px;">结束：10%</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">可发现大部分时间耗费在客户端与服务端通信的时间，因此可以使用 insert 包含多个值来减少客户端和服务器之间的通信。我们通过实验来验证下一次插入多行与一次插入一行的效率对比。</p>
</div><div class="cl-preview-section"><h3 id="准备测试表及数据">1.1 准备测试表及数据</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">由于本次实验操作包含 drop 等危险操作，因此建议创建普通用户进行实验，并权限最小化，以防误操作。</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">grant</span> <span class="token keyword">select</span><span class="token punctuation">,</span><span class="token keyword">insert</span><span class="token punctuation">,</span><span class="token keyword">create</span><span class="token punctuation">,</span><span class="token keyword">drop</span><span class="token punctuation">,</span><span class="token keyword">index</span><span class="token punctuation">,</span><span class="token keyword">alter</span> <span class="token keyword">on</span> muke<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'test_user3'</span>@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' identified by '</span>userBcdQ19Ic'<span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里对上面命令解释一下：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>grant</td>
<td>这里包含了创建用户及赋权操作</td>
</tr>
<tr>
<td>select,insert,create,drop</td>
<td>赋予查询、写入、建表及删表的权限</td>
</tr>
<tr>
<td>on muke.*</td>
<td>只对muke这个database有这些权限</td>
</tr>
<tr>
<td>to ‘test_user3’@‘127.0.0.1’</td>
<td>用户名为test_user3，host为127.0.0.1，即test_user3只能在本机使用，如果MySQL服务端跟客户端不在同一台机器上，则127.0.0.1替换成客户端ip地址</td>
</tr>
<tr>
<td>identified by ‘userBcdQ19Ic’</td>
<td>用户密码为userBcdQ19Ic</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">创建测试表及写入数据，语句如下</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">use</span> muke<span class="token punctuation">;</span>                 <span class="token comment">/* 使用muke这个database */</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t1<span class="token punctuation">;</span>  <span class="token comment">/* 如果表t1存在则删除表t1 */</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token punctuation">(</span>	      <span class="token comment">/* 创建表t1 */</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">b</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">c</span><span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> insert_t1<span class="token punctuation">;</span> <span class="token comment">/* 如果存在存储过程insert_t1，则删除 */</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">/* 创建存储过程insert_t1 */</span>
<span class="token keyword">begin</span>
  <span class="token keyword">declare</span> i <span class="token keyword">int</span><span class="token punctuation">;</span>                  <span class="token comment">/* 声明变量i */</span>
  <span class="token keyword">set</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment">/* 设置i的初始值为1 */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token keyword">do</span>			      <span class="token comment">/* 对满足i&lt;=1000的值进行while循环 */</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> t1<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">,</span><span class="token number">b</span><span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 写入表t1中a、b两个字段，值都为i当前的值 */</span>
    <span class="token keyword">set</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                       <span class="token comment">/* 将i加1 */</span>
  <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span>
<span class="token keyword">call</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">/* 运行存储过程insert_t1 */</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="导出一条-sql-包含多行数据的数据文件">1.2 导出一条 SQL 包含多行数据的数据文件</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了获取批量导入数据的 SQL，首先对测试表的数据进行备份，备份的 SQL 为一条 SQL 包含多行数据的形式（执行环境为 Centos7 命令行）。</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> muke<span class="token punctuation">]</span><span class="token comment"># mysqldump -utest_user3 -p'userBcdQ19Ic' -h127.0.0.1 --set-gtid-purged=off --single-transaction --skip-add-locks  muke t1 &gt;t1.sql</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里对上面 mysqldump 所使用到的一些参数做下解释：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>参数</th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td>-utest_user3</td>
<td>用户名，这里使用的是root用户</td>
</tr>
<tr>
<td>-p’userBcdQ19Ic’</td>
<td>密码</td>
</tr>
<tr>
<td>-h127.0.0.1</td>
<td>连接的MySQL服务端IP</td>
</tr>
<tr>
<td>set-gtid-purged=off</td>
<td>不添加SET @@GLOBAL.GTID_PURGED</td>
</tr>
<tr>
<td>–single-transaction</td>
<td>设置事务的隔离级别为可重复读，即REPEATABLE READ，这样能保证在一个事务中所有相同的查询读取到同样的数据</td>
</tr>
<tr>
<td>–skip-add-locks</td>
<td>取消每个表导出之前加lock tables操作。</td>
</tr>
<tr>
<td>muke</td>
<td>库名</td>
</tr>
<tr>
<td>t1</td>
<td>表名</td>
</tr>
<tr>
<td>t1.sql</td>
<td>导出数据到这个文件</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">查看文件 t1.sql 内容，可看到数据是单条 SQL 有多条数据，如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span><span class="token punctuation">;</span>		
<span class="token comment">/* 按照上面的备份语句备份的数据文件包含drop命令时，需要特别小心，在后续使用备份文件做导入操作时，应该确定所有表名，防止drop掉业务正在使用的表 */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="导出一条sql只包含一行数据的数据文件">1.3 导出一条SQL只包含一行数据的数据文件</h3>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> muke<span class="token punctuation">]</span><span class="token comment"># mysqldump -utest_user3 -p'userBcdQ19Ic' -h127.0.0.1 --set-gtid-purged=off --single-transaction --skip-add-locks --skip-extended-insert muke t1 &gt;t1_row.sql</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">mysqldump命令参数解释：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>参数</th>
<th>详解</th>
</tr>
</thead>
<tbody>
<tr>
<td>–skip-extended-insert</td>
<td>一条SQL一行数据的形式导出数据</td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">备份文件t1_row.sql内容如下</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="导入时间的对比">1.4 导入时间的对比</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先导入一行 SQL 包含多行数据的数据文件：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># time mysql -utest_user3 -p'userBcdQ19Ic' -h127.0.0.1 muke &lt;t1.sql</span>

<span class="token keyword">real</span>	0m0<span class="token punctuation">.</span>230s
<span class="token keyword">user</span>	0m0<span class="token punctuation">.</span>007s
sys		0m0<span class="token punctuation">.</span>003s
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">耗时0.2秒左右。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">导入一条SQL只包含一行数据的数据文件：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># time mysql -utest_user3 -p'userBcdQ19Ic' -h127.0.0.1 muke &lt;t1_row.sql</span>

<span class="token keyword">real</span>	0m31<span class="token punctuation">.</span>138s
<span class="token keyword">user</span>	0m0<span class="token punctuation">.</span>088s
sys		0m0<span class="token punctuation">.</span>126s
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">耗时31秒左右。</p>
</div><div class="cl-preview-section"><h3 id="结论">1.5 结论</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">一次插入多行花费时间0.2秒，一次插入一行花费了31秒，对比效果明显，因此建议<strong>有大批量导入时，推荐一条insert语句插入多行数据。</strong></p>
</div><div class="cl-preview-section"><h2 id="关闭自动提交" style="font-size: 30px;">2 关闭自动提交</h2>
</div><div class="cl-preview-section"><h3 id="对比开启和关闭自动提交的效率">2.1 对比开启和关闭自动提交的效率</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Autocommit 开启时会为每个插入执行提交。可以在InnoDB导入数据时，关闭自动提交。如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SET</span> autocommit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'2019-05-24 15:44:10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用1.3 生成的t1_row.sql，在insert前增加：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SET</span> autocommit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在insert语句后面增加：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token punctuation">[</span>root<span class="token variable">@mysqltest</span> muke<span class="token punctuation">]</span><span class="token comment"># time mysql -utest_user3 -p'userBcdQ19Ic' -h127.0.0.1 muke &lt;t1_row.sql</span>

<span class="token keyword">real</span>		 0m1<span class="token punctuation">.</span>036s
<span class="token keyword">user</span>		0m0<span class="token punctuation">.</span>062s
sys		   0m0<span class="token punctuation">.</span>108s
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">开启自动提交的情况下导入是31秒（执行详情见1.4 导入时间的对比）。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">关闭自动提交的情况下导入是1秒左右，因此导入多条数据时，关闭自动提交，让多条 insert 一次提交，可以大大提升导入速度。</p>
</div><div class="cl-preview-section"><h3 id="原因分析">2.2 原因分析</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">与本节前面讲的一次插入多行能提高批量插入速度的原因一样，因为批量导入大部分时间耗费在客户端与服务端通信的时间，所以多条 insert 语句合并提交可以减少客户端与服务端通信的时间，并且合并提交还可以减少数据落盘的次数。</p>
</div><div class="cl-preview-section"><h2 id="参数调整" style="font-size: 30px;">3 参数调整</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">影响MySQL写入速度的主要两个参数：innodb_flush_log_at_trx_commit、sync_binlog。</p>
</div><div class="cl-preview-section"><h3 id="参数解释">3.1 参数解释</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">innodb_flush_log_at_trx_commit：控制重做日志刷新到磁盘的策略，有0 、1和2三种值。</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">0：master线程每秒把redo log buffer写到操作系统缓存，再刷到磁盘；</li>
<li style="font-size: 20px; line-height: 38px;">1：每次提交事务都将redo log buffer写到操作系统缓存，再刷到磁盘；</li>
<li style="font-size: 20px; line-height: 38px;">2：每次事务提交都将redo log buffer写到操作系统缓存，由操作系统来管理刷盘。</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">备注：具体原理会在后续的事务这章进行详细描述。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">sync_binlog：控制binlog的刷盘时机，可配置0、1或者大于1的数字。</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">0：二进制日志从不同步到磁盘，依赖OS刷盘机制；</li>
<li style="font-size: 20px; line-height: 38px;">1：二进制日志每次提交都会刷盘；</li>
<li style="font-size: 20px; line-height: 38px;">n(n&gt;1) : 每n次提交落盘一次。</li>
</ul>
</div><div class="cl-preview-section"><h3 id="写入速度测试">3.2 写入速度测试</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为了对比以上两个参数对MySQL写入速度的影响，我们通过压力工具sysbench测试写入速度。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">sysbench安装及使用请参考：<a href="http://imysql.cn/node/312%E3%80%82">http://imysql.cn/node/312。</a></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第一步：设置两个参数的值：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> innodb_flush_log_at_trx_commit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> sync_binlog<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第二步：准备数据：</p>
</div><div class="cl-preview-section"><pre class="  language-shell"><code class="prism  language-shell">[root@mysqltest ~]# sysbench --test=/usr/share/sysbench/tests/include/oltp_legacy/insert.lua --mysql-user=test_user3 --mysql-password='userBcdQ19Ic' --mysql-host=127.0.0.1 --mysql-db=muke --oltp-table-size=0 --oltp-tables-count=10  prepare
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第三步：进行写入测试：</p>
</div><div class="cl-preview-section"><pre class="  language-shell"><code class="prism  language-shell">[root@mysqltest ~]# sysbench --test=/usr/share/sysbench/tests/include/oltp_legacy/insert.lua --mysql-user=test_user3 --mysql-password='userBcdQ19Ic' --mysql-host=127.0.0.1  --mysql-db=muke --oltp-table-size=100000 --max-time=100 --oltp-tables-count=10  run
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">正式环境压测建议压半小时以上。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">第四步：记录测试结果：<br>
<img class="" src="https://img.mukewang.com/5d3aaa1a0001280713960803.png" data-original="//img.mukewang.com/5d3aaa1a0001280713960803.png" alt="图片描述">第五步：清除压测数据：</p>
</div><div class="cl-preview-section"><pre class="  language-shell"><code class="prism  language-shell">[root@mysqltest ~]# sysbench --test=/usr/share/sysbench/tests/include/oltp_legacy/insert.lua --mysql-user=test_user3 --mysql-password='userBcdQ19Ic' --mysql-host=127.0.0.1  --mysql-db=muke --oltp-table-size=100000 --oltp-tables-count=10  cleanup
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">测试结果如下：</p>
</div><div class="cl-preview-section"><div class="table-wrapper"><table>
<thead>
<tr>
<th>innodb_flush_log_at_trx_commit</th>
<th>sync_binlog</th>
<th>TPS</th>
<th>结论</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>316.83</td>
<td>双一情况写入速度最慢</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>526.97</td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>497.42</td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>2379.9</td>
<td>都设置为0的情况下，写入速度最快</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>515.76</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>0</td>
<td>2169.51</td>
<td></td>
</tr>
</tbody>
</table>
</div></div><div class="cl-preview-section"><h3 id="结论-1">3.3 结论</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从实验结果可以看出，innodb_flush_log_at_trx_commit设置为0、同时sync_binlog设置为0时，写入数据的速度是最快的。<strong>如果对数据库安全性要求不高(比如你的测试环境)，可以尝试都设置为0后再导入数据，能大大提升导入速度</strong>。</p>
</div><div class="cl-preview-section"><h2 id="总结" style="font-size: 30px;">4 总结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">今天一起研究了怎样提高 MySQL 批量导入数据的速度。根据测试，总结了加快批量数据导入有如下方法：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">一次插入多行的值；</li>
<li style="font-size: 20px; line-height: 38px;">关闭自动提交，多次插入数据的 SQL 一次提交；</li>
<li style="font-size: 20px; line-height: 38px;">调整参数，innodb_flush_log_at_trx_commit 和 sync_binlog 都设置为0（当然这种情况可能会丢数据）。</li>
</ul>
</div><div class="cl-preview-section"><h2 id="问题" style="font-size: 30px;">5 问题</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">你一般工作中使用什么方法加快大批量数据导入的速度？</p>
</div><div class="cl-preview-section"><h2 id="参考资料" style="font-size: 30px;">6 参考资料</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">唐汉明 等著；深入浅出MySQL（第2版）：18.4.2 优化INSERT语句</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">MySQL 5.7参考手册：<a href="https://dev.mysql.com/doc/refman/5.7/en/insert-optimization.html">8.2.4.1优化INSERT语句</a></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">sysbench的安装和做性能测试：<a href="http://imysql.cn/node/312">http://imysql.cn/node/312</a></p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/43/article/684">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            04 条件字段有索引，为什么查询也这么慢?
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/43/article/686">
                                                                    <div class="next r clearfix">
                                        <p>
                                            06 让order by、group by查询更快
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>