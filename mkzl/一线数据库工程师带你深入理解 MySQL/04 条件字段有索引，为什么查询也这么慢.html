<html><head><meta charset="utf-8"><title>04 条件字段有索引，为什么查询也这么慢?-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="../zhuanlanChapter-less.css?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        04 条件字段有索引，为什么查询也这么慢?
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2019-07-30 11:06:17
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img1.mukewang.com/5d3ac9d900010fe506400359.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">加紧学习，抓住中心，宁精勿杂，宁专勿多。 <p class="author">—— 周恩来</p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果我们想在某一本书中找到特定的主题，一般最快的方法是先看索引，找到对应的主题在哪个页码。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">而对于 MySQL 而言，如果需要查找某一行的值，可以先通过索引找到对应的值，然后根据索引匹配的记录找到需要查询的数据行。然而，有时会发现，即使查询条件有索引，也会查询很慢，本节将分享这类情况。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">MySQL 索引为什么能提高查询速度？将在第二章具体讲解。本节分享的是某些时候有索引却不走索引的情况，当然，大多数情况索引对提升 MySQL 查询速度还是非常明显的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面会讲解几种有索引但是查询不走索引导致查询慢的场景。</p>
</div><div class="cl-preview-section"><h2 id="函数操作" style="font-size: 30px;">1 函数操作</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">小伙伴们在使用 MySQL 查询数据时，可能很多时候会借助一些函数实现查询。有时可能我们关注的重心在是否能查出结果，往往忽略了查询的效率。现在就一起研究对条件索引字段做函数操作，是否能用到索引？</p>
</div><div class="cl-preview-section"><h3 id="验证对条件字段做函数操作是否能走索引">1.1 验证对条件字段做函数操作是否能走索引</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先创建测试表，建表及数据写入语句如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">use</span> muke<span class="token punctuation">;</span>                       <span class="token comment">/* 使用muke这个database */</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> t1<span class="token punctuation">;</span>        <span class="token comment">/* 如果表t1存在则删除表t1 */</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token punctuation">(</span>             <span class="token comment">/* 创建表t1 */</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">b</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token number">c</span><span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_a<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">a</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_b<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">b</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_c<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> insert_t1<span class="token punctuation">;</span> <span class="token comment">/* 如果存在存储过程insert_t1，则删除 */</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">/* 创建存储过程insert_t1 */</span>
<span class="token keyword">begin</span>
  <span class="token keyword">declare</span> i <span class="token keyword">int</span><span class="token punctuation">;</span>                    <span class="token comment">/* 声明变量i */</span>
  <span class="token keyword">set</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                          <span class="token comment">/* 设置i的初始值为1 */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token keyword">do</span>                 <span class="token comment">/* 对满足i&lt;=10000的值进行while循环 */</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> t1<span class="token punctuation">(</span><span class="token number">a</span><span class="token punctuation">,</span><span class="token number">b</span><span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 写入表t1中a、b两个字段，值都为i当前的值 */</span>
    <span class="token keyword">set</span> i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment">/* 将i加1 */</span>
  <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">delimiter</span> <span class="token punctuation">;</span>
<span class="token keyword">call</span> insert_t1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">/* 运行存储过程insert_t1 */</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> <span class="token number">c</span> <span class="token operator">=</span> <span class="token string">'2019-05-22 00:00:00'</span><span class="token punctuation">;</span>  <span class="token comment">/* 更新表t1的c字段，值都为'2019-05-22 00:00:00' */</span>
<span class="token keyword">update</span> t1 <span class="token keyword">set</span> <span class="token number">c</span> <span class="token operator">=</span> <span class="token string">'2019-05-21 00:00:00'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span>	 <span class="token comment">/* 将id为10000的行的c字段改为与其它行都不一样的数据，以便后面实验使用 */</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于上面创建的测试表，比如要查询测试表 t1 单独某一天的所有数据，SQL如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token string">'2019-05-21'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这里就可以使用第 2 节学习的 explain 来分析这条SQL的执行计划，分析结果如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token punctuation">(</span><span class="token number">c</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token string">'2019-05-21'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad79000016af412770164.png" data-original="//img.mukewang.com/5d3ad79000016af412770164.png" alt="图片描述">查看图中的执行计划，type 为 ALL，key 字段结果为 NULL，因此知道该 SQL 是没走索引的全表扫描。 （执行计划各字段的解释如果忘记了，可以查阅第 2 篇文章<a href="https://www.imooc.com/read/43/article/682">《快速学会分析 SQL 执行效率（上）》</a>中的 2 小节）</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">原因：对条件字段做函数操作走不了索引。</p>
</div><div class="cl-preview-section"><h3 id="对条件字段做函数操作不走索引的原因">1.2 对条件字段做函数操作不走索引的原因</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">为什么对条件字段做函数操作走不了索引，我们下面来讨论一下：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">该例中 c 字段普通索引的 B+ 索引树如下：<br>
<img class="" src="https://img.mukewang.com/5d3ad77b0001979814110615.png" data-original="//img.mukewang.com/5d3ad77b0001979814110615.png" alt="图片描述">根据上面结构可以看到，索引树中存储的是列的实际值和主键值。如果拿 ‘2019-05-21’ 去匹配，将无法定位到索引树中的值。因此放弃走索引，而选择全表扫描。</p>
</div><div class="cl-preview-section"><h3 id="函数操作的-sql-优化">1.3 函数操作的 SQL 优化</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此如果需要优化的话，改成 c 字段实际值相匹配的形式。因为 SQL 的目的是查询 2019-05-21 当天所有的记录，因此可以改成范围查询，如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">c</span><span class="token operator">&gt;=</span><span class="token string">'2019-05-21 00:00:00'</span> <span class="token operator">and</span> <span class="token number">c</span><span class="token operator">&lt;=</span><span class="token string">'2019-05-21 23:59:59'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">再用 explain 分析下执行计划：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">c</span><span class="token operator">&gt;=</span><span class="token string">'2019-05-21 00:00:00'</span> <span class="token operator">and</span> <span class="token number">c</span><span class="token operator">&lt;=</span><span class="token string">'2019-05-21 23:59:59'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad764000108b613700161.png" data-original="//img.mukewang.com/5d3ad764000108b613700161.png" alt="图片描述">根据上面的结果，可确定，走了 c 字段的索引（对应关注字段 key），扫描行数 1 行（对应关注字段 rows）。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">经验分享：</p>
<p style="font-size: 20px; line-height: 38px;">类似求某一天或者某一个月数据的需求，建议写成类似上例的范围查询，可让查询能走索引。避免对条件索引字段做函数处理。</p>
<p style="font-size: 20px; line-height: 38px;">我在工作中就曾经遇到过这类慢查询，如下：</p>
<pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">SELECT</span> tml_num_id<span class="token punctuation">,</span> status_num_id <span class="token keyword">FROM</span> sd_bl_so_tml_hdr <span class="token keyword">WHERE</span> 
tenant_num_id <span class="token operator">=</span> <span class="token number">6</span> <span class="token operator">AND</span> data_sign <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">AND</span> sub_unit_num_id <span class="token operator">=</span> <span class="token number">100004</span> <span class="token operator">AND</span> 
channel_num_id <span class="token operator">=</span> <span class="token number">91</span> <span class="token operator">AND</span> date_format<span class="token punctuation">(</span>order_date<span class="token punctuation">,</span> <span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
date_format<span class="token punctuation">(</span><span class="token string">'2019-06-02'</span><span class="token punctuation">,</span> <span class="token string">'%Y%m%d'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> status_num_id <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token keyword">LIMIT</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre>
<p style="font-size: 20px; line-height: 38px;">如果明白了上面的优化技巧，可以尝试着改写优化这条 SQL。</p>
</blockquote>
</div><div class="cl-preview-section"><h2 id="隐式转换" style="font-size: 30px;"><strong>2 隐式转换</strong></h2>
</div><div class="cl-preview-section"><h3 id="认识隐式转换">2.1 认识隐式转换</h3>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">什么时隐式转换？</p>
<p style="font-size: 20px; line-height: 38px;">当操作符与不同类型的操作对象一起使用时，就会发生类型转换以使操作兼容。某些转换是隐式的。</p>
<p style="font-size: 20px; line-height: 38px;"><a href="https://dev.mysql.com/doc/refman/5.7/en/type-conversion.html">关于隐式转换详情请参考MySQL官方手册</a></p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">隐式转换估计是很多 MySQL 使用者踩过的坑，比如联系方式字段。由于有时电话号码带加、减等特殊字符，有时需要以 0 开头，因此一般设计表时会使用 varchar 类型存储，并且会经常做为条件来查询数据，所以会添加索引。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">而有时遇到需要按照手机号码条件（比如 11111111111）去查询数据时，因为查询者看到条件是一串数字，而忽视表中对应手机号字段是 varchar 类型，因此写出了如下不合理的SQL：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> user_name<span class="token punctuation">,</span>tele_phone <span class="token keyword">from</span> user_info <span class="token keyword">where</span> tele_phone <span class="token operator">=</span><span class="token number">11111111111</span><span class="token punctuation">;</span> <span class="token comment">/* SQL 1 */</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">实际情况这条 SQL 查询效率是很低的。首先根据你的经验，思考下这条 SQL 怎么优化？</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">如果暂时不确定方法，请看下面的实验。</p>
</div><div class="cl-preview-section"><h3 id="验证隐式转换是否能走索引">2.2 验证隐式转换是否能走索引</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们一起来通过实验验证一下隐式转换是否能走索引。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">实验过程分为：先创建测试表并写入数据；测试隐式转换的查询并查看执行计划；测试正常查询，再查看执行计划。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">比如我们要查询 a 字段等于 1000 的值，SQL如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> <span class="token number">a</span>    <span class="token operator">|</span> <span class="token number">b</span>    <span class="token operator">|</span> <span class="token number">c</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token operator">|</span> <span class="token number">1000</span> <span class="token operator">|</span> <span class="token number">1000</span> <span class="token operator">|</span> <span class="token number">1000</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">而这条 SQL 是否能使用索引呢？我们一起看下 explain 结果：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad74a000194a612540169.png" data-original="//img.mukewang.com/5d3ad74a000194a612540169.png" alt="图片描述">通过 type 这列可以看到是最差的情况 ALL（全表扫描，如果对 explain 结果中 type 各个值没印象的，可以查看第 2 节中&lt;表 3-type 各项值解释&gt;），  通过 key 这列可以看到没走 a 字段的索引，通过 rows 这列可以看到进行了全表扫描。</p>
</div><div class="cl-preview-section"><h3 id="不走索引的原因">2.3 不走索引的原因</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">a 字段类型是 varchar(20)，而语句中 a 字段条件值没加单引号，导致 MySQL 内部会先把a转换成int型，再去做判断，相当于实际执行的 SQL 语句如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> cast<span class="token punctuation">(</span><span class="token number">a</span> <span class="token keyword">as</span> signed <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此又回到上面说的：<strong>对索引字段做函数操作时，优化器会放弃使用索引</strong>。</p>
</div><div class="cl-preview-section"><h3 id="隐式转换的-sql-优化">2.4 隐式转换的 SQL 优化</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">索引字符串列条件添加单引号，查看执行计划：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span><span class="token operator">=</span><span class="token string">'1000'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad72e00016d6212180160.png" data-original="//img.mukewang.com/5d3ad72e00016d6212180160.png" alt="图片描述">通过 type 这列，可以看到是 ref（基于普通索引的等值查询，比 ALL 性能好很多，可复习第 2 节&lt;表3-type 各项值解释&gt;），通过key这列，可以看到已经走了 a 字段的索引，通过rows这列可以看到通过索引查询后就扫描了一行。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此在联系方式这个例子中的 sql 1 可以这样优化：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql"><span class="token keyword">select</span> user_name<span class="token punctuation">,</span>tele_phone <span class="token keyword">from</span> user_info <span class="token keyword">where</span> tele_phone <span class="token operator">=</span><span class="token string">'11111111111'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;"><strong>经验分享</strong>：</p>
<p style="font-size: 20px; line-height: 38px;">隐式转换导致查询慢的情况在工作中遇到过几次，有时字段名对开发写SQL产生了影响，比如曾经遇到过字段名是user_num，而实际字段类型是char，但是开发在写SQL时误认为是int型，导致漏写单引号而发生隐式转换。<strong>所以建议在写SQL时，先看字段类型，然后根据字段类型写SQL。</strong></p>
</blockquote>
</div><div class="cl-preview-section"><h2 id="模糊查询" style="font-size: 30px;"><strong>3 模糊查询</strong></h2>
</div><div class="cl-preview-section"><h3 id="分析模糊查询">3.1 分析模糊查询</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">很多时候我们想根据某个字段的某几个关键字查询数据，比如会有如下 SQL：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span> <span class="token operator">like</span> <span class="token string">'%1111%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> <span class="token number">a</span>    <span class="token operator">|</span> <span class="token number">b</span>    <span class="token operator">|</span> <span class="token number">c</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token operator">|</span> <span class="token number">1111</span> <span class="token operator">|</span> <span class="token number">1111</span> <span class="token operator">|</span> <span class="token number">1111</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">实际这种情况无法走索引，看下执行计划：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span> <span class="token operator">like</span> <span class="token string">'%1111%'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad71600019dcd12670163.png" data-original="//img.mukewang.com/5d3ad71600019dcd12670163.png" alt="图片描述">重点留意type、key、rows、Extra，发现是全表扫描。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">Tips：通配符在前面为什么不走索引，将在第二章索引中详细描述。</p>
</blockquote>
</div><div class="cl-preview-section"><h3 id="模糊查询优化建议">3.2 模糊查询优化建议</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">修改业务，让模糊查询必须包含条件字段前面的值，然后落到数据库的查询为：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span> <span class="token operator">like</span> <span class="token string">'1111%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> <span class="token number">a</span>    <span class="token operator">|</span> <span class="token number">b</span>    <span class="token operator">|</span> <span class="token number">c</span>                   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token operator">|</span> <span class="token number">1111</span> <span class="token operator">|</span> <span class="token number">1111</span> <span class="token operator">|</span> <span class="token number">1111</span> <span class="token operator">|</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">Tips：这个优化方式必须结合业务，如果只是这样改SQL，<strong>可能会导致查询的结果不正确</strong>。</p>
</blockquote>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这种写法是可以用到索引的，explain分析如下：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">a</span> <span class="token operator">like</span> <span class="token string">'1111%'</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad6fc0001b14e13540160.png" data-original="//img.mukewang.com/5d3ad6fc0001b14e13540160.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;"><strong>经验分享</strong>：</p>
<p style="font-size: 20px; line-height: 38px;">如果条件只知道中间的值，需要模糊查询去查，那就建议使用ElasticSearch或其它搜索服务器。</p>
</blockquote>
</div><div class="cl-preview-section"><h2 id="范围查询" style="font-size: 30px;"><strong>4 范围查询</strong></h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">也许你会在工作中因为要查询某个范围的数据而使用范围查询，但不知道有没有遇到过这种场景？明明范围查询的条件字段有索引，但是却全表扫描了。</p>
</div><div class="cl-preview-section"><h3 id="构造不能使用索引的范围查询">4.1 构造不能使用索引的范围查询</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们拿测试表举例，比如要取出b字段1到2000范围数据，SQL 如下 ：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">b</span> <span class="token operator">&lt;=</span><span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">首先看下这条 SQL 的执行计划：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">b</span> <span class="token operator">&lt;=</span><span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad6de0001322812540169.png" data-original="//img.mukewang.com/5d3ad6de0001322812540169.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">发现并不能走b字段的索引。</p>
<p style="font-size: 20px; line-height: 38px;">原因：优化器会根据检索比例、表大小、I/O块大小等进行评估是否使用索引。比如单次查询的数据量过大，优化器将不走索引。</p>
</blockquote>
</div><div class="cl-preview-section"><h3 id="优化范围查询">4.2 优化范围查询</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">降低单次查询范围，分多次查询：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">b</span> <span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">&gt;=</span><span class="token number">1001</span> <span class="token operator">and</span> <span class="token number">b</span> <span class="token operator">&lt;=</span><span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">查看执行计划（就只看第一条的，第二条同理）：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token operator">and</span> <span class="token number">b</span> <span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad6c30001da5513640167.png" data-original="//img.mukewang.com/5d3ad6c30001da5513640167.png" alt="图片描述">因此，降低查询范围后，能正常使用索引。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">经验分享：</p>
<p style="font-size: 20px; line-height: 38px;">实际这种范围查询而导致使用不了索引的场景经常出现，比如按照时间段抽取全量数据，每条SQL抽取一个月的；或者某张业务表历史数据的删除。遇到此类操作时，<strong>应该在执行之前对SQL做explain分析，确定能走索引，再进行操作</strong>，否则不但可能导致操作缓慢，在做更新或者删除时，甚至会导致表所有记录锁住，十分危险。</p>
</blockquote>
</div><div class="cl-preview-section"><h2 id="计算操作" style="font-size: 30px;">5 计算操作</h2>
</div><div class="cl-preview-section"><h3 id="查询条件进行计算操作的-sql-执行效率">5.1 查询条件进行计算操作的 SQL 执行效率</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">有时我们与有对条件字段做计算操作的需求，在使用 SQL 查询时，就应该小心了。先看下例：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad6970001e7dd12590164.png" data-original="//img.mukewang.com/5d3ad6970001e7dd12590164.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">原因：对索引字段做运算将使用不了索引。</p>
</blockquote>
</div><div class="cl-preview-section"><h3 id="计算操作的-sql-优化">5.2 计算操作的 SQL 优化</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">将计算操作放在等号后面：</p>
</div><div class="cl-preview-section"><pre class=" language-sql"><code class="prism  language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> <span class="token number">b</span> <span class="token operator">=</span><span class="token number">1000</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img.mukewang.com/5d3ad67b0001f95412160154.png" data-original="//img.mukewang.com/5d3ad67b0001f95412160154.png" alt="图片描述">发现将计算操作放在等号后，能正常使用索引。</p>
</div><div class="cl-preview-section"><blockquote>
<p style="font-size: 20px; line-height: 38px;">经验分享：</p>
<p style="font-size: 20px; line-height: 38px;"><strong>一般需要对条件字段做计算时，建议通过程序代码实现，而不是通过MySQL实现。如果在MySQL中计算的情况避免不了，那必须把计算放在等号后面。</strong></p>
</blockquote>
</div><div class="cl-preview-section"><h2 id="总结" style="font-size: 30px;">6 总结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节讲解几种条件字段有索引，但是使用不了索引的场景。因此在写 SQL 时应该注意这些点：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">应该避免隐式转换</li>
<li style="font-size: 20px; line-height: 38px;">like查询不能以%开头</li>
<li style="font-size: 20px; line-height: 38px;">范围查询时，包含的数据比例不能太大</li>
<li style="font-size: 20px; line-height: 38px;">不建议对条件字段做运算及函数操作</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节涉及到的一些SQL优化如下图：<br>
<img class="" src="https://img.mukewang.com/5d3ad63a000103ed18210809.png" data-original="//img.mukewang.com/5d3ad63a000103ed18210809.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><h2 id="问题" style="font-size: 30px;">7 问题</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">你在工作中遇到过哪些隐式转换的情况？</p>
</div><div class="cl-preview-section"><h2 id="参考资料" style="font-size: 30px;">8 参考资料</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">MySQL 5.7参考手册</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><a href="https://dev.mysql.com/doc/refman/5.7/en/type-conversion.html">https://dev.mysql.com/doc/refman/5.7/en/type-conversion.html</a></p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/43/article/683">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            03 快速学会分析SQL执行效率（下）
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/43/article/685">
                                                                    <div class="next r clearfix">
                                        <p>
                                            05 如何优化数据导入？
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>